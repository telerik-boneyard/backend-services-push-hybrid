// Mingo.js 0.4.0
// Copyright (c) 2015 Francis Asante <kofrasa@gmail.com>
// MIT
!function(a,b){"use strict";function c(a){for(var b=0;b<n.length;b++)if(n[b](a))return i.isRegExp(a)?{$regex:a}:{$eq:a};if(i.isObject(a)){var c=i.keys(a),d=0===i.intersection(D.queryOperators,c).length;if(d)return{$eq:a};if(i.contains(c,"$regex")){var e=a.$regex,f=a.$options||"",g="";i.isString(e)&&(g+=e.ignoreCase||f.indexOf("i")>=0?"i":"",g+=e.multiline||f.indexOf("m")>=0?"m":"",g+=e.global||f.indexOf("g")>=0?"g":"",e=new RegExp(e,g)),a.$regex=e,delete a.$options}}return a}function d(a,b){return i.result(a,b)}function e(a,c){if(!c)return b;for(var f,g=c.split("."),h=a,j=0;j<g.length;j++){if(f=null===g[j].match(/^\d+$/),f&&i.isArray(h)){var k=[];i.each(h,function(a){i.isObject(a)&&k.push(e(a,g[j]))}),h=k}else h=d(h,g[j]);if(h===b)break}return h}function f(a,c,d){if(i.contains(D.groupOperators,c))return v[c](a,d);if(i.isObject(d)){var e={};for(var g in d)if(d.hasOwnProperty(g)&&(e[g]=f(a,g,d[g]),i.contains(D.groupOperators,g))){if(e=e[g],i.keys(d).length>1)throw new Error("Invalid $group expression '"+JSON.stringify(d)+"'");break}return e}return b}function g(a,b,c){if(i.contains(D.aggregateOperators,c))return C[c](a,b);if(i.isString(b)&&b.length>0&&"$"===b[0])return e(a,b.slice(1));var d;if(i.isArray(b)){d=[];for(var f=0;f<b.length;f++)d.push(g(a,b[f],null))}else if(i.isObject(b)){d={};for(var h in b)if(b.hasOwnProperty(h)&&(d[h]=g(a,b[h],h),i.contains(D.aggregateOperators,h))){if(d=d[h],i.keys(b).length>1)throw new Error("Invalid aggregation expression '"+JSON.stringify(b)+"'");break}}else for(var f=0;f<n.length;f++)if(n[f](b))return b;return d}var h,i,j={};null!=a&&(h=a.Mingo),j.noConflict=function(){return a.Mingo=h,j};var k=Boolean("undefined"!=typeof android&&android&&android.widget&&android.widget.Button||"undefined"!=typeof UIButton&&UIButton),l="undefined"!=typeof exports&&"undefined"!=typeof require&&"undefined"==typeof window&&!k,m="undefined"!=typeof exports&&"undefined"!=typeof require;l||k||m?(exports="undefined"!=typeof module&&module.exports?module.exports=j:j,i=require("underscore")):(a.Mingo=j,i=a._);var n=[i.isString,i.isBoolean,i.isNumber,i.isDate,i.isNull,i.isRegExp],o={key:"_id"};if(j.setup=function(a){i.extend(o,a||{})},j.Query=function(a,b){return this instanceof j.Query?(this._criteria=a,this._projection=b,this._compiled=[],void this._compile()):new j.Query(a,b)},j.Query.prototype={_compile:function(){if(!i.isEmpty(this._criteria)){if(i.isArray(this._criteria)||i.isFunction(this._criteria)||!i.isObject(this._criteria))throw new Error("Invalid type for criteria");for(var a in this._criteria)if(this._criteria.hasOwnProperty(a)){var b=this._criteria[a];if(i.contains(["$and","$or","$nor","$where"],a))this._processOperator(a,a,b);else{b=c(b);for(var d in b)b.hasOwnProperty(d)&&this._processOperator(a,d,b[d])}}}},_processOperator:function(a,b,c){var d;if(i.contains(D.simpleOperators,b))d={test:function(d){var f=e(d,a);return t[b](f,c)}};else{if(!i.contains(D.compoundOperators,b))throw new Error("Invalid query operator '"+b+"' detected");d=s[b](a,c)}this._compiled.push(d)},test:function(a){for(var b=0;b<this._compiled.length;b++)if(!this._compiled[b].test(a))return!1;return!0},find:function(a,b){return new j.Cursor(a,this,b)},remove:function(a){for(var b=[],c=0;c<a.length;c++)this.test(a[c])||b.push(a[c]);return b}},l){var p=require("stream").Transform,q=require("util");j.Query.prototype.stream=function(a){return new j.Stream(this,a)},j.Stream=function(a,b){return this instanceof j.Stream?(b=b||{},i.extend(b,{objectMode:!0}),p.call(this,b),void(this._query=a)):new j.Stream(a,b)},q.inherits(j.Stream,p),j.Stream.prototype._transform=function(a,b,c){if(i.isObject(a)&&this._query.test(a))if(i.isEmpty(this._query._projection))this.push(a);else{var d=new j.Cursor([a],this._query);d.hasNext()&&this.push(d.next())}c()}}j.Cursor=function(a,b,c){return this instanceof j.Cursor?(this._query=b,this._collection=a,this._projection=c||b._projection,this._operators={},this._result=!1,void(this._position=0)):new j.Cursor(a,b,c)},j.Cursor.prototype={_fetch:function(){var a=this;if(this._result!==!1)return this._result;if(i.isObject(this._projection)&&i.extend(this._operators,{$project:this._projection}),!i.isArray(this._collection)&&!i.isObject(this._collection))throw new Error("Input collection is not of valid type. Must be an Array.");this._result=i.filter(this._collection,this._query.test,this._query);var b=[];if(i.each(["$sort","$skip","$limit","$project"],function(c){i.has(a._operators,c)&&b.push(i.pick(a._operators,c))}),b.length>0){var c=new j.Aggregator(b);this._result=c.run(this._result,this._query)}return this._result},all:function(){return this._fetch()},first:function(){return this.count()>0?this._fetch()[0]:null},last:function(){return this.count()>0?this._fetch()[this.count()-1]:null},count:function(){return this._fetch().length},skip:function(a){return i.extend(this._operators,{$skip:a}),this},limit:function(a){return i.extend(this._operators,{$limit:a}),this},sort:function(a){return i.extend(this._operators,{$sort:a}),this},next:function(){return this.hasNext()?this._fetch()[this._position++]:null},hasNext:function(){return this.count()>this._position},max:function(a){return v.$max(this._fetch(),a)},min:function(a){return v.$min(this._fetch(),a)},map:function(a){return i.map(this._fetch(),a)},forEach:function(a){i.each(this._fetch(),a)}},j.Aggregator=function(a){return this instanceof j.Aggregator?void(this._operators=a):new j.Aggregator(a)},j.Aggregator.prototype={run:function(a,b){if(!i.isEmpty(this._operators))for(var c=0;c<this._operators.length;c++){var d=this._operators[c];for(var e in d)d.hasOwnProperty(e)&&(a=b instanceof j.Query?r[e].call(b,a,d[e]):r[e](a,d[e]))}return a}},j.find=function(a,b,c){return new j.Query(b).find(a,c)},j.remove=function(a,b){return new j.Query(b).remove(a)},j.aggregate=function(a,b){if(!i.isArray(b))throw new Error("Aggregation pipeline must be an array");return new j.Aggregator(b).run(a)},j.CollectionMixin={query:function(a,b){return j.find(this.toJSON(),a,b)},aggregate:function(a){var b=[this.toJSON(),a];return j.aggregate.apply(null,b)}};var r={$group:function(a,b){var c=b[o.key],d=[],e=i.groupBy(a,function(a){var b=g(a,c,c);return d.push(b),b});d=i.uniq(d),b=i.omit(b,o.key);var h=[];return i.each(d,function(a){var c={};c[o.key]=a;for(var d in b)b.hasOwnProperty(d)&&(c[d]=f(e[a],d,b[d]));h.push(c)}),h},$match:function(a,b){return new j.Query(b).find(a).all()},$project:function(a,c){if(i.isEmpty(c))return a;var d=[],e=i.keys(c),f=!1;if(i.contains(e,o.key)){var h=c[o.key];(0===h||h===!1)&&(e=i.without(e,o.key),i.isEmpty(e)&&(f=!0))}else e.push(o.key);for(var j=0;j<a.length;j++){var k=a[j],l={},m=!1,n=!1,p=[];f&&p.push(o.key),i.each(e,function(a){var d,e=c[a];if(a!==o.key&&0===e&&(n=!0),a===o.key&&i.isEmpty(e))d=k[a];else if(i.isString(e))d=g(k,e,a);else if(1===e||e===!0)d=i.result(k,a);else if(i.isObject(e)){var f=i.keys(e);if(f=f.length>1?!1:f[0],f!==!1&&i.contains(D.projectionOperators,f)){var h=u[f](k,e[f],a);i.isUndefined(h)||(d=h),"$slice"==f&&(m=!0)}else d=g(k,e,a)}else p.push(a);d!==b&&(l[a]=i.isObject(d)?i.clone(d):d)}),(m||n||f)&&(l=i.defaults(l,i.omit(k,p))),d.push(l)}return d},$limit:function(a,b){return i.first(a,b)},$skip:function(a,b){return i.rest(a,b)},$unwind:function(a,b){for(var c=[],e=b.substr(1),f=0;f<a.length;f++){var g=a[f],h=d(g,e);if(!i.isArray(h))throw new Error("Target field '"+e+"' is not of type Array.");i.each(h,function(a){var b=i.clone(g);b[e]=a,c.push(b)})}return c},$sort:function(a,b){if(!i.isEmpty(b)&&i.isObject(b)){var c=i.keys(b);c.reverse().forEach(function(c){var d=[],f=i.groupBy(a,function(a){var b=e(a,c);return d.push(b),b});d=i.sortBy(i.uniq(d),function(a){return a}),-1===b[c]&&d.reverse(),a=[],i.each(d,function(b){Array.prototype.push.apply(a,f[b])})})}return a}},s={$and:function(a,b){if(!i.isArray(b))throw new Error("Invalid expression for $and criteria");var c=[];return i.each(b,function(a){c.push(new j.Query(a))}),{test:function(a){for(var b=0;b<c.length;b++)if(!c[b].test(a))return!1;return!0}}},$or:function(a,b){if(!i.isArray(b))throw new Error("Invalid expression for $or criteria");var c=[];return i.each(b,function(a){c.push(new j.Query(a))}),{test:function(a){for(var b=0;b<c.length;b++)if(c[b].test(a))return!0;return!1}}},$nor:function(a,b){if(!i.isArray(b))throw new Error("Invalid expression for $nor criteria");var c=this.$or("$or",b);return{test:function(a){return!c.test(a)}}},$not:function(a,b){var d={};d[a]=c(b);var e=new j.Query(d);return{test:function(a){return!e.test(a)}}},$where:function(a,b){return i.isFunction(b)||(b=new Function("return "+b+";")),{test:function(a){return b.call(a)===!0}}}},t={$eq:function(a,c){return a=i.isArray(a)?a:[a],a=i.find(a,function(a){return i.isEqual(a,c)}),a!==b},$ne:function(a,b){return!this.$eq(a,b)},$in:function(a,b){return a=i.isArray(a)?a:[a],i.intersection(a,b).length>0},$nin:function(a,b){return i.isUndefined(a)||!this.$in(a,b)},$lt:function(a,c){return a=i.isArray(a)?a:[a],a=i.find(a,function(a){return c>a}),a!==b},$lte:function(a,c){return a=i.isArray(a)?a:[a],a=i.find(a,function(a){return c>=a}),a!==b},$gt:function(a,c){return a=i.isArray(a)?a:[a],a=i.find(a,function(a){return a>c}),a!==b},$gte:function(a,c){return a=i.isArray(a)?a:[a],a=i.find(a,function(a){return a>=c}),a!==b},$mod:function(a,c){return a=i.isArray(a)?a:[a],a=i.find(a,function(a){return i.isNumber(a)&&i.isArray(c)&&2===c.length&&a%c[0]===c[1]}),a!==b},$regex:function(a,c){return a=i.isArray(a)?a:[a],a=i.find(a,function(a){return i.isString(a)&&i.isRegExp(c)&&!!a.match(c)}),a!==b},$exists:function(a,b){return b===!1&&i.isUndefined(a)||b===!0&&!i.isUndefined(a)},$all:function(a,b){var c=this,d=!1;if(i.isArray(a)&&i.isArray(b))for(var e=0;e<b.length;e++){if(!i.isObject(b[e])||!i.contains(i.keys(b[e]),"$elemMatch"))return i.intersection(b,a).length===b.length;d=d||c.$elemMatch(a,b[e].$elemMatch)}return d},$size:function(a,b){return i.isArray(a)&&i.isNumber(b)&&a.length===b},$elemMatch:function(a,b){if(i.isArray(a)&&!i.isEmpty(a))for(var c=new j.Query(b),d=0;d<a.length;d++)if(c.test(a[d]))return!0;return!1},$type:function(a,b){switch(b){case 1:return i.isNumeric(a)&&-1!==(a+"").indexOf(".");case 2:case 5:return i.isString(a);case 3:return i.isObject(a);case 4:return i.isArray(a);case 8:return i.isBoolean(a);case 9:return i.isDate(a);case 10:return i.isNull(a);case 11:return i.isRegExp(a);case 16:return i.isNumeric(a)&&2147483647>=a&&-1===(a+"").indexOf(".");case 18:return i.isNumeric(a)&&a>2147483647&&0x8000000000000000>=a&&-1===(a+"").indexOf(".");default:return!1}}},u={$:function(){throw new Error("$ not implemented")},$elemMatch:function(a,c,d){var f=e(a,d),g=new j.Query(c);if(i.isUndefined(f)||!i.isArray(f))return b;for(var h=0;h<f.length;h++)if(g.test(f[h]))return[f[h]];return b},$slice:function(a,b,c){var d=e(a,c);if(!i.isArray(d))return d;if(i.isArray(b)){var f=b[0]<0?d.length+b[0]:b,g=f+b[1];b=[f,g]}else{if(!i.isNumber(b))throw new Error("Invalid type for $slice operator");b=0>b?[b]:[0,b]}return Array.prototype.slice.apply(d,b)}},v={$addToSet:function(a,b){var c=i.map(a,function(a){return g(a,b)});return i.uniq(c)},$sum:function(a,b){return i.isNumber(b)?a.length*b:i.reduce(a,function(a,c){return a+g(c,b)},0)},$max:function(a,b){var c=i.max(a,function(a){return g(a,b)});return g(c,b)},$min:function(a,b){var c=i.min(a,function(a){return g(a,b)});return g(c,b)},$avg:function(a,b){return this.$sum(a,b)/(a.length||1)},$push:function(a,b){return i.map(a,function(a){return g(a,b)})},$first:function(a,c){return a.length>0?g(a[0],c):b},$last:function(a,c){return a.length>0?g(a[a.length-1],c):b}},w={$add:function(a,b){var c=g(a,b);return i.reduce(c,function(a,b){return a+b},0)},$subtract:function(a,b){var c=g(a,b);return c[0]-c[1]},$divide:function(a,b){var c=g(a,b);return c[0]/c[1]},$multiply:function(a,b){var c=g(a,b);return i.reduce(c,function(a,b){return a*b},1)},$mod:function(a,b){var c=g(a,b);return c[0]%c[1]}},x={$concat:function(a,c){var d=g(a,c);return i.contains(d,null)||i.contains(d,b)?null:d.join("")},$strcasecmp:function(a,b){var c=g(a,b);return c[0]=i.isEmpty(c[0])?"":c[0].toUpperCase(),c[1]=i.isEmpty(c[1])?"":c[1].toUpperCase(),c[0]>c[1]?1:c[0]<c[1]?-1:0},$substr:function(a,b){var c=g(a,b);return i.isString(c[0])?c[1]<0?"":c[2]<0?c[0].substr(c[1]):c[0].substr(c[1],c[2]):""},$toLower:function(a,b){var c=g(a,b);return i.isEmpty(c)?"":c.toLowerCase()},$toUpper:function(a,b){var c=g(a,b);return i.isEmpty(c)?"":c.toUpperCase()}},y={$dayOfYear:function(a,c){var d=g(a,c);if(i.isDate(value)){var e=new Date(d.getFullYear(),0,0),f=d-e,h=864e5;return Math.round(f/h)}return b},$dayOfMonth:function(a,c){var d=g(a,c);return i.isDate(d)?d.getDate():b},$dayOfWeek:function(a,c){var d=g(a,c);return i.isDate(d)?d.getDay()+1:b},$year:function(a,c){var d=g(a,c);return i.isDate(d)?d.getFullYear()+1:b},$month:function(a,c){var d=g(a,c);return i.isDate(d)?d.getMonth()+1:b},$week:function(a,b){g(a,b);throw new Error("Not Implemented")},$hour:function(a,c){var d=g(a,c);return i.isDate(d)?d.getHours():b},$minute:function(a,c){var d=g(a,c);return i.isDate(d)?d.getMinutes():b},$second:function(a,c){var d=g(a,c);return i.isDate(d)?d.getSeconds():b},$millisecond:function(a,c){var d=g(a,c);return i.isDate(d)?d.getMilliseconds():b},$dateToString:function(a,b){b.format,g(a,b.date);throw new Error("Not Implemented")}},z={$setEquals:function(a,b){var c=g(a,b),d=i.uniq(c[0]),e=i.uniq(c[1]);return d.length!==e.length?!1:0==i.difference(d,e).length},$setIntersection:function(a,b){var c=g(a,b);return i.intersection(c[0],c[1])},$setDifference:function(a,b){var c=g(a,b);return i.difference(c[0],c[1])},$setUnion:function(a,b){var c=g(a,b);return i.union(c[0],c[1])},$setIsSubset:function(a,b){var c=g(a,b);return i.intersection(c[0],c[1]).length===c[0].length},$anyElementTrue:function(a,b){for(var c=g(a,b)[0],d=0;d<c.length;d++)if(c[d])return!0;return!1},$allElementsTrue:function(a,b){for(var c=g(a,b)[0],d=0;d<c.length;d++)if(!c[d])return!1;return!0}},A={$cond:function(a,b){var c,d,e;if(i.isArray(b)){if(3!=b.length)throw new Error("Invalid arguments for $cond operator");c=b[0],d=b[1],e=b[2]}else i.isObject(b)&&(c=b["if"],d=b.then,e=b["else"]);var f=g(a,c);return f?g(a,d):g(a,e)},$ifNull:function(a,c){if(!i.isArray(c)||2!=c.length)throw new Error("Invalid arguments for $ifNull operator");var d=g(a,c);return null===d[0]||d[0]===b?d[1]:d[0]}},B={$cmp:function(a,b){var c=g(a,b);return c[0]>c[1]?1:c[0]<c[1]?-1:0}},C=i.extend({},w,B,A,y,z,x);i.each(["$eq","$ne","$gt","$gte","$lt","$lte"],function(a){C[a]=function(b,c){var d=g(b,c);return t[a](d[0],d[1])}});var D={simpleOperators:i.keys(t),compoundOperators:i.keys(s),aggregateOperators:i.keys(C),groupOperators:i.keys(v),pipelineOperators:i.keys(r),projectionOperators:i.keys(u)};D.queryOperators=i.union(D.simpleOperators,D.compoundOperators)}(this);