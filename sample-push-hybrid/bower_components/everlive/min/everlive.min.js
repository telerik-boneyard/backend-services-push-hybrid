"undefined"!=typeof define&&define.amd&&define(function(){return Everlive}),function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(){},{}],2:[function(a,b){
// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
function c(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function d(a){return"function"==typeof a}function e(a){return"number"==typeof a}function f(a){return"object"==typeof a&&null!==a}function g(a){return void 0===a}b.exports=c,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._maxListeners=void 0,c.defaultMaxListeners=10,c.prototype.setMaxListeners=function(a){if(!e(a)||0>a||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},c.prototype.emit=function(a){var b,c,e,h,i,j;if(this._events||(this._events={}),"error"===a&&(!this._events.error||f(this._events.error)&&!this._events.error.length)){if(b=arguments[1],b instanceof Error)throw b;throw TypeError('Uncaught, unspecified "error" event.')}if(c=this._events[a],g(c))return!1;if(d(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];c.apply(this,h)}else if(f(c)){for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];for(j=c.slice(),e=j.length,i=0;e>i;i++)j[i].apply(this,h)}return!0},c.prototype.addListener=function(a,b){var e;if(!d(b))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,d(b.listener)?b.listener:b),this._events[a]?f(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,f(this._events[a])&&!this._events[a].warned){var e;e=g(this._maxListeners)?c.defaultMaxListeners:this._maxListeners,e&&e>0&&this._events[a].length>e&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),"function"==typeof console.trace&&console.trace())}return this},c.prototype.on=c.prototype.addListener,c.prototype.once=function(a,b){function c(){this.removeListener(a,c),e||(e=!0,b.apply(this,arguments))}if(!d(b))throw TypeError("listener must be a function");var e=!1;return c.listener=b,this.on(a,c),this},c.prototype.removeListener=function(a,b){var c,e,g,h;if(!d(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(c=this._events[a],g=c.length,e=-1,c===b||d(c.listener)&&c.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(f(c)){for(h=g;h-->0;)if(c[h]===b||c[h].listener&&c[h].listener===b){e=h;break}if(0>e)return this;1===c.length?(c.length=0,delete this._events[a]):c.splice(e,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},c.prototype.removeAllListeners=function(a){var b,c;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[a]&&delete this._events[a],this;if(0===arguments.length){for(b in this._events)"removeListener"!==b&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events={},this}if(c=this._events[a],d(c))this.removeListener(a,c);else for(;c.length;)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},c.prototype.listeners=function(a){var b;return b=this._events&&this._events[a]?d(this._events[a])?[this._events[a]]:this._events[a].slice():[]},c.listenerCount=function(a,b){var c;return c=a._events&&a._events[b]?d(a._events[b])?1:a._events[b].length:0}},{}],3:[function(a,b){b.exports="function"==typeof Object.create?function(a,b){a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})}:function(a,b){a.super_=b;var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a}},{}],4:[function(a,b){function c(){if(!g){g=!0;for(var a,b=f.length;b;){a=f,f=[];for(var c=-1;++c<b;)a[c]();b=f.length}g=!1}}function d(){}var e=b.exports={},f=[],g=!1;e.nextTick=function(a){f.push(a),g||setTimeout(c,0)},e.title="browser",e.browser=!0,e.env={},e.argv=[],e.version="",e.versions={},e.on=d,e.addListener=d,e.once=d,e.off=d,e.removeListener=d,e.removeAllListeners=d,e.emit=d,e.binding=function(){throw new Error("process.binding is not supported")},e.cwd=function(){return"/"},e.chdir=function(){throw new Error("process.chdir is not supported")},e.umask=function(){return 0}},{}],5:[function(a,b){b.exports=function(a){return a&&"object"==typeof a&&"function"==typeof a.copy&&"function"==typeof a.fill&&"function"==typeof a.readUInt8}},{}],6:[function(a,b,c){(function(b,d){function e(a,b){var d={seen:[],stylize:g};return arguments.length>=3&&(d.depth=arguments[2]),arguments.length>=4&&(d.colors=arguments[3]),p(b)?d.showHidden=b:b&&c._extend(d,b),v(d.showHidden)&&(d.showHidden=!1),v(d.depth)&&(d.depth=2),v(d.colors)&&(d.colors=!1),v(d.customInspect)&&(d.customInspect=!0),d.colors&&(d.stylize=f),i(d,a,d.depth)}function f(a,b){var c=e.styles[b];return c?"["+e.colors[c][0]+"m"+a+"["+e.colors[c][1]+"m":a}function g(a){return a}function h(a){var b={};return a.forEach(function(a){b[a]=!0}),b}function i(a,b,d){if(a.customInspect&&b&&A(b.inspect)&&b.inspect!==c.inspect&&(!b.constructor||b.constructor.prototype!==b)){var e=b.inspect(d,a);return t(e)||(e=i(a,e,d)),e}var f=j(a,b);if(f)return f;var g=Object.keys(b),p=h(g);if(a.showHidden&&(g=Object.getOwnPropertyNames(b)),z(b)&&(g.indexOf("message")>=0||g.indexOf("description")>=0))return k(b);if(0===g.length){if(A(b)){var q=b.name?": "+b.name:"";return a.stylize("[Function"+q+"]","special")}if(w(b))return a.stylize(RegExp.prototype.toString.call(b),"regexp");if(y(b))return a.stylize(Date.prototype.toString.call(b),"date");if(z(b))return k(b)}var r="",s=!1,u=["{","}"];if(o(b)&&(s=!0,u=["[","]"]),A(b)){var v=b.name?": "+b.name:"";r=" [Function"+v+"]"}if(w(b)&&(r=" "+RegExp.prototype.toString.call(b)),y(b)&&(r=" "+Date.prototype.toUTCString.call(b)),z(b)&&(r=" "+k(b)),0===g.length&&(!s||0==b.length))return u[0]+r+u[1];if(0>d)return w(b)?a.stylize(RegExp.prototype.toString.call(b),"regexp"):a.stylize("[Object]","special");a.seen.push(b);var x;return x=s?l(a,b,d,p,g):g.map(function(c){return m(a,b,d,p,c,s)}),a.seen.pop(),n(x,r,u)}function j(a,b){if(v(b))return a.stylize("undefined","undefined");if(t(b)){var c="'"+JSON.stringify(b).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return a.stylize(c,"string")}return s(b)?a.stylize(""+b,"number"):p(b)?a.stylize(""+b,"boolean"):q(b)?a.stylize("null","null"):void 0}function k(a){return"["+Error.prototype.toString.call(a)+"]"}function l(a,b,c,d,e){for(var f=[],g=0,h=b.length;h>g;++g)f.push(F(b,String(g))?m(a,b,c,d,String(g),!0):"");return e.forEach(function(e){e.match(/^\d+$/)||f.push(m(a,b,c,d,e,!0))}),f}function m(a,b,c,d,e,f){var g,h,j;if(j=Object.getOwnPropertyDescriptor(b,e)||{value:b[e]},j.get?h=j.set?a.stylize("[Getter/Setter]","special"):a.stylize("[Getter]","special"):j.set&&(h=a.stylize("[Setter]","special")),F(d,e)||(g="["+e+"]"),h||(a.seen.indexOf(j.value)<0?(h=q(c)?i(a,j.value,null):i(a,j.value,c-1),h.indexOf("\n")>-1&&(h=f?h.split("\n").map(function(a){return"  "+a}).join("\n").substr(2):"\n"+h.split("\n").map(function(a){return"   "+a}).join("\n"))):h=a.stylize("[Circular]","special")),v(g)){if(f&&e.match(/^\d+$/))return h;g=JSON.stringify(""+e),g.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(g=g.substr(1,g.length-2),g=a.stylize(g,"name")):(g=g.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),g=a.stylize(g,"string"))}return g+": "+h}function n(a,b,c){var d=0,e=a.reduce(function(a,b){return d++,b.indexOf("\n")>=0&&d++,a+b.replace(/\u001b\[\d\d?m/g,"").length+1},0);return e>60?c[0]+(""===b?"":b+"\n ")+" "+a.join(",\n  ")+" "+c[1]:c[0]+b+" "+a.join(", ")+" "+c[1]}function o(a){return Array.isArray(a)}function p(a){return"boolean"==typeof a}function q(a){return null===a}function r(a){return null==a}function s(a){return"number"==typeof a}function t(a){return"string"==typeof a}function u(a){return"symbol"==typeof a}function v(a){return void 0===a}function w(a){return x(a)&&"[object RegExp]"===C(a)}function x(a){return"object"==typeof a&&null!==a}function y(a){return x(a)&&"[object Date]"===C(a)}function z(a){return x(a)&&("[object Error]"===C(a)||a instanceof Error)}function A(a){return"function"==typeof a}function B(a){return null===a||"boolean"==typeof a||"number"==typeof a||"string"==typeof a||"symbol"==typeof a||"undefined"==typeof a}function C(a){return Object.prototype.toString.call(a)}function D(a){return 10>a?"0"+a.toString(10):a.toString(10)}function E(){var a=new Date,b=[D(a.getHours()),D(a.getMinutes()),D(a.getSeconds())].join(":");return[a.getDate(),J[a.getMonth()],b].join(" ")}function F(a,b){return Object.prototype.hasOwnProperty.call(a,b)}
// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
var G=/%[sdj%]/g;c.format=function(a){if(!t(a)){for(var b=[],c=0;c<arguments.length;c++)b.push(e(arguments[c]));return b.join(" ")}for(var c=1,d=arguments,f=d.length,g=String(a).replace(G,function(a){if("%%"===a)return"%";if(c>=f)return a;switch(a){case"%s":return String(d[c++]);case"%d":return Number(d[c++]);case"%j":try{return JSON.stringify(d[c++])}catch(b){return"[Circular]"}default:return a}}),h=d[c];f>c;h=d[++c])g+=q(h)||!x(h)?" "+h:" "+e(h);return g},c.deprecate=function(a,e){function f(){if(!g){if(b.throwDeprecation)throw new Error(e);b.traceDeprecation?console.trace(e):console.error(e),g=!0}return a.apply(this,arguments)}if(v(d.process))return function(){return c.deprecate(a,e).apply(this,arguments)};if(b.noDeprecation===!0)return a;var g=!1;return f};var H,I={};c.debuglog=function(a){if(v(H)&&(H=b.env.NODE_DEBUG||""),a=a.toUpperCase(),!I[a])if(new RegExp("\\b"+a+"\\b","i").test(H)){var d=b.pid;I[a]=function(){var b=c.format.apply(c,arguments);console.error("%s %d: %s",a,d,b)}}else I[a]=function(){};return I[a]},c.inspect=e,e.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},e.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"},c.isArray=o,c.isBoolean=p,c.isNull=q,c.isNullOrUndefined=r,c.isNumber=s,c.isString=t,c.isSymbol=u,c.isUndefined=v,c.isRegExp=w,c.isObject=x,c.isDate=y,c.isError=z,c.isFunction=A,c.isPrimitive=B,c.isBuffer=a("./support/isBuffer");var J=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];c.log=function(){console.log("%s - %s",E(),c.format.apply(c,arguments))},c.inherits=a("inherits"),c._extend=function(a,b){if(!b||!x(b))return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a}}).call(this,a("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":5,_process:4,inherits:3}],7:[function(a,b,c){function d(a,b){a=a||{};var c={};for(var f in b)if(b.hasOwnProperty(f)){var g,i,k=b[f],l=f.split("."),m=a,n=[];a:for(var o=0;o<l.length;o++)switch(m=m[l[o]],h(m)){case"array":if(g=l.slice(0,o+1).join("."),i=l.slice(o+1).join("."),j('searching array "%s"',g),k.$size&&!i.length)return e(k,m);for(var p=c[g]||m,q=0;q<p.length;q++)if(i.length){var r={};r[i]=k,"object"==h(p[q])&&(j("attempting subdoc search with query %j",r),d(p[q],r)&&(c[g]&&~c[g].indexOf(p[q])||n.push(p[q])))}else j("performing simple array item search"),e(k,p[q])&&(c[g]&&~c[g].indexOf(p[q])||n.push(p[q]));n.length&&(c[g]=c[g]||[],c[g].push.apply(c[g],n));break a;case"undefined":return!1;case"object":if(null!=l[o+1])continue;if(!e(k,m))return!1;break;default:if(!e(k,m))return!1}}return c}function e(a,b){if("object"!=h(a))return g(a,b);var c=i.keys(a);if("$"==c[0][0]){for(var e=0;e<c.length;e++){if("$elemMatch"==c[e])return!1!==d(b,a.$elemMatch);if(!f[c[e]](a[c[e]],b))return!1}return!0}return g(a,b)}var f=a("./ops"),g=a("mongo-eql"),h=(a("dot-component"),a("component-type")),i=a("object-component"),j=a("debug")("mongo-query");b.exports=c=d,c.ops=f},{"./ops":18,"component-type":10,debug:11,"dot-component":14,"mongo-eql":16,"object-component":17}],8:[function(a,b,c){function d(a,b,c,d){a=a||{},d=d||{},b=b||{},c=c||{};var j,k=!!d.strict,l=[];if(h.length(b)&&(j=f(a,b)),k&&!1===j)i("no matches for query %j",b);else{for(var m=h.keys(c),n=[],o=0,p=m.length;p>o;o++)if(e[m[o]]){i('found modifier "%s"',m[o]);for(var q in c[m[o]]){var r=q.indexOf(".$.");if(~r){var s=q.substr(0,r),t=q.substr(r+3);if(j[s]){i('executing "%s" %s on first match within "%s"',q,m[o],s);var u=e[m[o]](j[s][0],t,c[m[o]][q]);if(u){var v=g.get(a,s).indexOf(j[s][0]);u.key=s+"."+v+"."+t,u.op=m[o],n.push(u)}}else i('ignoring "%s" %s - no matches within "%s"',q,m[o],s)}else{var u=e[m[o]](a,q,c[m[o]][q]);u&&(u.key=q,u.op=m[o],n.push(u))}}}else i('skipping unknown modifier "%s"',m[o]);if(n.length)for(var o=0;o<n.length;o++){var u=n[o],w=u();l.push({op:u.op,key:u.key,value:w})}}return l}var e=a("./mods"),f=a("./filter"),g=a("dot-component"),h=(a("component-type"),a("object-component")),i=a("debug")("mongo-query");b.exports=c=d,c.filter=f,c.mods=e},{"./filter":7,"./mods":9,"component-type":10,debug:11,"dot-component":14,"object-component":17}],9:[function(a,b,c){function d(a,b){for(var c=0,d=a.length;d>c;c++)if(g(b,a[c]))return!0;return!1}function e(a,b,c){for(var d=[],e=0;e<a.length;e++)for(var f=a[e],h=0;h<b.length;h++){var l=b[h];if("object"==i(l))if("object"==i(f)){var m=!1;if(j(l).length){for(var h in l)if(l.hasOwnProperty(h)){if(!g(l[h],f[h])){m=!1;break}m=!0}}else j(f).length||(m=!0);if(m){d.push(e),c.push(f);continue}}else k("ignoring pull match against object");else if(g(l,f)){d.push(e),c.push(f);continue}}return function(){for(var b=0;b<d.length;b++){var c=d[b];a.splice(c-b,1)}}}function f(a){return"number"==i(a)||Number(a)==a}var g=a("mongo-eql"),h=a("dot-component"),i=a("component-type"),j=a("object-component").keys,k=a("debug")("mongo-query");c.$set=function(a,b,c){var d=b.split(".").pop();switch(a=h.parent(a,b,!0),i(a)){case"object":if(!g(a[d],c))return function(){return a[d]=c,c};break;case"array":if(!f(d))throw new Error("can't append to array using string field name ["+d+"]");if(!g(a[d],c))return function(){return a[d]=c,c};break;default:throw new Error("$set only supports object not "+i(a))}},c.$unset=function(a,b){var c=b.split(".").pop();switch(a=h.parent(a,b),i(a)){case"array":case"object":if(a.hasOwnProperty(c))return function(){delete a[c]};k("ignoring unset of inexisting key")}},c.$rename=function(a,b,c){if(b==c)throw new Error("$rename source must differ from target");if(0===b.indexOf(c+"."))throw new Error("$rename target may not be a parent of source");var d=h.parent(a,b),e=i(d);if("object"==e){var f=b.split(".").pop();if(d.hasOwnProperty(f))return function(){var b=d[f];delete d[f];var e=h.parent(a,c,!0);return"object"==i(e)?e[c.split(".").pop()]=b:k("invalid $rename target path type"),c};k("ignoring rename from inexisting source")}else if("undefined"!=e)throw new Error("$rename source field invalid")},c.$inc=function(a,b,c){if("number"!=i(c))throw new Error("Modifier $inc allowed for numbers only");a=h.parent(a,b,!0);var d=b.split(".").pop();switch(i(a)){case"array":case"object":if(a.hasOwnProperty(d)){if("number"!=i(a[d]))throw new Error("Cannot apply $inc modifier to non-number");return function(){return a[d]+=c,c}}if("object"==i(a)||f(d))return function(){return a[d]=c,c};throw new Error("can't append to array using string field name ["+d+"]");default:throw new Error("Cannot apply $inc modifier to non-number")}},c.$pop=function(a,b,c){a=h.parent(a,b);var d=b.split(".").pop();switch(i(a)){case"array":case"object":if(a.hasOwnProperty(d))switch(i(a[d])){case"array":if(a[d].length)return function(){return-1==c?a[d].shift():a[d].pop()};break;case"undefined":k("ignoring pop to inexisting key");break;default:throw new Error("Cannot apply $pop modifier to non-array")}else k("ignoring pop to inexisting key");break;case"undefined":k("ignoring pop to inexisting key")}},c.$push=function(a,b,c){a=h.parent(a,b,!0);var d=b.split(".").pop();switch(i(a)){case"object":if(a.hasOwnProperty(d)){if("array"==i(a[d]))return function(){return a[d].push(c),c};throw new Error("Cannot apply $push/$pushAll modifier to non-array")}return function(){return a[d]=[c],c};case"array":if(a.hasOwnProperty(d)){if("array"==i(a[d]))return function(){return a[d].push(c),c};throw new Error("Cannot apply $push/$pushAll modifier to non-array")}if(f(d))return function(){return a[d]=[c],c};throw new Error("can't append to array using string field name ["+d+"]")}},c.$pushAll=function(a,b,c){if("array"!=i(c))throw new Error("Modifier $pushAll/pullAll allowed for arrays only");a=h.parent(a,b,!0);var d=b.split(".").pop();switch(i(a)){case"object":if(a.hasOwnProperty(d)){if("array"==i(a[d]))return function(){return a[d].push.apply(a[d],c),c};throw new Error("Cannot apply $push/$pushAll modifier to non-array")}return function(){return a[d]=c,c};case"array":if(a.hasOwnProperty(d)){if("array"==i(a[d]))return function(){return a[d].push.apply(a[d],c),c};throw new Error("Cannot apply $push/$pushAll modifier to non-array")}if(f(d))return function(){return a[d]=c,c};throw new Error("can't append to array using string field name ["+d+"]")}},c.$pull=function(a,b,c){a=h.parent(a,b,!0);var d=b.split(".").pop(),f=i(a);switch(f){case"object":if(a.hasOwnProperty(d)){if("array"!=i(a[d]))throw new Error("Cannot apply $pull/$pullAll modifier to non-array");var g=[],j=e(a[d],[c],g);if(g.length)return function(){return j(),g}}break;case"array":if(a.hasOwnProperty(d)){if("array"!=i(a[d]))throw new Error("Cannot apply $pull/$pullAll modifier to non-array");var g=[],j=e(a[d],[c],g);if(g.length)return function(){return j(),g}}else k("ignoring pull to non array");break;default:if("undefined"!=f)throw new Error("LEFT_SUBFIELD only supports Object: hello not: "+f)}},c.$pullAll=function(a,b,c){if("array"!=i(c))throw new Error("Modifier $pushAll/pullAll allowed for arrays only");a=h.parent(a,b,!0);var d=b.split(".").pop(),f=i(a);switch(f){case"object":if(a.hasOwnProperty(d)){if("array"!=i(a[d]))throw new Error("Cannot apply $pull/$pullAll modifier to non-array");var g=[],j=e(a[d],c,g);if(g.length)return function(){return j(),g}}break;case"array":if(a.hasOwnProperty(d)){if("array"!=i(a[d]))throw new Error("Cannot apply $pull/$pullAll modifier to non-array");var g=[],j=e(a[d],c,g);if(g.length)return function(){return j(),g}}else k("ignoring pull to non array");break;default:if("undefined"!=f)throw new Error("LEFT_SUBFIELD only supports Object: hello not: "+f)}},c.$addToSet=function l(a,b,c,e){if(!e&&"array"==i(c.$each)){for(var g=[],j=0,k=c.$each.length;k>j;j++){var m=l(a,b,c.$each[j],!0);m&&g.push(m)}return g.length?function(){for(var a=[],b=0;b<g.length;b++)a.push(g[b]());return a}:void 0}a=h.parent(a,b,!0);var n=b.split(".").pop();switch(i(a)){case"object":if(!a.hasOwnProperty(n))return function(){return a[n]=[c],c};if("array"!=i(a[n]))throw new Error("Cannot apply $addToSet modifier to non-array");if(!d(a[n],c))return function(){return a[n].push(c),c};break;case"array":if(!a.hasOwnProperty(n)){if(f(n))return function(){return a[n]=[c],c};throw new Error("can't append to array using string field name ["+n+"]")}if("array"!=i(a[n]))throw new Error("Cannot apply $addToSet modifier to non-array");if(!d(a[n],c))return function(){return a[n].push(c),c}}}},{"component-type":10,debug:11,"dot-component":14,"mongo-eql":16,"object-component":17}],10:[function(a,b){var c=Object.prototype.toString;b.exports=function(a){switch(c.call(a)){case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array";case"[object Error]":return"error"}return null===a?"null":void 0===a?"undefined":a!==a?"nan":a&&1===a.nodeType?"element":(a=a.valueOf?a.valueOf():Object.prototype.valueOf.apply(a),typeof a)}},{}],11:[function(a,b,c){function d(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31}function e(){var a=arguments,b=this.useColors;if(a[0]=(b?"%c":"")+this.namespace+(b?" %c":" ")+a[0]+(b?"%c ":" ")+"+"+c.humanize(this.diff),!b)return a;var d="color: "+this.color;a=[a[0],d,"color: inherit"].concat(Array.prototype.slice.call(a,1));var e=0,f=0;return a[0].replace(/%[a-z%]/g,function(a){"%%"!==a&&(e++,"%c"===a&&(f=e))}),a.splice(f,0,d),a}function f(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function g(a){try{null==a?j.removeItem("debug"):j.debug=a}catch(b){}}function h(){var a;try{a=j.debug}catch(b){}return a}function i(){try{return window.localStorage}catch(a){}}c=b.exports=a("./debug"),c.log=f,c.formatArgs=e,c.save=g,c.load=h,c.useColors=d;var j;j="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:i(),c.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],c.formatters.j=function(a){return JSON.stringify(a)},c.enable(h())},{"./debug":12}],12:[function(a,b,c){function d(){return c.colors[k++%c.colors.length]}function e(a){function b(){}function e(){var a=e,b=+new Date,f=b-(j||b);a.diff=f,a.prev=j,a.curr=b,j=b,null==a.useColors&&(a.useColors=c.useColors()),null==a.color&&a.useColors&&(a.color=d());var g=Array.prototype.slice.call(arguments);g[0]=c.coerce(g[0]),"string"!=typeof g[0]&&(g=["%o"].concat(g));var h=0;g[0]=g[0].replace(/%([a-z%])/g,function(b,d){if("%%"===b)return b;h++;var e=c.formatters[d];if("function"==typeof e){var f=g[h];b=e.call(a,f),g.splice(h,1),h--}return b}),"function"==typeof c.formatArgs&&(g=c.formatArgs.apply(a,g));var i=e.log||c.log||console.log.bind(console);i.apply(a,g)}b.enabled=!1,e.enabled=!0;var f=c.enabled(a)?e:b;return f.namespace=a,f}function f(a){c.save(a);for(var b=(a||"").split(/[\s,]+/),d=b.length,e=0;d>e;e++)b[e]&&(a=b[e].replace(/\*/g,".*?"),"-"===a[0]?c.skips.push(new RegExp("^"+a.substr(1)+"$")):c.names.push(new RegExp("^"+a+"$")))}function g(){c.enable("")}function h(a){var b,d;for(b=0,d=c.skips.length;d>b;b++)if(c.skips[b].test(a))return!1;for(b=0,d=c.names.length;d>b;b++)if(c.names[b].test(a))return!0;return!1}function i(a){return a instanceof Error?a.stack||a.message:a}c=b.exports=e,c.coerce=i,c.disable=g,c.enable=f,c.enabled=h,c.humanize=a("ms"),c.names=[],c.skips=[],c.formatters={};var j,k=0},{ms:13}],13:[function(a,b){function c(a){var b=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(a);if(b){var c=parseFloat(b[1]),d=(b[2]||"ms").toLowerCase();switch(d){case"years":case"year":case"yrs":case"yr":case"y":return c*k;case"days":case"day":case"d":return c*j;case"hours":case"hour":case"hrs":case"hr":case"h":return c*i;case"minutes":case"minute":case"mins":case"min":case"m":return c*h;case"seconds":case"second":case"secs":case"sec":case"s":return c*g;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c}}}function d(a){return a>=j?Math.round(a/j)+"d":a>=i?Math.round(a/i)+"h":a>=h?Math.round(a/h)+"m":a>=g?Math.round(a/g)+"s":a+"ms"}function e(a){return f(a,j,"day")||f(a,i,"hour")||f(a,h,"minute")||f(a,g,"second")||a+" ms"}function f(a,b,c){return b>a?void 0:1.5*b>a?Math.floor(a/b)+" "+c:Math.ceil(a/b)+" "+c+"s"}var g=1e3,h=60*g,i=60*h,j=24*i,k=365.25*j;b.exports=function(a,b){return b=b||{},"string"==typeof a?c(a):b["long"]?e(a):d(a)}},{}],14:[function(a,b,c){function d(a,b,c){if(~b.indexOf(".")){for(var d=b.split("."),f=a,g=0;g<d.length-1;g++)Number(d[g])==d[g]&&"array"==e(f)?f=f[d[g]]:"object"==e(f)&&(c&&!f.hasOwnProperty(d[g])&&(f[d[g]]={}),f&&(f=f[d[g]]));return f}return a}var e=a("type-component");c.get=function(a,b){if(!~b.indexOf("."))return a[b];var c=d(a,b),f=b.split(".").pop(),g=e(c);return"object"==g||"array"==g?c[f]:void 0},c.set=function(a,b,c){if(~b.indexOf(".")){var f=d(a,b,!0),g=b.split(".").pop();f&&"object"==e(f)&&(f[g]=c)}else a[b]=c},c.parent=d},{"type-component":15}],15:[function(a,b){var c=Object.prototype.toString;b.exports=function(a){switch(c.call(a)){case"[object Function]":return"function";case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array"}return null===a?"null":void 0===a?"undefined":a===Object(a)?"object":typeof a}},{}],16:[function(a,b){function c(a,b){switch(d(a)){case"null":case"undefined":return null==b;case"regexp":return a.test(b);case"array":if("array"==d(b)&&a.length==b.length){for(var e=0;e<a.length;e++)if(!c(b[e],a[e]))return!1;return!0}return!1;case"object":var f={};for(var e in a){if(a.hasOwnProperty(e)&&(!b.hasOwnProperty(e)||!c(a[e],b[e])))return!1;f[e]=!0}for(var e in b)if(b.hasOwnProperty(e)&&!f.hasOwnProperty(e))return!1;return!0;default:return a===b}}var d=a("component-type");b.exports=c},{"component-type":10}],17:[function(a,b,c){var d=Object.prototype.hasOwnProperty;c.keys=Object.keys||function(a){var b=[];for(var c in a)d.call(a,c)&&b.push(c);return b},c.values=function(a){var b=[];for(var c in a)d.call(a,c)&&b.push(a[c]);return b},c.merge=function(a,b){for(var c in b)d.call(b,c)&&(a[c]=b[c]);return a},c.length=function(a){return c.keys(a).length},c.isEmpty=function(a){return 0==c.length(a)}},{}],18:[function(a,b,c){var d=a("mongo-eql"),e=a("component-type");c.$ne=function(a,b){return!d(a,b)},c.$gt=function(a,b){return"number"===e(a)&&b>a},c.$gte=function(a,b){return"number"===e(a)&&b>=a},c.$lt=function(a,b){return"number"===e(a)&&a>b},c.$lte=function(a,b){return"number"===e(a)&&a>=b},c.$regex=function(a,b){return"regexp"!=e("matcher")&&(a=new RegExp(a)),a.test(b)},c.$exists=function(a,b){return a?void 0!==b:void 0===b},c.$in=function(a,b){if("array"!=e(a))return!1;for(var c=0;c<a.length;c++)if(d(a[c],b))return!0;return!1},c.$nin=function(a,b){return!c.$in(a,b)},c.$size=function(a,b){return Array.isArray(b)&&a==b.length}},{"component-type":10,"mongo-eql":16}],19:[function(a,b,c){var d=a("./lib/core").CryptoJS;a("./lib/enc-base64"),a("./lib/md5"),a("./lib/evpkdf"),a("./lib/cipher-core"),a("./lib/aes");var e=a("./lib/jsonformatter").JsonFormatter;c.CryptoJS=d,c.JsonFormatter=e},{"./lib/aes":20,"./lib/cipher-core":21,"./lib/core":22,"./lib/enc-base64":23,"./lib/evpkdf":24,"./lib/jsonformatter":25,"./lib/md5":26}],20:[function(a){var b=a("./core").CryptoJS;/*
CryptoJS v3.1.2
code.google.com/p/crypto-js
(c) 2009-2013 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/
!function(){var a=b,c=a.lib,d=c.BlockCipher,e=a.algo,f=[],g=[],h=[],i=[],j=[],k=[],l=[],m=[],n=[],o=[];!function(){for(var a=[],b=0;256>b;b++)a[b]=128>b?b<<1:b<<1^283;for(var c=0,d=0,b=0;256>b;b++){var e=d^d<<1^d<<2^d<<3^d<<4;e=e>>>8^255&e^99,f[c]=e,g[e]=c;var p=a[c],q=a[p],r=a[q],s=257*a[e]^16843008*e;h[c]=s<<24|s>>>8,i[c]=s<<16|s>>>16,j[c]=s<<8|s>>>24,k[c]=s;var s=16843009*r^65537*q^257*p^16843008*c;l[e]=s<<24|s>>>8,m[e]=s<<16|s>>>16,n[e]=s<<8|s>>>24,o[e]=s,c?(c=p^a[a[a[r^p]]],d^=a[a[d]]):c=d=1}}();var p=[0,1,2,4,8,16,32,64,128,27,54],q=e.AES=d.extend({_doReset:function(){for(var a=this._key,b=a.words,c=a.sigBytes/4,d=this._nRounds=c+6,e=4*(d+1),g=this._keySchedule=[],h=0;e>h;h++)if(c>h)g[h]=b[h];else{var i=g[h-1];h%c?c>6&&h%c==4&&(i=f[i>>>24]<<24|f[i>>>16&255]<<16|f[i>>>8&255]<<8|f[255&i]):(i=i<<8|i>>>24,i=f[i>>>24]<<24|f[i>>>16&255]<<16|f[i>>>8&255]<<8|f[255&i],i^=p[h/c|0]<<24),g[h]=g[h-c]^i}for(var j=this._invKeySchedule=[],k=0;e>k;k++){var h=e-k;if(k%4)var i=g[h];else var i=g[h-4];j[k]=4>k||4>=h?i:l[f[i>>>24]]^m[f[i>>>16&255]]^n[f[i>>>8&255]]^o[f[255&i]]}},encryptBlock:function(a,b){this._doCryptBlock(a,b,this._keySchedule,h,i,j,k,f)},decryptBlock:function(a,b){var c=a[b+1];a[b+1]=a[b+3],a[b+3]=c,this._doCryptBlock(a,b,this._invKeySchedule,l,m,n,o,g);var c=a[b+1];a[b+1]=a[b+3],a[b+3]=c},_doCryptBlock:function(a,b,c,d,e,f,g,h){for(var i=this._nRounds,j=a[b]^c[0],k=a[b+1]^c[1],l=a[b+2]^c[2],m=a[b+3]^c[3],n=4,o=1;i>o;o++){var p=d[j>>>24]^e[k>>>16&255]^f[l>>>8&255]^g[255&m]^c[n++],q=d[k>>>24]^e[l>>>16&255]^f[m>>>8&255]^g[255&j]^c[n++],r=d[l>>>24]^e[m>>>16&255]^f[j>>>8&255]^g[255&k]^c[n++],s=d[m>>>24]^e[j>>>16&255]^f[k>>>8&255]^g[255&l]^c[n++];j=p,k=q,l=r,m=s}var p=(h[j>>>24]<<24|h[k>>>16&255]<<16|h[l>>>8&255]<<8|h[255&m])^c[n++],q=(h[k>>>24]<<24|h[l>>>16&255]<<16|h[m>>>8&255]<<8|h[255&j])^c[n++],r=(h[l>>>24]<<24|h[m>>>16&255]<<16|h[j>>>8&255]<<8|h[255&k])^c[n++],s=(h[m>>>24]<<24|h[j>>>16&255]<<16|h[k>>>8&255]<<8|h[255&l])^c[n++];a[b]=p,a[b+1]=q,a[b+2]=r,a[b+3]=s},keySize:8});a.AES=d._createHelper(q)}()},{"./core":22}],21:[function(a){var b=a("./core").CryptoJS;/*
CryptoJS v3.1.2
code.google.com/p/crypto-js
(c) 2009-2013 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/
b.lib.Cipher||function(a){var c=b,d=c.lib,e=d.Base,f=d.WordArray,g=d.BufferedBlockAlgorithm,h=c.enc,i=(h.Utf8,h.Base64),j=c.algo,k=j.EvpKDF,l=d.Cipher=g.extend({cfg:e.extend(),createEncryptor:function(a,b){return this.create(this._ENC_XFORM_MODE,a,b)},createDecryptor:function(a,b){return this.create(this._DEC_XFORM_MODE,a,b)},init:function(a,b,c){this.cfg=this.cfg.extend(c),this._xformMode=a,this._key=b,this.reset()},reset:function(){g.reset.call(this),this._doReset()},process:function(a){return this._append(a),this._process()},finalize:function(a){a&&this._append(a);var b=this._doFinalize();return b},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function a(a){return"string"==typeof a?x:u}return function(b){return{encrypt:function(c,d,e){return a(d).encrypt(b,c,d,e)},decrypt:function(c,d,e){return a(d).decrypt(b,c,d,e)}}}}()}),m=(d.StreamCipher=l.extend({_doFinalize:function(){var a=this._process(!0);return a},blockSize:1}),c.mode={}),n=d.BlockCipherMode=e.extend({createEncryptor:function(a,b){return this.Encryptor.create(a,b)},createDecryptor:function(a,b){return this.Decryptor.create(a,b)},init:function(a,b){this._cipher=a,this._iv=b}}),o=m.CBC=function(){function b(b,c,d){var e=this._iv;if(e){var f=e;this._iv=a}else var f=this._prevBlock;for(var g=0;d>g;g++)b[c+g]^=f[g]}var c=n.extend();return c.Encryptor=c.extend({processBlock:function(a,c){var d=this._cipher,e=d.blockSize;b.call(this,a,c,e),d.encryptBlock(a,c),this._prevBlock=a.slice(c,c+e)}}),c.Decryptor=c.extend({processBlock:function(a,c){var d=this._cipher,e=d.blockSize,f=a.slice(c,c+e);d.decryptBlock(a,c),b.call(this,a,c,e),this._prevBlock=f}}),c}(),p=c.pad={},q=p.Pkcs7={pad:function(a,b){for(var c=4*b,d=c-a.sigBytes%c,e=d<<24|d<<16|d<<8|d,g=[],h=0;d>h;h+=4)g.push(e);var i=f.create(g,d);a.concat(i)},unpad:function(a){var b=255&a.words[a.sigBytes-1>>>2];a.sigBytes-=b}},r=(d.BlockCipher=l.extend({cfg:l.cfg.extend({mode:o,padding:q}),reset:function(){l.reset.call(this);var a=this.cfg,b=a.iv,c=a.mode;if(this._xformMode==this._ENC_XFORM_MODE)var d=c.createEncryptor;else{var d=c.createDecryptor;this._minBufferSize=1}this._mode=d.call(c,this,b&&b.words)},_doProcessBlock:function(a,b){this._mode.processBlock(a,b)},_doFinalize:function(){var a=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){a.pad(this._data,this.blockSize);var b=this._process(!0)}else{var b=this._process(!0);a.unpad(b)}return b},blockSize:4}),d.CipherParams=e.extend({init:function(a){this.mixIn(a)},toString:function(a){return(a||this.formatter).stringify(this)}})),s=c.format={},t=s.OpenSSL={stringify:function(a){var b=a.ciphertext,c=a.salt;if(c)var d=f.create([1398893684,1701076831]).concat(c).concat(b);else var d=b;return d.toString(i)},parse:function(a){var b=i.parse(a),c=b.words;if(1398893684==c[0]&&1701076831==c[1]){var d=f.create(c.slice(2,4));c.splice(0,4),b.sigBytes-=16}return r.create({ciphertext:b,salt:d})}},u=d.SerializableCipher=e.extend({cfg:e.extend({format:t}),encrypt:function(a,b,c,d){d=this.cfg.extend(d);var e=a.createEncryptor(c,d),f=e.finalize(b),g=e.cfg;return r.create({ciphertext:f,key:c,iv:g.iv,algorithm:a,mode:g.mode,padding:g.padding,blockSize:a.blockSize,formatter:d.format})},decrypt:function(a,b,c,d){d=this.cfg.extend(d),b=this._parse(b,d.format);var e=a.createDecryptor(c,d).finalize(b.ciphertext);return e},_parse:function(a,b){return"string"==typeof a?b.parse(a,this):a}}),v=c.kdf={},w=v.OpenSSL={execute:function(a,b,c,d){d||(d=f.random(8));var e=k.create({keySize:b+c}).compute(a,d),g=f.create(e.words.slice(b),4*c);return e.sigBytes=4*b,r.create({key:e,iv:g,salt:d})}},x=d.PasswordBasedCipher=u.extend({cfg:u.cfg.extend({kdf:w}),encrypt:function(a,b,c,d){d=this.cfg.extend(d);var e=d.kdf.execute(c,a.keySize,a.ivSize);d.iv=e.iv;var f=u.encrypt.call(this,a,b,e.key,d);return f.mixIn(e),f},decrypt:function(a,b,c,d){d=this.cfg.extend(d),b=this._parse(b,d.format);var e=d.kdf.execute(c,a.keySize,a.ivSize,b.salt);d.iv=e.iv;var f=u.decrypt.call(this,a,b,e.key,d);return f}})}()},{"./core":22}],22:[function(a,b,c){/*
CryptoJS v3.1.2
code.google.com/p/crypto-js
(c) 2009-2013 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/
var d=d||function(a,b){var c={},d=c.lib={},e=d.Base=function(){function a(){}return{extend:function(b){a.prototype=this;var c=new a;return b&&c.mixIn(b),c.hasOwnProperty("init")||(c.init=function(){c.$super.init.apply(this,arguments)}),c.init.prototype=c,c.$super=this,c},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),f=d.WordArray=e.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||h).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes,e=a.sigBytes;if(this.clamp(),d%4)for(var f=0;e>f;f++){var g=c[f>>>2]>>>24-f%4*8&255;b[d+f>>>2]|=g<<24-(d+f)%4*8}else if(c.length>65535)for(var f=0;e>f;f+=4)b[d+f>>>2]=c[f>>>2];else b.push.apply(b,c);return this.sigBytes+=e,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-c%4*8,b.length=a.ceil(c/4)},clone:function(){var a=e.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return new f.init(c,b)}}),g=c.enc={},h=g.Hex={stringify:function(a){for(var b=a.words,c=a.sigBytes,d=[],e=0;c>e;e++){var f=b[e>>>2]>>>24-e%4*8&255;d.push((f>>>4).toString(16)),d.push((15&f).toString(16))}return d.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-d%8*4;return new f.init(c,b/2)}},i=g.Latin1={stringify:function(a){for(var b=a.words,c=a.sigBytes,d=[],e=0;c>e;e++){var f=b[e>>>2]>>>24-e%4*8&255;d.push(String.fromCharCode(f))}return d.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-d%4*8;return new f.init(c,b)}},j=g.Utf8={stringify:function(a){try{return decodeURIComponent(escape(i.stringify(a)))}catch(b){throw new Error("Malformed UTF-8 data")}},parse:function(a){return i.parse(unescape(encodeURIComponent(a)))}},k=d.BufferedBlockAlgorithm=e.extend({reset:function(){this._data=new f.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=j.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,g=this.blockSize,h=4*g,i=e/h;i=b?a.ceil(i):a.max((0|i)-this._minBufferSize,0);var j=i*g,k=a.min(4*j,e);if(j){for(var l=0;j>l;l+=g)this._doProcessBlock(d,l);var m=d.splice(0,j);c.sigBytes-=k}return new f.init(m,k)},clone:function(){var a=e.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0}),l=(d.Hasher=k.extend({cfg:e.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){k.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){a&&this._append(a);var b=this._doFinalize();return b},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new l.HMAC.init(a,c).finalize(b)}}}),c.algo={});return c}(Math);c.CryptoJS=d},{}],23:[function(a){var b=a("./core").CryptoJS;/*
CryptoJS v3.1.2
code.google.com/p/crypto-js
(c) 2009-2013 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/
!function(){{var a=b,c=a.lib,d=c.WordArray,e=a.enc;e.Base64={stringify:function(a){var b=a.words,c=a.sigBytes,d=this._map;a.clamp();for(var e=[],f=0;c>f;f+=3)for(var g=b[f>>>2]>>>24-f%4*8&255,h=b[f+1>>>2]>>>24-(f+1)%4*8&255,i=b[f+2>>>2]>>>24-(f+2)%4*8&255,j=g<<16|h<<8|i,k=0;4>k&&c>f+.75*k;k++)e.push(d.charAt(j>>>6*(3-k)&63));var l=d.charAt(64);if(l)for(;e.length%4;)e.push(l);return e.join("")},parse:function(a){var b=a.length,c=this._map,e=c.charAt(64);if(e){var f=a.indexOf(e);-1!=f&&(b=f)}for(var g=[],h=0,i=0;b>i;i++)if(i%4){var j=c.indexOf(a.charAt(i-1))<<i%4*2,k=c.indexOf(a.charAt(i))>>>6-i%4*2;g[h>>>2]|=(j|k)<<24-h%4*8,h++}return d.create(g,h)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}}()},{"./core":22}],24:[function(a){var b=a("./core").CryptoJS;/*
CryptoJS v3.1.2
code.google.com/p/crypto-js
(c) 2009-2013 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/
!function(){var a=b,c=a.lib,d=c.Base,e=c.WordArray,f=a.algo,g=f.MD5,h=f.EvpKDF=d.extend({cfg:d.extend({keySize:4,hasher:g,iterations:1}),init:function(a){this.cfg=this.cfg.extend(a)},compute:function(a,b){for(var c=this.cfg,d=c.hasher.create(),f=e.create(),g=f.words,h=c.keySize,i=c.iterations;g.length<h;){j&&d.update(j);var j=d.update(a).finalize(b);d.reset();for(var k=1;i>k;k++)j=d.finalize(j),d.reset();f.concat(j)}return f.sigBytes=4*h,f}});a.EvpKDF=function(a,b,c){return h.create(c).compute(a,b)}}()},{"./core":22}],25:[function(a,b,c){var d=a("./core").CryptoJS,e={stringify:function(a){var b={ct:a.ciphertext.toString(d.enc.Base64)};return a.iv&&(b.iv=a.iv.toString()),a.salt&&(b.s=a.salt.toString()),JSON.stringify(b)},parse:function(a){var b=JSON.parse(a),c=d.lib.CipherParams.create({ciphertext:d.enc.Base64.parse(b.ct)});return b.iv&&(c.iv=d.enc.Hex.parse(b.iv)),b.s&&(c.salt=d.enc.Hex.parse(b.s)),c}};c.JsonFormatter=e},{"./core":22}],26:[function(a){var b=a("./core").CryptoJS;/*
CryptoJS v3.1.2
code.google.com/p/crypto-js
(c) 2009-2013 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/
!function(a){function c(a,b,c,d,e,f,g){var h=a+(b&c|~b&d)+e+g;return(h<<f|h>>>32-f)+b}function d(a,b,c,d,e,f,g){var h=a+(b&d|c&~d)+e+g;return(h<<f|h>>>32-f)+b}function e(a,b,c,d,e,f,g){var h=a+(b^c^d)+e+g;return(h<<f|h>>>32-f)+b}function f(a,b,c,d,e,f,g){var h=a+(c^(b|~d))+e+g;return(h<<f|h>>>32-f)+b}var g=b,h=g.lib,i=h.WordArray,j=h.Hasher,k=g.algo,l=[];!function(){for(var b=0;64>b;b++)l[b]=4294967296*a.abs(a.sin(b+1))|0}();var m=k.MD5=j.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(a,b){for(var g=0;16>g;g++){var h=b+g,i=a[h];a[h]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8)}var j=this._hash.words,k=a[b+0],m=a[b+1],n=a[b+2],o=a[b+3],p=a[b+4],q=a[b+5],r=a[b+6],s=a[b+7],t=a[b+8],u=a[b+9],v=a[b+10],w=a[b+11],x=a[b+12],y=a[b+13],z=a[b+14],A=a[b+15],B=j[0],C=j[1],D=j[2],E=j[3];B=c(B,C,D,E,k,7,l[0]),E=c(E,B,C,D,m,12,l[1]),D=c(D,E,B,C,n,17,l[2]),C=c(C,D,E,B,o,22,l[3]),B=c(B,C,D,E,p,7,l[4]),E=c(E,B,C,D,q,12,l[5]),D=c(D,E,B,C,r,17,l[6]),C=c(C,D,E,B,s,22,l[7]),B=c(B,C,D,E,t,7,l[8]),E=c(E,B,C,D,u,12,l[9]),D=c(D,E,B,C,v,17,l[10]),C=c(C,D,E,B,w,22,l[11]),B=c(B,C,D,E,x,7,l[12]),E=c(E,B,C,D,y,12,l[13]),D=c(D,E,B,C,z,17,l[14]),C=c(C,D,E,B,A,22,l[15]),B=d(B,C,D,E,m,5,l[16]),E=d(E,B,C,D,r,9,l[17]),D=d(D,E,B,C,w,14,l[18]),C=d(C,D,E,B,k,20,l[19]),B=d(B,C,D,E,q,5,l[20]),E=d(E,B,C,D,v,9,l[21]),D=d(D,E,B,C,A,14,l[22]),C=d(C,D,E,B,p,20,l[23]),B=d(B,C,D,E,u,5,l[24]),E=d(E,B,C,D,z,9,l[25]),D=d(D,E,B,C,o,14,l[26]),C=d(C,D,E,B,t,20,l[27]),B=d(B,C,D,E,y,5,l[28]),E=d(E,B,C,D,n,9,l[29]),D=d(D,E,B,C,s,14,l[30]),C=d(C,D,E,B,x,20,l[31]),B=e(B,C,D,E,q,4,l[32]),E=e(E,B,C,D,t,11,l[33]),D=e(D,E,B,C,w,16,l[34]),C=e(C,D,E,B,z,23,l[35]),B=e(B,C,D,E,m,4,l[36]),E=e(E,B,C,D,p,11,l[37]),D=e(D,E,B,C,s,16,l[38]),C=e(C,D,E,B,v,23,l[39]),B=e(B,C,D,E,y,4,l[40]),E=e(E,B,C,D,k,11,l[41]),D=e(D,E,B,C,o,16,l[42]),C=e(C,D,E,B,r,23,l[43]),B=e(B,C,D,E,u,4,l[44]),E=e(E,B,C,D,x,11,l[45]),D=e(D,E,B,C,A,16,l[46]),C=e(C,D,E,B,n,23,l[47]),B=f(B,C,D,E,k,6,l[48]),E=f(E,B,C,D,s,10,l[49]),D=f(D,E,B,C,z,15,l[50]),C=f(C,D,E,B,q,21,l[51]),B=f(B,C,D,E,x,6,l[52]),E=f(E,B,C,D,o,10,l[53]),D=f(D,E,B,C,v,15,l[54]),C=f(C,D,E,B,m,21,l[55]),B=f(B,C,D,E,t,6,l[56]),E=f(E,B,C,D,A,10,l[57]),D=f(D,E,B,C,r,15,l[58]),C=f(C,D,E,B,y,21,l[59]),B=f(B,C,D,E,p,6,l[60]),E=f(E,B,C,D,w,10,l[61]),D=f(D,E,B,C,n,15,l[62]),C=f(C,D,E,B,u,21,l[63]),j[0]=j[0]+B|0,j[1]=j[1]+C|0,j[2]=j[2]+D|0,j[3]=j[3]+E|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;c[e>>>5]|=128<<24-e%32;var f=a.floor(d/4294967296),g=d;c[(e+64>>>9<<4)+15]=16711935&(f<<8|f>>>24)|4278255360&(f<<24|f>>>8),c[(e+64>>>9<<4)+14]=16711935&(g<<8|g>>>24)|4278255360&(g<<24|g>>>8),b.sigBytes=4*(c.length+1),this._process();for(var h=this._hash,i=h.words,j=0;4>j;j++){var k=i[j];i[j]=16711935&(k<<8|k>>>24)|4278255360&(k<<24|k>>>8)}return h},clone:function(){var a=j.clone.call(this);return a._hash=this._hash.clone(),a}});g.MD5=j._createHelper(m),g.HmacMD5=j._createHmacHelper(m)}(Math)},{"./core":22}],27:[function(a,b){"use strict";var c={};c.DefaultTakeItemsCount=50,c.ExpandExpressionName="Expand",c.ReturnAsFieldName="ReturnAs",c.FieldsExpressionName="Fields",c.SingleFieldExpressionName="SingleField",c.SortExpressionName="Sort",c.FilterExpressionName="Filter",c.SkipExpressionName="Skip",c.TakeExpressionName="Take",c.ParentRelationFieldName="ParentRelationField",c.IdFieldNameClient="Id",c.TargetTypeNameFieldName="TargetTypeName",b.exports=c},{}],28:[function(a,b){"use strict";var c=a("./Constants"),d=function(a,b){var c="";a&&(c=a.path),this.parent=c,this.relations=[b.path],this.name=b.path,this.targetTypeName=b.targetTypeName,this.canAddOtherRelations=!(b.filterExpression||b.sortExpression||b.take||b.skip),this.children=[];var d="";c&&(d+=c+"."),d+=b.targetTypeName,this.path=d};d.prototype.insertRelationNode=function(a){this.relations.push(a.path)},d.prototype.insertChildrenNode=function(a){this.children.push(a.name)},d.prototype.canCombineWithRelation=function(a){return this.canAddOtherRelations?!(this.targetTypeName!==a.targetTypeName||a.filterExpression||a.sortExpression||a.take||a.skip):!1};var e=function(a){this._relationTree=a,this._map={}};e.prototype.addExecutionNode=function(a){this._map[a.name]=a},e.prototype.getExecutionNodeOfRelation=function(a){for(var b in this._map)if(this._map.hasOwnProperty(b)&&this._map[b].relations.indexOf(a)>-1)return this._map[b];return null},e.prototype.getRelationNode=function(a){return a?this._relationTree[a]||null:null},e.prototype.getRootRelationNode=function(){return this._relationTree[this._relationTree.$root]||null},e.prototype.build=function(){var a=this.getRelationNode(this._relationTree.$root),b=new d(null,a);this.addExecutionNode(b),this.buildInternal(a)},e.prototype.buildInternal=function(a){a.children.forEach(function(a){var b=this.getRelationNode(a);this.insertRelationNodeInExecutionTree(b),this.buildInternal(b)},this)},e.prototype.insertRelationNodeInExecutionTree=function(a){var b=this.getExecutionNodeOfRelation(a.parent),c=this.tryGetChildNodeToCombine(b,a);if(c)c.insertRelationNode(a);else{var e=new d(b,a);b.insertChildrenNode(e),this.addExecutionNode(e)}},e.prototype.tryGetChildNodeToCombine=function(a,b){if(a.canCombineWithRelation(b))return a;for(var c=a.children,d=0;d<c.length;d++){var e=this._map[c[d]],f=this.tryGetChildNodeToCombine(e,b);if(f)return f}return null},e.prototype.getFilterFromExecutionNode=function(a,b){for(var c={},d=[],e=0;e<a.relations.length;e++){var f=this.getFilterFromSingleRelation(this._relationTree[a.relations[e]],b);f&&d.push(f)}return d.length>1?c.$or=d:c=d.length>0?d[0]:null,c},e.prototype.getFilterFromSingleRelation=function(a,b){var d=a.filterExpression,e={},f=this.getRelationFieldValues(a,b),g=a.isInvertedRelation?a.relationField:c.IdFieldNameClient;if(!(f.length>0))return null;if(e[g]={$in:f},void 0!==d){var h=[];return h.push(e),h.push(d),{$and:h}}return e},e.prototype.getRelationFieldValues=function(a,b){var c=[],d=this._relationTree[a.parent],e=Array.isArray(d.result)?d.result:[d.result];if(a.isInvertedRelation)for(var f=0;f<e.length;f++)c.push(e[f][a.parentRelationField]);else if(d&&d.result){a.parentRelationIds=a.parentRelationIds||{};for(var g=0;g<e.length;g++){var h=e[g],i=h[a.relationField];if(Array.isArray(i)){if(a.hasArrayValues=!0,b)for(var j=0;j<i.length;j++){var k=i[j];void 0!==k&&null!==k&&(c.push(k),a.parentRelationIds[k]=1)}}else void 0!==i&&null!==i&&(c.push(i),a.parentRelationIds[i]=1)}}return c},b.exports=e},{"./Constants":27}],29:[function(a,b){"use strict";function c(a){this.name="ExpandError",this.message=a,this.stack=(new Error).stack}c.prototype=new Error,b.exports=c},{}],30:[function(a,b){"use strict";function c(a){this._executionNodeFunction=a.executionNodeFunction,this._metadataProviderFunction=a.metadataProviderFunction}var d=a("async"),e=a("./RelationTreeBuilder"),f=a("./ExecutionTree"),g=a("./Constants"),h=a("./ExpandError");c.prototype._getExecutionTreeRoot=function(a){var b=null;for(var c in a)if(a.hasOwnProperty(c)&&""===a[c].parent){b=a[c];break}return b},c.prototype._createExecuteNodeExecutor=function(a,b,c,e){var f=this,g=a.map;return function(i){var j=b.getRelationNode(c.relations[0]),k=b.getRelationNode(j.parent),l=!(k.parent&&k.hasArrayValues),m=b.getFilterFromExecutionNode(c,l),n=a.validateSingleRelation(j);if(n)return i(new h(n));var o={};o.select=j.fieldsExpression,o.sort=j.sortExpression,o.skip=j.skip,o.take=j.take,o.filter=m,o.targetTypeName=j.targetTypeName,f._executionNodeFunction.call(null,o,e,function(h,j){if(h)return i(h);for(var k=0;k<c.relations.length;k++){var l=g[c.relations[k]];l.result=f._extractResultForRelation(g[c.relations[k]],j)}c.result=l.result;for(var m=[],n=0;n<c.children.length;n++){var o=b._map;m.push(f._createExecuteNodeExecutor(a,b,o[c.children[n]],e))}d.parallel(m,i)})}},c.prototype._getSingleResult=function(a,b,c){if(!c)return null;var d,e;if(b.singleFieldName)return b.children&&b.children.length>0?(d=a[b.children[0]],e=this._getObjectByIdFromArray(d.result,c[b.singleFieldName]),this._getSingleResult(a,d,e)):c[b.singleFieldName];var f={},g={};if(b.children&&b.children.length>0)for(var h=0;h<b.children.length;h++){d=a[b.children[h]];var i=d.relationField,j=d.userDefinedName;d.isInvertedRelation||(g[i]=1);var k=d.result;if(d.isInvertedRelation)for(var l=0;l<k.length;l++)this._addSingleResultToParentArray(a,d,k[l],f,j);else if(f[j]=d.isArray()?[]:null,c[i])if(Array.isArray(c[i]))if(d.sortExpression)for(var m=0;m<k.length;m++)c[i].indexOf(k[m].Id)>-1&&(e=k[m],this._addSingleResultToParentArray(a,d,e,f,j));else for(var n=0;n<c[i].length;n++)e=this._getObjectByIdFromArray(k,c[i][n]),this._addSingleResultToParentArray(a,d,e,f,j);else e=this._getObjectByIdFromArray(k,c[i]),f[j]=this._getSingleResult(a,d,e)}for(var o in c){var p=c.hasOwnProperty(o)&&!g[o]&&this._fieldExistInFieldsExpression(o,b.originalFieldsExpression);p&&(f[o]=c[o])}return f},c.prototype._addSingleResultToParentArray=function(a,b,c,d,e){var f=this._getSingleResult(a,b,c);d[e]=d[e]||[],f&&d[e].push(f)},c.prototype._fieldExistInFieldsExpression=function(a,b){if(void 0===b||0===Object.keys(b).length)return!0;if(a===g.IdFieldNameClient)return void 0===b[a]?!0:b[a];var c=e.getIsFieldsExpressionExclusive(b);return void 0===c?!0:c?!b.hasOwnProperty(a):b.hasOwnProperty(a)},c.prototype._extractResultForRelation=function(a,b){for(var c=[],d=0;d<b.length;d++)a.parentRelationIds&&a.parentRelationIds.hasOwnProperty(b[d].Id)&&c.push(b[d]),a.isInvertedRelation&&c.push(b[d]);return c},c.prototype._getObjectByIdFromArray=function(a,b){if(a)for(var c=0;c<a.length;c++)if(a[c].Id===b)return a[c];return null},c.prototype.prepare=function(a,b,c,d,f,g,h){var i=new e(a,b,c,d,f,this._metadataProviderFunction,g);i.build(function(a,b){var c;if(b){c=b[b.$root].fieldsExpression;var d={relationsTree:i,mainQueryFieldsExpression:c}}h(a,d)})},c.prototype.expand=function(a,b,c,e){var g=a.map,i=this,j=new f(g);j.build(),g[g.$root].result=b;var k=j._map,l=this._getExecutionTreeRoot(k),m=20;if(Object.keys(k).length>m&&e(new h("Expand expression results in more than "+m+" inner queries!")),l){for(var n=[],o=0;o<l.children.length;o++)n.push(this._createExecuteNodeExecutor(a,j,k[l.children[o]],c));d.series(n,function(a){if(a)e(a);else{var c,d=g[g.$root];if(Array.isArray(b)){c=[];for(var f=0;f<b.length;f++){var h=i._getSingleResult(g,d,b[f]);h&&c.push(h)}}else c=i._getSingleResult(g,d,b);e(null,c)}})}},c.Constants=g,b.exports=c},{"./Constants":27,"./ExecutionTree":28,"./ExpandError":29,"./RelationTreeBuilder":32,async:33}],31:[function(a,b){"use strict";function c(a){this.parent=a.parent,this.relationField=a.relationField,this.path=a.path||a.parent+"."+a.relationField,this.fieldsExpression=a.fieldsExpression||{},this.targetTypeName=a.targetTypeName,this.children=[],this.isInvertedRelation=a.isInvertedRelation,this.isArrayRoot=a.isArrayRoot,this.hasArrayValues=!1;var b=a.expandExpression||{};this.parentRelationField=b[d.ParentRelationFieldName]||d.IdFieldNameClient;var c=this.isInvertedRelation?this.path:this.relationField;this.userDefinedName=b[d.ReturnAsFieldName]||c,e.extend(this.fieldsExpression,b[d.FieldsExpressionName]),this.originalFieldsExpression={},e.extend(this.originalFieldsExpression,this.fieldsExpression),this.singleFieldName=b[d.SingleFieldExpressionName],this.filterExpression=b[d.FilterExpressionName],this.sortExpression=b[d.SortExpressionName],this.skip=b[d.SkipExpressionName],this.take=this._getTakeLimit(b[d.TakeExpressionName],a.maxTakeValue)}var d=a("./Constants"),e=a("underscore"),f=a("./ExpandError");c.prototype._getTakeLimit=function(a,b){if(b=b||d.DefaultTakeItemsCount,a){if(a>b)throw new f("The maximum allowed take value when expanding relations is "+b+"!");return a}return b},c.prototype.setIsArrayFromMetadata=function(){this.isArrayFromMetadata=!0},c.prototype.isArray=function(){return this.isArrayFromMetadata||this.isInvertedRelation||this.hasArrayValues},b.exports=c},{"./Constants":27,"./ExpandError":29,underscore:1}],32:[function(a,b){"use strict";var c=a("./RelationNode"),d=a("underscore"),e=a("./Constants"),f=a("./ExpandError"),g=[e.ExpandExpressionName,e.ReturnAsFieldName,e.FieldsExpressionName,e.SingleFieldExpressionName,e.SortExpressionName,e.FilterExpressionName,e.SkipExpressionName,e.TakeExpressionName,e.ParentRelationFieldName,e.TargetTypeNameFieldName],h=function(a,b,e,f,g,h,i){this.maxTakeValue=g,this._metadataProviderFunction=h,this.context=i,this.expandExpression=this.processExpandExpression(a),this.map={},this.map[b]=new c({targetTypeName:b,isArrayRoot:e,fieldsExpression:f,validated:!0,path:b,maxTakeValue:g}),this.map[b].originalFieldsExpression={},d.extend(this.map[b].originalFieldsExpression,f),this.map.$root=b};h.prototype.processExpandExpression=function(a){for(var b in a)if(a.hasOwnProperty(b)&&("boolean"==typeof a[b]&&(a[b]={},a[b][e.ReturnAsFieldName]=b),"string"==typeof a[b])){var c=a[b];a[b]={},a[b][e.ReturnAsFieldName]=c}return a},h.prototype.build=function(b){try{this.buildMapInternal(this.expandExpression,this.map.$root)}catch(c){return b(c)}var d=this;a("async").series([this.configureRelationTree.bind(this),this.validateRelationTree.bind(this)],function(a){b(a,d.map)})},h.prototype.createInvertedRelation=function(a,b,d){var e={},f=a.split(".");return e.parent=d,e.relationField=f[1],e.isInvertedRelation=!0,e.targetTypeName=f[0],e.expandExpression=b,e.path=a,e.maxTakeValue=this.maxTakeValue,e.validated=!1,new c(e)},h.prototype.buildMapInternal=function(a,b){for(var d in a)if(a.hasOwnProperty(d)){var i=a[d];for(var j in i)if(i.hasOwnProperty(j)&&-1===g.indexOf(j))throw new f('"'+j+'" is not a valid option for Expand expression');if(d.indexOf(".")>-1){var k=this.createInvertedRelation(d,i,b);if(this.map[k.path]=k,this.map[k.parent].children.push(k.path),h.addFieldToFieldsExpression(this.map[k.parent].originalFieldsExpression,k.userDefinedName),a[d][e.ExpandExpressionName]){var l=this.processExpandExpression(a[d][e.ExpandExpressionName]);this.buildMapInternal(l,k.path)}}else{var m={};m.relationField=d,m.parent=b,m.expandExpression=i,m.maxTakeValue=this.maxTakeValue,m.targetTypeName=i[e.TargetTypeNameFieldName];var n=new c(m),o=this.map[m.parent];if(o.children.push(n.path),this.map[n.path]=n,i.hasOwnProperty(e.ExpandExpressionName)){if("object"!=typeof i[e.ExpandExpressionName])throw new f(n.path+".Expand must be a valid expand expression!");this.buildMapInternal(this.processExpandExpression(i.Expand),n.path)}}}},h.prototype.configureRelationTree=function(a){if(!this._metadataProviderFunction)return a();var b=[];for(var c in this.map)this.map.hasOwnProperty(c)&&null!==this.map[c].parent&&b.push(this.map[c].relationField);this._metadataProviderFunction(b,this.map,this.context,function(b){a(b)})},h.prototype.validateRelationTree=function(a){var b="",c="\r\n";for(var d in this.map)if("$root"!==d&&this.map.hasOwnProperty(d)){var e=this.map[d];b+=this.validateSingleRelation(e),this.configureFieldsExpressionsForRelation(e)}if(""!==b){var g=b.substr(0,b.lastIndexOf(c)),h=new f(g);return a(h)}a()},h.prototype.configureFieldsExpressionsForRelation=function(a){if(a.parent){var b=this.map[a.parent].fieldsExpression;a.isInvertedRelation?h.addFieldToFieldsExpression(b,a.parentRelationField):h.addFieldToFieldsExpression(b,a.relationField)}a.isInvertedRelation?h.addFieldToFieldsExpression(a.fieldsExpression,a.relationField):h.addFieldToFieldsExpression(a.fieldsExpression,e.IdFieldNameClient),h.adjustParentRelationFieldsExpression(this.map[a.parent],a)},h.prototype.validateSingleRelation=function(a){var b="",c="\r\n",d=this.map[this.map.$root].isArrayRoot;if(a.path===a.parent)return b+=a.path+" has same parent which will cause an infinite loop."+c;if(a.isArray()){var e=this.getParentMultipleRelationsCount(a);e>0&&(b+='Expand expression has multiple relation "'+a.path+'" inside a multiple relation.',b+=c),this.map[a.parent]===this.map[this.map.$root]&&d&&(a.filterExpression||a.sortExpression)&&(b+="Filter and Sort expressions are not allowed with GetByFilter scenario.",b+=c),d&&a.isInvertedRelation&&(b+="Expanding an external content type is not allowed with GetByFilter scenario.",b+=c)}return a.targetTypeName||(b+='Expanding relation "'+a.relationField+'" has no target type name specified. You should use "TargetTypeName" to specify it.',b+=c),a.fieldsExpression&&Object.keys(a.fieldsExpression).length&&a.singleFieldName&&(b+=a.path+" ",b+='expand expression contains both "Fields" and "SingleField" expressions.',b+=c),a.singleFieldName&&a.children&&(a.children.length>1&&(b+=a.path+" has multiple expand expressions with a single field option."+c),1===a.children.length&&this.map[a.children[0]].relationField!==a.singleFieldName&&(b+="Expand expression "+a.path,b+=' single field "'+a.singleFieldName+'"',b+=' does not match child relation field "'+this.map[a.children[0]].relationField+'".',b+=c)),b},h.prototype.getParentMultipleRelationsCount=function(a){for(var b=0,c=a;c.parent;){var d=this.map[c.parent];d.isArray()&&d.parent&&(b+=1),c=d}return b},h.adjustParentRelationFieldsExpression=function(a,b){if(!b.isInvertedRelation&&b.take&&"number"==typeof b.take){var c=b.isArray()&&!b.filterExpression&&!b.sortExpression&&a;c&&(void 0===a.fieldsExpression&&(a.fieldsExpression={}),a.fieldsExpression[b.relationField]=b.skip&&"number"==typeof b.skip?{$slice:[b.skip,b.take]}:{$slice:b.take},b.take=null,b.skip=null,b.movedSkipTakeAsSlice=!0)}},h.addFieldToFieldsExpression=function(a,b){if(void 0!==a&&0!==Object.keys(a).length){var c=h.getIsFieldsExpressionExclusive(a);void 0!==c&&(c?delete a[b]:a[b]=1)}},h.getIsFieldsExpressionExclusive=function(a){var b;for(var c in a)if(c!==e.IdFieldNameClient&&a.hasOwnProperty(c)&&void 0===b){if(0===a[c]){b=!0;break}if("object"==typeof a[c])continue;b=!1;break}return b},b.exports=h},{"./Constants":27,"./ExpandError":29,"./RelationNode":31,async:33,underscore:1}],33:[function(a,b){(function(a){/*!
 * async
 * https://github.com/caolan/async
 *
 * Copyright 2010-2014 Caolan McMahon
 * Released under the MIT license
 */
!function(){function c(a){var b=!1;return function(){if(b)throw new Error("Callback was already called.");b=!0,a.apply(d,arguments)}}var d,e,f={};d=this,null!=d&&(e=d.async),f.noConflict=function(){return d.async=e,f};var g=Object.prototype.toString,h=Array.isArray||function(a){return"[object Array]"===g.call(a)},i=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},j=function(a,b){if(a.map)return a.map(b);var c=[];return i(a,function(a,d,e){c.push(b(a,d,e))}),c},k=function(a,b,c){return a.reduce?a.reduce(b,c):(i(a,function(a,d,e){c=b(c,a,d,e)}),c)},l=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};"undefined"!=typeof a&&a.nextTick?(f.nextTick=a.nextTick,f.setImmediate="undefined"!=typeof setImmediate?function(a){setImmediate(a)}:f.nextTick):"function"==typeof setImmediate?(f.nextTick=function(a){setImmediate(a)},f.setImmediate=f.nextTick):(f.nextTick=function(a){setTimeout(a,0)},f.setImmediate=f.nextTick),f.each=function(a,b,d){function e(b){b?(d(b),d=function(){}):(f+=1,f>=a.length&&d())}if(d=d||function(){},!a.length)return d();var f=0;i(a,function(a){b(a,c(e))})},f.forEach=f.each,f.eachSeries=function(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():e())})};e()},f.forEachSeries=f.eachSeries,f.eachLimit=function(a,b,c,d){var e=m(b);e.apply(null,[a,c,d])},f.forEachLimit=f.eachLimit;var m=function(a){return function(b,c,d){if(d=d||function(){},!b.length||0>=a)return d();var e=0,f=0,g=0;!function h(){if(e>=b.length)return d();for(;a>g&&f<b.length;)f+=1,g+=1,c(b[f-1],function(a){a?(d(a),d=function(){}):(e+=1,g-=1,e>=b.length?d():h())})}()}},n=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[f.each].concat(b))}},o=function(a,b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[m(a)].concat(c))}},p=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[f.eachSeries].concat(b))}},q=function(a,b,c,d){if(b=j(b,function(a,b){return{index:b,value:a}}),d){var e=[];a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})}else a(b,function(a,b){c(a.value,function(a){b(a)})})};f.map=n(q),f.mapSeries=p(q),f.mapLimit=function(a,b,c,d){return r(b)(a,c,d)};var r=function(a){return o(a,q)};f.reduce=function(a,b,c,d){f.eachSeries(a,function(a,d){c(b,a,function(a,c){b=c,d(a)})},function(a){d(a,b)})},f.inject=f.reduce,f.foldl=f.reduce,f.reduceRight=function(a,b,c,d){var e=j(a,function(a){return a}).reverse();f.reduce(e,b,c,d)},f.foldr=f.reduceRight;var s=function(a,b,c,d){var e=[];b=j(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&e.push(a),b()})},function(){d(j(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};f.filter=n(s),f.filterSeries=p(s),f.select=f.filter,f.selectSeries=f.filterSeries;var t=function(a,b,c,d){var e=[];b=j(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||e.push(a),b()})},function(){d(j(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};f.reject=n(t),f.rejectSeries=p(t);var u=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(){d()})};f.detect=n(u),f.detectSeries=p(u),f.some=function(a,b,c){f.each(a,function(a,d){b(a,function(a){a&&(c(!0),c=function(){}),d()})},function(){c(!1)})},f.any=f.some,f.every=function(a,b,c){f.each(a,function(a,d){b(a,function(a){a||(c(!1),c=function(){}),d()})},function(){c(!0)})},f.all=f.every,f.sortBy=function(a,b,c){f.map(a,function(a,c){b(a,function(b,d){b?c(b):c(null,{value:a,criteria:d})})},function(a,b){if(a)return c(a);var d=function(a,b){var c=a.criteria,d=b.criteria;return d>c?-1:c>d?1:0};c(null,j(b.sort(d),function(a){return a.value}))})},f.auto=function(a,b){b=b||function(){};var c=l(a),d=c.length;if(!d)return b();var e={},g=[],j=function(a){g.unshift(a)},m=function(a){for(var b=0;b<g.length;b+=1)if(g[b]===a)return void g.splice(b,1)},n=function(){d--,i(g.slice(0),function(a){a()})};j(function(){if(!d){var a=b;b=function(){},a(null,e)}}),i(c,function(c){var d=h(a[c])?a[c]:[a[c]],g=function(a){var d=Array.prototype.slice.call(arguments,1);if(d.length<=1&&(d=d[0]),a){var g={};i(l(e),function(a){g[a]=e[a]}),g[c]=d,b(a,g),b=function(){}}else e[c]=d,f.setImmediate(n)},o=d.slice(0,Math.abs(d.length-1))||[],p=function(){return k(o,function(a,b){return a&&e.hasOwnProperty(b)},!0)&&!e.hasOwnProperty(c)};if(p())d[d.length-1](g,e);else{var q=function(){p()&&(m(q),d[d.length-1](g,e))};j(q)}})},f.retry=function(a,b,c){var d=5,e=[];"function"==typeof a&&(c=b,b=a,a=d),a=parseInt(a,10)||d;var g=function(d,g){for(var h=function(a,b){return function(c){a(function(a,d){c(!a||b,{err:a,result:d})},g)}};a;)e.push(h(b,!(a-=1)));f.series(e,function(a,b){b=b[b.length-1],(d||c)(b.err,b.result)})};return c?g():g},f.waterfall=function(a,b){if(b=b||function(){},!h(a)){var c=new Error("First argument to waterfall must be an array of functions");return b(c)}if(!a.length)return b();var d=function(a){return function(c){if(c)b.apply(null,arguments),b=function(){};else{var e=Array.prototype.slice.call(arguments,1),g=a.next();e.push(g?d(g):b),f.setImmediate(function(){a.apply(null,e)})}}};d(f.iterator(a))()};var v=function(a,b,c){if(c=c||function(){},h(b))a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(l(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};f.parallel=function(a,b){v({map:f.map,each:f.each},a,b)},f.parallelLimit=function(a,b,c){v({map:r(b),each:m(b)},a,c)},f.series=function(a,b){if(b=b||function(){},h(a))f.mapSeries(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};f.eachSeries(l(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}},f.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return c<a.length-1?b(c+1):null},d};return b(0)},f.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var w=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};f.concat=n(w),f.concatSeries=p(w),f.whilst=function(a,b,c){a()?b(function(d){return d?c(d):void f.whilst(a,b,c)}):c()},f.doWhilst=function(a,b,c){a(function(d){if(d)return c(d);var e=Array.prototype.slice.call(arguments,1);b.apply(null,e)?f.doWhilst(a,b,c):c()})},f.until=function(a,b,c){a()?c():b(function(d){return d?c(d):void f.until(a,b,c)})},f.doUntil=function(a,b,c){a(function(d){if(d)return c(d);var e=Array.prototype.slice.call(arguments,1);b.apply(null,e)?c():f.doUntil(a,b,c)})},f.queue=function(a,b){function d(a,b,c,d){return a.started||(a.started=!0),h(b)||(b=[b]),0==b.length?f.setImmediate(function(){a.drain&&a.drain()}):void i(b,function(b){var e={data:b,callback:"function"==typeof d?d:null};c?a.tasks.unshift(e):a.tasks.push(e),a.saturated&&a.tasks.length===a.concurrency&&a.saturated(),f.setImmediate(a.process)})}void 0===b&&(b=1);var e=0,g={tasks:[],concurrency:b,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(a,b){d(g,a,!1,b)},kill:function(){g.drain=null,g.tasks=[]},unshift:function(a,b){d(g,a,!0,b)},process:function(){if(!g.paused&&e<g.concurrency&&g.tasks.length){var b=g.tasks.shift();g.empty&&0===g.tasks.length&&g.empty(),e+=1;var d=function(){e-=1,b.callback&&b.callback.apply(b,arguments),g.drain&&g.tasks.length+e===0&&g.drain(),g.process()},f=c(d);a(b.data,f)}},length:function(){return g.tasks.length},running:function(){return e},idle:function(){return g.tasks.length+e===0},pause:function(){g.paused!==!0&&(g.paused=!0,g.process())},resume:function(){g.paused!==!1&&(g.paused=!1,g.process())}};return g},f.priorityQueue=function(a,b){function c(a,b){return a.priority-b.priority}function d(a,b,c){for(var d=-1,e=a.length-1;e>d;){var f=d+(e-d+1>>>1);c(b,a[f])>=0?d=f:e=f-1}return d}function e(a,b,e,g){return a.started||(a.started=!0),h(b)||(b=[b]),0==b.length?f.setImmediate(function(){a.drain&&a.drain()}):void i(b,function(b){var h={data:b,priority:e,callback:"function"==typeof g?g:null};a.tasks.splice(d(a.tasks,h,c)+1,0,h),a.saturated&&a.tasks.length===a.concurrency&&a.saturated(),f.setImmediate(a.process)})}var g=f.queue(a,b);return g.push=function(a,b,c){e(g,a,b,c)},delete g.unshift,g},f.cargo=function(a,b){var c=!1,d=[],e={tasks:d,payload:b,saturated:null,empty:null,drain:null,drained:!0,push:function(a,c){h(a)||(a=[a]),i(a,function(a){d.push({data:a,callback:"function"==typeof c?c:null}),e.drained=!1,e.saturated&&d.length===b&&e.saturated()}),f.setImmediate(e.process)},process:function g(){if(!c){if(0===d.length)return e.drain&&!e.drained&&e.drain(),void(e.drained=!0);var f="number"==typeof b?d.splice(0,b):d.splice(0,d.length),h=j(f,function(a){return a.data});e.empty&&e.empty(),c=!0,a(h,function(){c=!1;var a=arguments;i(f,function(b){b.callback&&b.callback.apply(null,a)}),g()})}},length:function(){return d.length},running:function(){return c}};return e};var x=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(b?console.error&&console.error(b):console[a]&&i(c,function(b){console[a](b)}))}]))}};f.log=x("log"),f.dir=x("dir"),f.memoize=function(a,b){var c={},d={};b=b||function(a){return a};var e=function(){var e=Array.prototype.slice.call(arguments),g=e.pop(),h=b.apply(null,e);h in c?f.nextTick(function(){g.apply(null,c[h])}):h in d?d[h].push(g):(d[h]=[g],a.apply(null,e.concat([function(){c[h]=arguments;var a=d[h];delete d[h];for(var b=0,e=a.length;e>b;b++)a[b].apply(null,arguments)}])))};return e.memo=c,e.unmemoized=a,e},f.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}},f.times=function(a,b,c){for(var d=[],e=0;a>e;e++)d.push(e);return f.map(d,b,c)},f.timesSeries=function(a,b,c){for(var d=[],e=0;a>e;e++)d.push(e);return f.mapSeries(d,b,c)},f.seq=function(){var a=arguments;return function(){var b=this,c=Array.prototype.slice.call(arguments),d=c.pop();f.reduce(a,c,function(a,c,d){c.apply(b,a.concat([function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);d(a,b)}]))},function(a,c){d.apply(b,[a].concat(c))})}},f.compose=function(){return f.seq.apply(null,Array.prototype.reverse.call(arguments))};var y=function(a,b){var c=function(){var c=this,d=Array.prototype.slice.call(arguments),e=d.pop();return a(b,function(a,b){a.apply(c,d.concat([b]))},e)};if(arguments.length>2){var d=Array.prototype.slice.call(arguments,2);return c.apply(this,d)}return c};f.applyEach=n(y),f.applyEachSeries=p(y),f.forever=function(a,b){function c(d){if(d){if(b)return b(d);throw d}a(c)}c()},"undefined"!=typeof b&&b.exports?b.exports=f:"undefined"!=typeof define&&define.amd?define([],function(){return f}):d.async=f}()}).call(this,a("_process"))},{_process:4}],34:[function(a,b){var c=a("./utils").buildPromise,d=a("./EverliveError").EverliveError,e=a("./constants").Platform,f=a("./common"),g=f.jstz,h=f._;b.exports=function(){var a=function(a){this._pushHandler=a,this._initSuccessCallback=null,this._initErrorCallback=null,this._globalFunctionSuffix=null,this.pushSettings=null,this.pushToken=null,this.isInitialized=!1,this.isInitializing=!1,this.emulatorMode=!1};return a.prototype={enableNotifications:function(a,b,d){return this.pushSettings=this._cleanPlatformsPushSettings(a),c(h.bind(this._initialize,this),b,d)},disableNotifications:function(a,b){var d=this;return this.unregister().then(function(){return c(function(a,b){if(d.emulatorMode)a();else{var c,f=window.plugins.pushNotification,g=d._getPlatformType(device.platform);g===e.WindowsPhone&&(c={channelName:d.pushSettings.wp8.channelName}),f.unregister(function(){d.isInitialized=!1,a()},b,c)}},a,b)},b)},getRegistration:function(a,b){var c=encodeURIComponent(this._getDeviceId());return this._pushHandler.devices.getById("HardwareId/"+c,a,b)},register:function(a,b,c){var d=this,e={};return void 0!==a&&(e.Parameters=a),this._populateRegistrationObject(e).then(function(){return d._pushHandler.devices.create(e,b,c)},c)},unregister:function(a,b){var c=encodeURIComponent(device.uuid);return this._pushHandler.devices.destroySingle({Id:"HardwareId/"+c},a,b)},updateRegistration:function(a,b,c){var d=this,e={};return void 0!==a&&(e.Parameters=a),this._populateRegistrationObject(e).then(function(){return e.Id="HardwareId/"+encodeURIComponent(e.HardwareId),d._pushHandler.devices.updateSingle(e,b,c)},c)},_initializeInteractivePush:function(a,b,c){var d=window.plugins.pushNotification,e=a.interactiveSettings,f=[];a.alert&&f.push(d.UserNotificationTypes.Alert),a.badge&&f.push(d.UserNotificationTypes.Badge),a.sound&&f.push(d.UserNotificationTypes.Sound);var g=function(a){var b=h.find(e.actions,function(b){return b.identifier===a});return b},i=h.map(e.categories,function(a){return{identifier:a.identifier,actionsForDefaultContext:h.map(a.actionsForDefaultContext,g),actionsForMinimalContext:h.map(a.actionsForMinimalContext,g)}});d.registerUserNotificationSettings(b,c,{types:f,categories:i})},_initialize:function(a,b){var c=this;if(this.isInitializing)return void b(new d("Push notifications are currently initializing."));if(!(this.emulatorMode||window.navigator&&window.navigator.globalization))return void b(new d("The globalization plugin is not initialized."));if(!(this.emulatorMode||window.plugins&&window.plugins.pushNotification))return void b(new d("The push notifications plugin is not initialized."));if(this._initSuccessCallback=a,this._initErrorCallback=b,this.isInitialized)return void this._deviceRegistrationSuccess(this.pushToken);if(this.emulatorMode)return void setTimeout(function(){c._deviceRegistrationSuccess("fake_push_token")},1e3);this.isInitializing=!0;var f=this._globalFunctionSuffix;f||(f=Date.now().toString(),this._globalFunctionSuffix=f);var g=window.plugins.pushNotification,i=this._getPlatformType(device.platform);if(i===e.iOS){var j="apnCallback_"+f;Everlive.PushCallbacks[j]=h.bind(this._onNotificationAPN,this);var k=this.pushSettings.iOS;this._validateIOSSettings(k),k.ecb="Everlive.PushCallbacks."+j,g.register(h.bind(this._successfulRegistrationAPN,this),h.bind(this._failedRegistrationAPN,this),k)}else if(i===e.Android){var l="gcmCallback_"+f;Everlive.PushCallbacks[l]=h.bind(this._onNotificationGCM,this);var m=this.pushSettings.android;this._validateAndroidSettings(m),m.ecb="Everlive.PushCallbacks."+l,g.register(h.bind(this._successSentRegistrationGCM,this),h.bind(this._errorSentRegistrationGCM,this),m)}else{if(i!==e.WindowsPhone)throw new d("The current platform is not supported: "+device.platform);var n="wp8Callback_"+f,o="wp8RegistrationSuccessCallback_"+f,p="wp8RegistrationErrorCallback_"+f;Everlive.PushCallbacks[n]=h.bind(this._onNotificationWP8,this),Everlive.PushCallbacks[o]=h.bind(this._deviceRegistrationSuccessWP,this),Everlive.PushCallbacks[p]=h.bind(this._deviceRegistrationFailed,this);var q=this.pushSettings.wp8;this._validateWP8Settings(q),q.ecb="Everlive.PushCallbacks."+n,q.uccb="Everlive.PushCallbacks."+o,q.errcb="Everlive.PushCallbacks."+p,g.register(h.bind(this._successSentRegistrationWP8,this),h.bind(this._errorSentRegistrationWP8,this),q)}},_deviceRegistrationSuccessWP:function(a){this._deviceRegistrationSuccess(a.uri)},_validateAndroidSettings:function(a){if(!a.senderID)throw new d("Sender ID (project number) is not set in the android settings.")},_validateWP8Settings:function(a){if(!a.channelName)throw new d("channelName is not set in the WP8 settings.")},_validateIOSSettings:function(){},_cleanPlatformsPushSettings:function(a){var b={};a=a||{};var c=function(b,c,d){if(a[c]){b[c]=b[c]||{};var e=a[c],f=b[c];h.each(d,function(a){e.hasOwnProperty(a)&&(f[a]=e[a])})}};c(b,"iOS",["badge","sound","alert","interactiveSettings"]),c(b,"android",["senderID","projectNumber"]),c(b,"wp8",["channelName"]);var e=["notificationCallbackAndroid","notificationCallbackIOS","notificationCallbackWP8"];return h.each(e,function(c){var e=a[c];if(e){if("function"!=typeof e)throw new d('The "'+c+'" of the push settings should be a function');b[c]=a[c]}}),a.customParameters&&(b.customParameters=a.customParameters),b},_populateRegistrationObject:function(a,b,e){var f=this;return c(function(b,c){if(!f.pushToken)throw new d("Push token is not available.");f._getLocaleName(function(c){var d=f._getDeviceId(),e=device.model,h=f._getPlatformType(device.platform),i=g.determine().name(),j=f.pushToken,k=c.value,l=device.version;a.HardwareId=d,a.HardwareModel=e,a.PlatformType=h,a.PlatformVersion=l,a.TimeZone=i,a.PushToken=j,a.Locale=k,b()},c)},b,e)},_getLocaleName:function(a,b){this.emulatorMode?a({value:"en_US"}):(navigator.globalization.getLocaleName(function(b){a(b)},b),navigator.globalization.getLocaleName(function(){},b))},_getDeviceId:function(){return device.uuid},_getPlatformType:function(a){var b=a.toLowerCase();switch(b){case"ios":case"iphone":case"ipad":return e.iOS;case"android":return e.Android;case"wince":return e.WindowsPhone;case"win32nt":return e.WindowsPhone;default:return e.Unknown}},_deviceRegistrationFailed:function(a){this.pushToken=null,this.isInitializing=!1,this.isInitialized=!1,this._initErrorCallback&&this._initErrorCallback({error:a})},_deviceRegistrationSuccess:function(a){this.pushToken=a,this.isInitializing=!1,this.isInitialized=!0,this._initSuccessCallback&&this._initSuccessCallback({token:a})},_successfulRegistrationAPN:function(a){var b=this;this.pushSettings.iOS&&this.pushSettings.iOS.interactiveSettings?this._initializeInteractivePush(this.pushSettings.iOS,function(){b._deviceRegistrationSuccess(a)},function(a){throw new d("The interactive push configuration is incorrect: "+a)}):this._deviceRegistrationSuccess(a)},_failedRegistrationAPN:function(a){this._deviceRegistrationFailed(a)},_successSentRegistrationGCM:function(){},_successSentRegistrationWP8:function(){},_errorSentRegistrationWP8:function(a){this._deviceRegistrationFailed(a)},_errorSentRegistrationGCM:function(a){this._deviceRegistrationFailed(a)},_onNotificationAPN:function(a){this._raiseNotificationEventIOS(a)},_onNotificationWP8:function(a){this._raiseNotificationEventWP8(a)},_onNotificationGCM:function(a){switch(a.event){case"registered":a.regid.length>0&&this._deviceRegistrationSuccess(a.regid);break;case"message":this._raiseNotificationEventAndroid(a);break;case"error":this.pushToken?this._raiseNotificationEventAndroid(a):this._deviceRegistrationFailed(a);break;default:this._raiseNotificationEventAndroid(a)}},_raiseNotificationEventAndroid:function(a){this.pushSettings.notificationCallbackAndroid&&this.pushSettings.notificationCallbackAndroid(a)},_raiseNotificationEventIOS:function(a){this.pushSettings.notificationCallbackIOS&&this.pushSettings.notificationCallbackIOS(a)},_raiseNotificationEventWP8:function(a){this.pushSettings.notificationCallbackWP8&&this.pushSettings.notificationCallbackWP8(a)}},a}()},{"./EverliveError":36,"./common":46,"./constants":47,"./utils":66}],35:[function(a,b){var c=a("./Setup"),d=a("./types/Data"),e=a("./types/Users"),f=a("./types/Files"),g=a("./constants"),h=a("./utils"),i=h.buildAuthHeader,j=a("./Push"),k=a("./auth/Authentication"),l=a("./offline/offline"),m=a("./Request"),n=a("./common"),o=(n.rsvp,n._),p=a("./EverliveError").EverliveError,q=a("./EverliveError").EverliveErrors,r=a("events").EventEmitter;b.exports=function(){function a(b){var d=this;this.setup=new c(b),o.each(n,function(a){a.func.call(d,b)}),null===a.$&&(a.$=d),this._emitter=new r}function b(){if(!this._isOfflineStorageEnabled())throw new p("You have instantiated the SDK without support for offline storage")}a.prototype._emitterProxy=function(a,b){this._emitter[a].apply(this._emitter,b)},a.prototype.addListener=function(){this._emitterProxy("addListener",arguments)},a.prototype.on=a.prototype.addListener,a.prototype.removeListener=function(){this._emitterProxy("removeListener",arguments)},a.prototype.off=a.prototype.removeListener,a.prototype.once=function(){this._emitterProxy("once",arguments)},a.prototype.removeAllListeners=function(){this._emitterProxy("removeAllListeners",arguments)},a.$=null,a.idField=g.idField;var n=[];a.initializations=n,a.init=function(b){return a.$=null,new a(b)},a.prototype.data=function(a){return new d(this.setup,a,this.offlineStorage,this)},a.prototype.buildUrl=function(){return h.buildUrl(this.setup)},a.prototype.buildAuthHeader=function(){return i(this.setup)},a.disableRequestCache=function(a,b){if("GET"===b){var c=(new Date).getTime(),d=a.indexOf("?")>-1?"&":"?";a+=d+"_el="+c}return a},a.AuthStatus=g.AuthStatus,a.prototype.authInfo=function(b,c){var d=this;return h.buildPromise(function(b,c){var e=d.setup;return e.masterKey?b({status:a.AuthStatus.masterKey}):e.token?d.authentication&&d.authentication.isAuthenticationInProgress()?b({status:a.AuthStatus.authenticating}):void d.Users.skipAuth(!0).currentUser().then(function(c){return b({status:a.AuthStatus.authenticated,user:c.result})},function(e){return d.authentication&&d.authentication.isAuthenticationInProgress()?b({status:a.AuthStatus.authenticating}):e.code===q.invalidRequest.code||e.code===q.expiredToken.code?b({status:a.AuthStatus.invalidAuthentication}):c(e)}):b({status:a.AuthStatus.unauthenticated})},b,c)},a.prototype.request=function(a){return new m(this.setup,a)},a.prototype._isOfflineStorageEnabled=function(){return!!this.setup.offlineStorage},a.prototype.offline=function(){b.call(this);var a;a=0===arguments.length?!0:1==arguments[0],this.offlineStorage._setOffline(a)},a.prototype.online=function(){b.call(this);var a;a=0===arguments.length?!0:1==arguments[0],this.offlineStorage._setOffline(!a)},a.prototype.isOffline=function(){return b.call(this),!this.isOnline()},a.prototype.isOnline=function(){return b.call(this),this.offlineStorage.isOnline()},a.prototype.sync=function(){return b.call(this),this.offlineStorage.sync.apply(this.offlineStorage,arguments)};var s=function(){this.Users=this.data("Users"),e.addUsersFunctions(this.Users,this),this.Files=this.data("Files"),f.addFilesFunctions(this.Files),this.push=new j(this)},t=function(){this.authentication=new k(this,this.setup.authentication)};return n.push({name:"offlineStorage",func:l.initOfflineStorage}),n.push({name:"default",func:s}),n.push({name:"authentication",func:t}),a}()},{"./EverliveError":36,"./Push":41,"./Request":42,"./Setup":43,"./auth/Authentication":44,"./common":46,"./constants":47,"./offline/offline":53,"./types/Data":63,"./types/Files":64,"./types/Users":65,"./utils":66,events:2}],36:[function(a,b){var c={itemNotFound:{code:801,message:"Item not found."},syncConflict:{code:4242,message:"A conflict occurred while syncing data."},syncError:{code:4243,message:"Synchronization failed for item."},syncInProgress:{code:4244,message:"Cannot perform operation while synchronization is in progress"},generalDatabaseError:{code:107,message:"General database error"},invalidToken:{code:301,message:"Invalid access token"},expiredToken:{code:302,message:"Expired access token"},invalidExpandExpression:{code:618,message:"Invalid expand expression."},invalidRequest:{code:601,message:"Invalid request."}},d=function(){function a(a,b){var c=Error.apply(this,arguments);return c.name=this.name="EverliveError",this.message=c.message,this.code=b,Object.defineProperty(this,"stack",{get:function(){return c.stack}}),this}return a.prototype=Object.create(Error.prototype),a.prototype.toJSON=function(){return{name:this.name,message:this.message,code:this.code,stack:this.stack}},a}(),e=function(){var a=function(a,b,c){d.call(this,b),this.errorType=a,this.message=b,void 0!==c&&(this.additionalInformation=c)};a.prototype=Object.create(d.prototype),a.fromEverliveError=function(c){var d=new a(b.EverliveError,c.message,c);return d},a.fromPluginError=function(c){var d="A plugin error occurred";c&&("string"==typeof c.error?d=c.error:"string"==typeof c.message&&(d=c.message));var e=new a(b.PluginError,d,c);return e};var b={EverliveError:1,PluginError:2};return a}();b.exports={EverliveError:d,EverliveErrors:c,DeviceRegistrationError:e}},{}],37:[function(a,b){{var c=a("./common").Processor,d=a("./query/DataQuery"),e=a("./query/Query");a("./EverliveError").EverliveError}b.exports=function(){return new c({executionNodeFunction:function(a,b,c){var f=new d({operation:d.operations.read,collectionName:a.targetTypeName,filter:new e(a.filter,a.select,a.sort,a.skip,a.take)});b.offlineModule.processQuery(f).then(function(a){c(null,a.result)},c)}})}()},{"./EverliveError":36,"./common":46,"./query/DataQuery":56,"./query/Query":57}],38:[function(a,b){b.exports=function(){function a(a,b){this.operator=a,this.operands=b||[]}return a.prototype={addOperand:function(a){this.operands.push(a)}},a}()},{}],39:[function(a,b){b.exports=function(){function a(a,b){this.longitude=a||0,this.latitude=b||0}return a}()},{}],40:[function(a,b){{var c=a("./everlive.platform"),d=c.isNativeScript,e=c.isNodejs;a("./constants")}b.exports=function(){"use strict";function b(b){if(d){var c=a("application-settings");return{getItem:function(a){return c.getString(a)},removeItem:function(a){return c.remove(a)},setItem:function(a,b){return c.setString(a,b)}}}var f;if(e){var g=a("node-localstorage").LocalStorage;f=new g(b.offlineStorage.setup.storage.storagePath)}else f=window.localStorage;return{getItem:function(a){return f.getItem(a)},removeItem:function(a){return f.removeItem(a)},setItem:function(a,b){return f.setItem(a,b)}}}function c(a){this.sdk=a,this._localStorage=b(this.sdk)}return c.prototype={getItem:function(a){return this._localStorage.getItem(a)},removeItem:function(a){return this._localStorage.removeItem(a)},setItem:function(a,b){return this._localStorage.setItem(a,b)}},c}()},{"./constants":47,"./everlive.platform":49,"application-settings":"application-settings","node-localstorage":"node-localstorage"}],41:[function(a,b){var c=a("./utils"),d=c.buildPromise,e=c.DeviceRegistrationResult,f=a("./EverliveError"),g=f.DeviceRegistrationError,h=f.EverliveError,i=a("./CurrentDevice"),j=a("./constants").Platform;b.exports=function(){function a(a){this._el=a,this.notifications=a.data("Push/Notifications"),this.devices=a.data("Push/Devices")}return a.prototype={ensurePushIsAvailable:function(){var a="undefined"!=typeof window&&window.plugins&&window.plugins.pushNotification;if(!a)throw new h("The push notification plugin is not available. Ensure that the pushNotification plugin is included and use after `deviceready` event has been fired.")},currentDevice:function(a){if(this.ensurePushIsAvailable(),0===arguments.length&&(a=this._el.setup._emulatorMode),!window.cordova)throw new h("Error: currentDevice() can only be called from within a hybrid mobile app, after 'deviceready' event has been fired.");return this._currentDevice||(this._currentDevice=new i(this)),this._currentDevice.emulatorMode=a,this._currentDevice},register:function(a,b,c){this.ensurePushIsAvailable();var f=this.currentDevice(),h=this;a=a||{},a.android&&(a.android.senderID=a.android.projectNumber||a.android.senderID);var i=function(a,b){var c=new e(a);b(c)},k=function(a,b){var c=g.fromEverliveError(a);b(c)},l=function(b,c,d){var e=f._getPlatformType(device.platform),g=e===j.iOS;g&&a.iOS&&(g=a.iOS.clearBadge!==!1),g?h.clearBadgeNumber().then(function(){i(b,c)},function(a){k(a,d)}):i(b,c)};return d(function(b,c){f.enableNotifications(a,function(d){var e=d.token,g=a.customParameters;f.getRegistration().then(function(){f.updateRegistration(g,function(){l(e,b,c)},function(a){k(a,c)})},function(a){801===a.code?f.register(g,function(){l(e,b,c)},c):k(a,c)})},function(a){var b=g.fromPluginError(a);c(b)})},b,c)},unregister:function(){this.ensurePushIsAvailable();var a=this.currentDevice();return a.disableNotifications.apply(a,arguments)},updateRegistration:function(){this.ensurePushIsAvailable();var a=this.currentDevice();return a.updateRegistration.apply(a,arguments)},setBadgeNumber:function(a,b,c){if(this.ensurePushIsAvailable(),a=parseInt(a),isNaN(a))return d(function(a,b){b(new h("The badge must have a numeric value"))},b,c);var e={},f=this.currentDevice(),g=f._getDeviceId();return e.Id="HardwareId/"+encodeURIComponent(g),e.BadgeCounter=a,d(function(b,c){f._pushHandler.devices.updateSingle(e).then(function(){return window.plugins&&window.plugins.pushNotification?window.plugins.pushNotification.setApplicationIconBadgeNumber(b,c,a):b()},c)},b,c)},clearBadgeNumber:function(a,b){return this.ensurePushIsAvailable(),this.setBadgeNumber(0,a,b)},getRegistration:function(){this.ensurePushIsAvailable();var a=this.currentDevice();return a.getRegistration.apply(a,arguments)},send:function(){return this.ensurePushIsAvailable(),this.notifications.create.apply(this.notifications,arguments)},areNotificationsEnabled:function(a,b,c){this.ensurePushIsAvailable(),a=a||{};var e=window.plugins.pushNotification;return d(function(b,c){e.areNotificationsEnabled(b,c,a)},b,c)}},a}()},{"./CurrentDevice":34,"./EverliveError":36,"./constants":47,"./utils":66}],42:[function(a,b){var c=a("./utils"),d=(a("./common").rsvp,c.buildAuthHeader),e=c.parseUtilities,f=c.guardUnset,g=a("./common"),h=g.reqwest,i=g._,j=a("./constants").Headers,k=a("./everlive.platform").isNodejs;b.exports=function(){function a(c,d){f(c,"setup"),f(d,"options"),this.setup=c,this.method=null,this.endpoint=null,this.data=null,this.headers={},this.success=null,this.error=null,this.parse=a.parsers.simple,i.extend(this,d),b=this,this._init(d)}var b;a.prototype={send:function(){a.sendRequest(this)},buildAuthHeader:d,buildUrl:function(a){return c.buildUrl(a)},buildQueryHeaders:function(b){return b?b instanceof Everlive.Query?a.prototype._buildQueryHeaders(b):a.prototype._buildFilterHeader(b):{}},_init:function(a){i.extend(this.headers,this.buildAuthHeader(this.setup,a),this.buildQueryHeaders(a.filter),a.headers)},_buildQueryHeaders:function(a){a=a.build();var b={};return null!==a.$where&&(b[j.filter]=JSON.stringify(a.$where)),null!==a.$select&&(b[j.select]=JSON.stringify(a.$select)),null!==a.$sort&&(b[j.sort]=JSON.stringify(a.$sort)),null!==a.$skip&&(b[j.skip]=a.$skip),null!==a.$take&&(b[j.take]=a.$take),null!==a.$expand&&(b[j.expand]=JSON.stringify(a.$expand)),b},_buildFilterHeader:function(a){var b={};return b[j.filter]=JSON.stringify(a),b}};var g=b&&b.setup&&b.setup.parseOnlyCompleteDateTimeObjects,l=e.getReviver(g);return a.parsers={simple:{result:e.parseResult.bind(null,l),error:e.parseError.bind(null,l)},single:{result:e.parseSingleResult.bind(null,l),error:e.parseError.bind(null,l)},update:{result:e.parseUpdateResult.bind(null,l),error:e.parseError.bind(null,l)}},"undefined"==typeof a.sendRequest&&(a.sendRequest=function(a){var b=a.buildUrl(a.setup)+a.endpoint;b=Everlive.disableRequestCache(b,a.method);var c="GET"===a.method?a.data:JSON.stringify(a.data),d={url:b,method:a.method,data:c,headers:a.headers,contentType:"application/json"};k?(d.success=function(b,c){a.success.call(a,a.parse.result(b),c)},d.error=function(b){a.error.call(a,a.parse.error(b.responseText||b.statusText))}):(d.type="json",d.crossOrigin=!0,d.success=function(b){var c=a.parse.result(b);a.success.call(a,c)},d.error=function(b){var c=a.parse.error(b.responseText||b.statusText);a.error.call(a,c)}),h(d)}),a}()},{"./common":46,"./constants":47,"./everlive.platform":49,"./utils":66}],43:[function(a,b){var c=a("./common")._,d=a("./constants"),e=a("./auth/AuthenticationSetup");b.exports=function(){function a(a){this.url=b,this.apiKey=null,this.masterKey=null,this.token=null,
this.tokenType=null,this.principalId=null,this.scheme="http",this.parseOnlyCompleteDateTimeObjects=!1,"string"==typeof a?this.apiKey=a:(this._emulatorMode=a.emulatorMode,c.extend(this,a)),this.authentication=new e(this,a.authentication)}var b=d.everliveUrl;return a.prototype.setAuthorizationProperties=function(a,b,c){this.token=a,this.tokenType=b,this.principalId=c},a.prototype.getAuthorizationProperties=function(){return{token:this.token,tokenType:this.tokenType,principalId:this.principalId}},a}()},{"./auth/AuthenticationSetup":45,"./common":46,"./constants":47}],44:[function(a,b){"use strict";var c=a("../utils"),d=a("../query/DataQuery"),e=a("../Request"),f=(a("../Everlive"),a("../constants")),g="Users",h=c.buildPromise,i=a("../LocalStore"),j=a("../EverliveError").EverliveErrors;b.exports=function(){var a=function(a,b){if(this.authSetup=b||{},this._el=a,this._authenticationCallbacks=null,this._localStore=new i(a),this.authSetup.persist){var c,d=this,e=this._getLocalStoreKey(),f=this._localStore.getItem(e);f&&(c=JSON.parse(this._localStore.getItem(e))),c&&d._el.setup.setAuthorizationProperties(c.token,c.tokenType,c.principalId)}};return a.prototype.login=function(a,b,c,e){var f=this;return h(function(c,e){var h=function(){f._loginSuccess.apply(f,arguments),c.apply(null,arguments)},i=new d({operation:d.operations.userLogin,collectionName:g,data:{username:a,password:b,grant_type:"password"},skipAuth:!0,onSuccess:h,onError:e});return f._el.Users.processDataQuery(i)},c,e)},a.prototype.logout=function(a,b){var c=this;return h(function(a,b){var e=function(){c._logoutSuccess.apply(c,arguments),a.apply(null,arguments)},f=function(a){301===a.code&&c.clearAuthorization(),b.apply(null,arguments)},h=new d({operation:d.operations.userLogout,collectionName:g,skipAuth:!0,onSuccess:e,onError:f});return c._el.Users.processDataQuery(h)},a,b)},a.prototype._getLocalStoreKey=function(){return f.AuthStoreKey+this._el.setup.apiKey+"$authentication"},a.prototype.loginWithFacebook=function(a,b,c){var d={Provider:"Facebook",Token:a};return this._loginWithProvider(d,b,c)},a.prototype.loginWithADFS=function(a,b,c){var d={Provider:"ADFS",Token:a};return this._loginWithProvider(d,b,c)},a.prototype.loginWithLiveID=function(a,b,c){var d={Provider:"LiveID",Token:a};return this._loginWithProvider(d,b,c)},a.prototype.loginWithGoogle=function(a,b,c){var d={Provider:"Google",Token:a};return this._loginWithProvider(d,b,c)},a.prototype.loginWithTwitter=function(a,b,c,d){var e={Provider:"Twitter",Token:a,TokenSecret:b};return this._loginWithProvider(e,c,d)},a.prototype.setAuthorization=function(a,b,c){if(this._el.setup.setAuthorizationProperties(a,b,c),this.authSetup.persist){var d=this._getLocalStoreKey(),e=this._el.setup.getAuthorizationProperties();this._localStore.setItem(d,JSON.stringify(e))}this._authenticationCallbacks&&(this._authenticationCallbacks.success(),this._authenticationCallbacks=null)},a.prototype.clearAuthorization=function(){this.setAuthorization(null,null,null),this.clearPersistedAuthentication()},a.prototype.clearPersistedAuthentication=function(){if(this._localStore){var a=this._getLocalStoreKey();this._localStore.removeItem(a)}},a.prototype.isAuthenticationInProgress=function(){return"function"==typeof this.authSetup.onAuthenticationRequired},a.prototype._ensureAuthentication=function(){if(!this.isAuthenticationInProgress())throw new Error("onAuthenticationRequired option of Everlive.Setup.Authentication is required.");return this.isAuthenticating()?this._authenticationCallbacks.promise:(this.clearAuthorization(),this.authSetup.onAuthenticationRequired.call(this),this._authenticationCallbacks=c.getCallbacks(),this._authenticationCallbacks.promise)},a.prototype.completeAuthentication=function(a){this._el.setAuthorization(a.access_token,a.token_type,a.principal_id)},a.prototype.getAuthenticationStatus=function(a,b){var d=this;return c.buildPromise(function(a,b){var c=d._el.setup;return c.masterKey?a({status:f.AuthStatus.masterKey}):c.token?d.isAuthenticationInProgress()?a({status:f.AuthStatus.authenticating}):void d._el.Users.skipAuth(!0).currentUser().then(function(b){return a({status:f.AuthStatus.authenticated,user:b.result})},function(c){return d.isAuthenticationInProgress()?a({status:f.AuthStatus.authenticating}):c.code===j.invalidRequest.code||c.code===j.invalidToken.code?a({status:f.AuthStatus.invalidAuthentication}):c.code===j.expiredToken.code?a({status:f.AuthStatus.expiredAuthentication}):b(c)}):a({status:f.AuthStatus.unauthenticated})},a,b)},a.prototype.isAuthenticating=function(){return!!this._authenticationCallbacks},a.prototype._loginSuccess=function(a){var b=a.result;this.setAuthorization(b.access_token,b.token_type,b.principal_id)},a.prototype._logoutSuccess=function(){this.clearAuthorization()},a.prototype._loginWithProvider=function(a,b,c){var f={Identity:a},i=this;return h(function(a,b){var c=function(){i._loginSuccess.apply(i,arguments),a.apply(null,arguments)},h=new d({operation:d.operations.userLoginWithProvider,collectionName:g,data:f,authHeaders:!1,skipAuth:!0,parse:e.parsers.single,onSuccess:c,onError:b});i._el.Users.processDataQuery(h)},b,c)},a}()},{"../Everlive":35,"../EverliveError":36,"../LocalStore":40,"../Request":42,"../constants":47,"../query/DataQuery":56,"../utils":66}],45:[function(a,b){"use strict";var c=function(a,b){b=b||{},this.onAuthenticationRequired=b.onAuthenticationRequired,this.persist=b.persist};b.exports=c},{}],46:[function(a,b){(function(c){b.exports=function(){var b={},d=a("./everlive.platform"),e=d.isNativeScript,f=d.isNodejs;f||e?e?(b.root=c,b.reqwest=a("./reqwest.nativescript")):f&&(b.root=c,b.reqwest=a("./reqwest.nodejs")):b.reqwest=a("reqwest"),b.root||(b.root=window);var g=function(a,c){c||(c=a),Object.keys(b[c]).length||(b[c]=b.root[a])};return b._=a("underscore"),g("_"),b.jstz=a("jstimezonedetect").jstz,g("jstz"),b.mongoQuery=a("mongo-query"),g("mongoQuery"),b.Mingo=a("mingo"),g("Mingo"),b.uuid=a("uuid"),g("uuid"),b.Processor=a("../scripts/bs-expand-processor"),g("Processor"),b.rsvp=a("rsvp"),g("RSVP","rsvp"),f||e||g("reqwest"),b}()}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../scripts/bs-expand-processor":30,"./everlive.platform":49,"./reqwest.nativescript":61,"./reqwest.nodejs":62,jstimezonedetect:1,mingo:1,"mongo-query":8,reqwest:1,rsvp:1,underscore:1,uuid:1}],47:[function(a,b){var c={idField:"Id",guidEmpty:"00000000-0000-0000-0000-000000000000",everliveUrl:"//api.everlive.com/v1/",ConflictResolutionStrategy:{ClientWins:"clientWins",ServerWins:"serverWins",Custom:"custom"},ConflictResolution:{KeepServer:"keepServer",KeepClient:"keepClient",Custom:"custom"},StorageProvider:{LocalStorage:"localStorage",FileSystem:"fileSystem",Custom:"custom"},DefaultStoragePath:"el_store/",EncryptionProvider:{Default:"default",Custom:"custom"},Headers:{filter:"X-Everlive-Filter",select:"X-Everlive-Fields",sort:"X-Everlive-Sort",skip:"X-Everlive-Skip",take:"X-Everlive-Take",expand:"X-Everlive-Expand",singleField:"X-Everlive-Single-Field",includeCount:"X-Everlive-Include-Count",powerFields:"X-Everlive-Power-Fields",debug:"X-Everlive-Debug",overrideSystemFields:"X-Everlive-Override-System-Fields"},Platform:{WindowsPhone:1,Windows:2,Android:3,iOS:4,OSX:5,Blackberry:6,Nokia:7,Unknown:100},OperatorType:{query:1,where:100,filter:101,and:110,or:111,not:112,equal:120,not_equal:121,lt:122,lte:123,gt:124,gte:125,isin:126,notin:127,all:128,size:129,regex:130,contains:131,startsWith:132,endsWith:133,nearShpere:140,withinBox:141,withinPolygon:142,withinShpere:143,select:200,exclude:201,order:300,order_desc:301,skip:400,take:401,expand:402},AuthStatus:{unauthenticated:"unauthenticated",masterKey:"masterKey",invalidAuthentication:"invalidAuthentication",authenticated:"authenticated",expiredAuthentication:"expiredAuthentication",authenticating:"authenticating"},offlineItemStates:{created:"created",modified:"modified",deleted:"deleted"},HttpMethod:{GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE"},maxDistanceConsts:{radians:"$maxDistance",km:"$maxDistanceInKilometers",miles:"$maxDistanceInMiles"},radiusConsts:{radians:"radius",km:"radiusInKilometers",miles:"radiusInMiles"}};c.offlineItemsStateMarker="__everlive_offline_state",c.SyncErrors={generalError:"generalError",itemSyncError:"itemSyncError"},c.syncBatchSize=10,c.AuthStoreKey="__everlive_auth_key",c.defaultSyncInterval=6e5,b.exports=c},{}],48:[function(a,b){var c=a("node-cryptojs-aes").CryptoJS,d=c.AES;b.exports=function(){function a(a){this.sdk=a}return a.prototype={_getKey:function(){return this.sdk.offlineStorage.setup.encryption.key},_canEncryptDecrypt:function(a){return this._getKey()&&null!==a&&void 0!==a},encrypt:function(a){return this._canEncryptDecrypt(a)?d.encrypt(a,this._getKey()).toString():a},decrypt:function(a){return this._canEncryptDecrypt(a)?d.decrypt(a,this._getKey()).toString(c.enc.Utf8):a}},a}()},{"node-cryptojs-aes":19}],49:[function(a,b,c){(function(a){var d=Boolean("undefined"!=typeof android&&android&&android.widget&&android.widget.Button||"undefined"!=typeof UIButton&&UIButton);if(d)a.isNativeScriptApplication=d,a.isCordovaApplication=!1,a.window={localStorage:{removeItem:function(){}}};else if("undefined"!=typeof window)var e=/^file:\/{3}[^\/]/i.test(window.location.href)&&/ios|iphone|ipod|ipad|android/i.test(navigator.userAgent);var f="object"==typeof c&&"undefined"==typeof window,g="function"==typeof define&&define.amd;b.exports={isCordova:e,isNativeScript:d,isNodejs:f,isRequirejs:g}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],50:[function(a,b,c){/*!
 The MIT License (MIT)
 Copyright (c) 2013 Telerik AD
 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:
 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.
 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.y distributed under the MIT license.
 */
/*!
 Everlive SDK
 Version 1.3.0
 */
!function(){var d=a("./Everlive"),e=a("./everlive.platform"),f=a("./common");if(f.root.Everlive=d,!e.isNativeScript&&!e.isNodejs){var g=a("./kendo/kendo.everlive");d.createDataSource=g.createDataSource,d.createHierarchicalDataSource=g.createHierarchicalDataSource}d.PushCallbacks={},d.Offline={},d.Query=a("./query/Query"),d.QueryBuilder=a("./query/QueryBuilder"),d.GeoPoint=a("./GeoPoint"),d.Constants=a("./constants"),d.Request=a("./Request"),d.Data=a("./types/Data"),d._utils=a("./utils"),d._traverseAndRevive=d._utils.parseUtilities.traverseAndRevive,d._common=a("./common");var h=a("./offline/offlinePersisters");d.persister={LocalStorage:h.LocalStoragePersister,FileSystem:h.FileSystemPersister},"object"==typeof c&&(b.exports=f.root.Everlive)}()},{"./Everlive":35,"./GeoPoint":39,"./Request":42,"./common":46,"./constants":47,"./everlive.platform":49,"./kendo/kendo.everlive":51,"./offline/offlinePersisters":54,"./query/Query":57,"./query/QueryBuilder":58,"./types/Data":63,"./utils":66}],51:[function(a,b){var c=a("../query/QueryBuilder"),d=a("../query/Query"),e=(a("../Request"),a("../constants")),f=a("../common")._,g=a("../Everlive"),h=a("../EverliveError").EverliveError;!function(){function a(a){var b={};if(a){if(a.skip&&(b.$skip=a.skip,delete a.skip),a.take&&(b.$take=a.take,delete a.take),a.sort){var c=a.sort,d={};i.isArray(c)||(c=[c]),i.each(c,function(a,b){d[b.field]="asc"===b.dir?1:-1}),b.$sort=d,delete a.sort}if(a.filter){var e=n.build(a.filter);b.$where=e,delete a.filter}}return b}if(("undefined"==typeof window||"undefined"!=typeof window.jQuery)&&"undefined"!=typeof window.kendo){var i=window.jQuery,j=window.kendo,k=i.extend,l=j.data.RemoteTransport.extend({init:function(a){if(this.everlive$=a.dataProvider||g.$,!this.everlive$)throw new Error("An instance of the Backend services sdk must be provided.");if(!a.typeName)throw new Error("A type name must be provided.");this.headers=a.headers,this.dataCollection=this.everlive$.data(a.typeName),j.data.RemoteTransport.fn.init.call(this,a)},read:function(b){var c=this.options.read;if(c&&c.url)return j.data.RemoteTransport.fn.read.call(this,b);var e;c&&c.headers&&(e=c.headers);var f=a(b.data),g=new d(f.$where,null,f.$sort,f.$skip,f.$take),h=b.data.Id;h?this.dataCollection.withHeaders(this.headers).withHeaders(e).getById(h).then(b.success,b.error):this.dataCollection.withHeaders(this.headers).withHeaders(e).get(g).then(b.success,b.error)},update:function(a){var b=this.options.update;if(b&&b.url)return j.data.RemoteTransport.fn.read.call(this,a);var c;b&&b.headers&&(c=b.headers);var d=f.isArray(a.data.models);if(d)throw new Error("Batch update is not supported.");var e=a.data;return this.dataCollection.withHeaders(this.headers).withHeaders(c).updateSingle(e).then(a.success.bind(this,e),a.error)},create:function(a){var b=this.options.create;if(b&&b.url)return j.data.RemoteTransport.fn.read.call(this,a);var c;b&&b.headers&&(c=b.headers);var d=f.isArray(a.data.models),e=d?a.data.models:a.data;return this.dataCollection.withHeaders(this.headers).withHeaders(c).create(e).then(a.success.bind(this,e),a.error)},destroy:function(a){var b=this.options.destroy;if(b&&b.url)return j.data.RemoteTransport.fn.read.call(this,a);var c;b&&b.headers&&(c=b.headers);var d=f.isArray(a.data.models);if(d)throw new Error("Batch destroy is not supported.");return this.dataCollection.withHeaders(this.headers).withHeaders(c).destroy(a.data).then(a.success,a.error)}});i.extend(!0,j.data,{transports:{everlive:l},schemas:{everlive:{type:"json",total:function(a){return a.hasOwnProperty("count")?a.count:a.Count},data:function(a){return a.result||g._traverseAndRevive(a.Result)||a},model:{id:e.idField}}}});var m=["startswith","startsWith","endswith","endsWith","contains"],n={build:function(a){return n._build(a)},_build:function(a){return n._isRaw(a)?n._raw(a):n._isSimple(a)?n._simple(a):n._isRegex(a)?n._regex(a):n._isAnd(a)?n._and(a):n._isOr(a)?n._or(a):void 0},_isRaw:function(a){return"_raw"===a.operator},_raw:function(a){var b={};return b[a.field]=a.value,b},_isSimple:function(a){return"undefined"==typeof a.logic&&!n._isRegex(a)},_simple:function(a){var b={},c={},d=n._translateoperator(a.operator);return d?b[d]=a.value:b=a.value,c[a.field]=b,c},_isRegex:function(a){return-1!==i.inArray(a.operator,m)},_regex:function(a){var b={},c=n._getRegex(a);return b[a.field]=n._getRegexValue(c),b},_getRegex:function(a){var b=a.value,c=a.operator;switch(c){case"contains":return new RegExp(".*"+b+".*","i");case"startsWith":case"startswith":return new RegExp("^"+b,"i");case"endsWith":case"endswith":return new RegExp(b+"$","i")}throw new Error("Unknown operator type.")},_getRegexValue:function(a){return c.prototype._getRegexValue.call(this,a)},_isAnd:function(a){return"and"===a.logic},_and:function(a){var b,c,d,e={},f=a.filters;for(b=0,c=f.length;c>b;b++)d=n._build(f[b]),e=n._andAppend(e,d);return e},_andAppend:function(a,b){return c.prototype._andAppend.call(this,a,b)},_isOr:function(a){return"or"===a.logic},_or:function(a){var b,c,d,e=[],f=a.filters;for(b=0,c=f.length;c>b;b++)d=n._build(f[b]),e.push(d);return{$or:e}},_translateoperator:function(a){switch(a){case"eq":return null;case"neq":return"$ne";case"gt":return"$gt";case"lt":return"$lt";case"gte":return"$gte";case"lte":return"$lte"}throw new Error("Unknown operator type.")}},o=function(a){a=a||{};var b=a.typeName,c=a.dataProvider||g.$;if(!c)throw new Error("You need to instantiate an Everlive instance in order to create a kendo DataSource.");if(!b)throw new Error("You need to specify a 'typeName' in order to create a kendo DataSource.");return c.getKendoDataSource(b,a)},p=function(a){var b=a.typeName,c=a.dataProvider||g.$;if(!c)throw new Error("You need to instantiate an Everlive instance in order to create a kendo DataSource.");if(!b)throw new Error("You need to specify a 'typeName' in order to create a kendo DataSource.");return c.getHierarchicalDataSource(b,a)};g.prototype.getKendoDataSource=function(a,b){if(b=f.extend({},b),b.hasOwnProperty("serverGrouping")&&b.serverGrouping===!0)throw new h("Server Grouping is not supported.");var c={type:"everlive",transport:{typeName:a,dataProvider:this}},d=f.defaults(c,b);return new j.data.DataSource(d)};var q=function(a,b){for(var c=s(b[b.length-1]),d=b.slice(0,b.length-1),e="/_expand",f=0;f<d.length;f++)e+="/"+s(d[f]);return function(b,c){return function(d){var e=a+"";return d.Id&&c&&(e+=b+"/"+d.Id+"/"+c),e}}(e,c)},r=function(a){return"string"==typeof a?{}:{"X-Everlive-Filter":JSON.stringify(a.filter),"X-Everlive-Sort":JSON.stringify(a.sort),"X-Everlive-Single-Field":a.singleField,"X-Everlive-Skip":a.skip,"X-Everlive-Take":a.take,"X-Everlive-Fields":JSON.stringify(a.fields)}},s=function(a){if("string"==typeof a)return a;if(a.relation)return a.relation;throw new Error("You need to specify a 'relation' for an expand node when using the object notation")};g.prototype.getHierarchicalDataSource=function(a,b){if(b=b||{},b.hasOwnProperty("serverGrouping")&&b.serverGrouping===!0)throw new h("Server Grouping is not supported.");var c=b.expand||b;if(delete b.expand,!a)throw new Error("You need to specify a 'typeName' in order to create a kendo HierarchicalDataSource.");if(!i.isArray(c))throw new Error("You need to set 'expand' array option in order to create a kendo HierarchicalDataSource");for(var d,e=this.buildUrl()+a,f=this._isOfflineStorageEnabled(),g=c.length-1;g>=0;g--){var l=c[g];if(f){if(!i.isPlainObject(l))throw new Error("When offline is enabled, each member of the expand array option must be an object. (Expand node index: "+g+")");if(!l.relation)throw new Error("When offline is enabled, each member of the expand array option must have a `relation` option set.  (Expand node index: "+g+")");if(!l.typeName)throw new Error("When offline is enabled, each member of the expand array option must have a `typeName` option set.  (Expand node index: "+g+")");var m,n={};n[l.relation]={TargetTypeName:l.typeName,Filter:l.filter,Sort:l.sort,Take:l.take,Skip:l.skip,Fields:l.fields,SingleField:l.singleField},m={"X-Everlive-Expand":JSON.stringify(n),"X-Everlive-Single-Field":l.relation};var o;o=0===g?a:c[g-1].typeName,d={model:{hasChildren:l.relation,children:{type:"everlive",transport:{typeName:o,read:{headers:m}},schema:d}}}}else d={model:{hasChildren:s(l),children:{type:"everlive",transport:{read:{url:q(e,c.slice(0,g+1)),headers:r(l)}},schema:d}}}}var p={};return p.type="everlive",p.transport={typeName:a,dataProvider:this},p.schema=d,i.isPlainObject(b)&&k(!0,p,b),new j.data.HierarchicalDataSource(p)},b.exports={createDataSource:o,createHierarchicalDataSource:p}}}()},{"../Everlive":35,"../EverliveError":36,"../Request":42,"../common":46,"../constants":47,"../query/Query":57,"../query/QueryBuilder":58}],52:[function(a,b){var c=a("../query/DataQuery"),d=a("../EverliveError"),e=d.EverliveError,f=d.EverliveErrors,g=a("../constants"),h=g.offlineItemStates,i=g.Headers,j=a("../query/RequestOptionsBuilder"),k=a("../common"),l=k._,m=k.rsvp,n=k.Mingo,o=k.mongoQuery,p=k.uuid,q=a("../utils"),r=a("../Request"),s=a("../ExpandProcessor"),t=a("./offlineTransformations"),u=a("../utils").buildPromise;b.exports=function(){function a(a,b,c,d){this.everlive=a,this.setup=b,this._persister=c,this._encryptionProvider=d,this._isSynchronizing=!1,this._collectionCache={}}function b(a){var b=a.operation;return(b===c.operations.userLoginWithProvider||b===c.operations.userLinkWithProvider||b===c.operations.userUnlinkFromProvider)&&(b+=a.data.Provider||a.data.Identity.Provider),"The Users operation "+b+" is not supported in offline mode"}var d=function(a){var b=k(a);return b.ModifiedAt=a.ModifiedAt,b},k=function(a){return{Id:a.Id}},v={};v[c.operations.create]=!0,v[c.operations.update]=!0,v[c.operations.remove]=!0,v[c.operations.removeSingle]=!0,v[c.operations.rawUpdate]=!0,v[c.operations.setAcl]=!0,v[c.operations.setOwner]=!0,v[c.operations.userLoginWithProvider]=!0,v[c.operations.userLinkWithProvider]=!0,v[c.operations.userUnlinkFromProvider]=!0,v[c.operations.userLogin]=!0,v[c.operations.userLogout]=!0,v[c.operations.userChangePassword]=!0;var w=[i.powerFields];return a.prototype={purgeAll:function(a,b){var c=this;return this._collectionCache={},u(function(a,b){c._persister.purgeAll(a,b)},a,b)},purge:function(a,b,c){var d=this;return u(function(b,c){d._persister.purge(a,b,c)},b,c)},processQuery:function(a){var b=this.getUnsupportedClientOpMessage(a);if(b&&!a.isSync)return new m.Promise(function(a,c){c(new e(b))});var d=a.getHeaderAsJSON(i.sort),f=a.getHeaderAsJSON(i.take),g=a.getHeaderAsJSON(i.skip),h=a.getHeaderAsJSON(i.select),j=a.getHeaderAsJSON(i.filter),k=a.getHeaderAsJSON(i.expand);if(a.filter instanceof Everlive.Query){var l=a.filter.build();j=l.$where||j,d=l.$sort||d,f=l.$take||f,g=l.$skip||g,h=l.$select||h,k=l.$expand||k}else j=a.filter||j;j||(j={});var n=q.getUnsupportedOperators(j),o=n.length;if(o)return new m.Promise(function(a,b){var c;c=1===o?"The operator "+n[0]+" is not supported in offline mode.":"The operators "+n.join(",")+"are not supported in offline mode.",b(new e(c))});switch(t.traverseAndTransformFilterId(j),a.operation){case c.operations.read:return this.read(a,j,d,g,f,h,k);case c.operations.readById:return this.readById(a,k);case c.operations.count:return this.count(a,j);case c.operations.create:return this.create(a);case c.operations.rawUpdate:case c.operations.update:return this.update(a,j);case c.operations.remove:return this.remove(a,j);case c.operations.removeSingle:return j._id=a.additionalOptions.id,this.remove(a,j);default:return new m.Promise(function(b,c){a.isSync?b():c(new e(a.operation+" is not supported in offline mode"))})}},getUnsupportedClientOpMessage:function(a){for(var c=0;c<w.length;c++){var d=w[c];if(a.getHeader(d))return"The header "+d+" is not supported in offline mode"}return"files"===a.collectionName.toLowerCase()?"Operations on files are not supported in offline mode":"users"===a.collectionName.toLowerCase()&&v[a.operation]?b(a):void 0},_getEncryptionProvider:function(){return this._encryptionProvider},_getCreateResult:function(a){if(1===a.length)return{result:{CreatedAt:q.cloneDate(a[0].CreatedAt),Id:a[0]._id}};var b=[];return l.each(a,function(a){b.push({CreatedAt:q.cloneDate(a.CreatedAt),Id:a._id})}),{result:b}},create:function(a){var b=this;return new m.Promise(function(c,d){b._createItems(a.collectionName,a.data,a.isSync,a.preserveState,function(a){var d=b._getCreateResult(a);c(d)},d)})},read:function(a,b,c,d,e,f,g){var h=this;return new m.Promise(function(i,j){var k;h._prepareExpand(g,a,!0).then(function(g){return g&&(f=g.mainQueryFieldsExpression),h._getCollection(a.collectionName).then(function(i){var j=h._readInternal(i,b,c,d,e,f);if(d||e){var l=h._readInternal(i);k=l.length}return j=h._shouldAutogenerateIdForContentType(a.collectionName)?t.idTransform(j):t.removeIdTransform(j,!0),h._expandResult(g,j)})}).then(function(b){var c=h._transformOfflineResult(b,k,a);i(c)})["catch"](j)})},_readInternal:function(a,b,c,d,e,f){var g=l.extend({},b),h=this._getWithoutDeletedFilter(g);t.traverseAndTransformFilterId(h);var i=n.Query(h),j=n.Cursor(a,i,f);return c&&(j=j.sort(c)),d&&j.skip(d),e&&j.limit(e),l.map(j.all(),function(a){return l.extend({},a)})},readById:function(a,b){var c=this;return c._prepareExpand(b,a,!1).then(function(b){return c._getCollection(a.collectionName).then(function(d){return new m.Promise(function(e,g){var h=c._getById(d,a.additionalOptions.id);return h?(h=t.idTransform(h),c._expandResult(b,h).then(e)["catch"](g)):g(f.itemNotFound)})})}).then(function(b){var d=c._transformOfflineResult(b,null,a);return d})},_prepareExpand:function(a,b,c){return new m.Promise(function(d,e){a?s.prepare(a,b.collectionName,c,b.fields,null,null,function(a,b){return a?("ExpandError"===a.name&&(a.code=f.invalidExpandExpression.code),e(a)):void d(b)}):d()})},_expandResult:function(a,b){var c=this;return new m.Promise(function(d,e){a?s.expand(a.relationsTree,b,{offlineModule:c},function(a,b){return a?("ExpandError"===a.name&&(a.code=f.invalidExpandExpression.code),e(a)):void d(b)}):d(b)})},_getWithoutDeletedFilter:function(a){var b={$and:[]};b.$and.push(a);var c={};return c[g.offlineItemsStateMarker]={$ne:h.deleted},b.$and.push(c),b},update:function(a,b){var c=this;return new m.Promise(function(d,e){c._updateItems(a,a.data,b,a.isSync,d,e)})},remove:function(a,b){var c=this;return new m.Promise(function(d,e){c._removeItems(a,b,a.isSync,d,e)})},count:function(a,b){var c=this;return new m.Promise(function(d,e){c._getCollection(a.collectionName).then(function(a){var e=c._readInternal(a,b);d({result:e.length})})["catch"](e)})},_setOffline:function(a){this.setup.offline=a},isOnline:function(){return!this.setup.offline},_prepareSyncData:function(a){var b=this,c={},d=[];return l.each(a,function(a,e){var f=t.idTransform(a.offlineItemsToSync),g=b._getSyncItemStates(e,f,a.serverItems);d.push(g.conflicts),c[e]=g.itemsForSync}),{conflicts:d,contentTypesSyncData:c}},_resolveConflicts:function(a){var b=this;return this._applyResolutionStrategy(a.conflicts).then(b._mergeResolvedConflicts.bind(b,a.conflicts,a.contentTypesSyncData)).then(function(){return a.contentTypesSyncData})},isSynchronizing:function(){return this._isSynchronizing},_fireSyncStart:function(){var a=this;return new m.Promise(function(b){a._isSynchronizing?b():(a._isSynchronizing=!0,a.everlive._emitter.emit("syncStart"),b())})},_fireSyncEnd:function(){var a=this;this._isSynchronizing=!1,l.each(this._syncResultInfo.syncedItems,function(b){a._syncResultInfo.syncedToServer+=l.where(b,{storage:"server"}).length,a._syncResultInfo.syncedToClient+=l.where(b,{storage:"client"}).length}),this.everlive._emitter.emit("syncEnd",this._syncResultInfo),delete this._syncResultInfo},_eachSyncItem:function(a,b,c,d){var e=this;l.each(a,function(a){var f=b(a.remoteItem),g=a.resultingItem;l.some(e._syncResultInfo.failedItems[c],{itemId:g.Id})||d(g,f)})},_addCreatedItemsForSync:function(a,b,c){var d,e=this,f=l.pluck(a.createdItems,"resultingItem");this._shouldAutogenerateIdForContentType(c.collectionName)||(d=l.pluck(f,"Id"),f=t.removeIdTransform(f)),b.create=new m.Promise(function(a,b){c.isSync(!0).applyOffline(!1).create(f).then(function(a){return f=l.map(f,function(b,c){return b.Id=a.result[c].Id,b.CreatedAt=b.ModifiedAt=a.result[c].CreatedAt,b}),c.isSync(!0).useOffline(!0).create(f).then(function(){var a=c.collectionName;if(l.each(f,function(b){e._addItemSynced(b,a,"server","create")}),d&&d.length){var g={Id:{$in:d}};return c.isSync(!0).useOffline(!0).destroy(g)["catch"](function(a){b({type:"create",items:f,contentType:c.collectionName,error:a,storage:"client"})})}},function(a){b({type:"create",items:f,contentType:c.collectionName,error:a,storage:"client"})})},function(a){b({type:"create",items:f,contentType:c.collectionName,error:a,storage:"server"})}).then(a)["catch"](function(a){b({type:"create",items:f,contentType:c.collectionName,error:a})})})},_addUpdatedItemsForSync:function(a,b,c,d,e){var f=this,g=d.collectionName;f._eachSyncItem(a.modifiedItems,b,g,e)},_addDeletedItemsForSync:function(a,b,c,d,e){var f=this,g=d.collectionName;f._eachSyncItem(a.deletedItems,b,g,e)},_onSyncResponse:function(a,b,d,e){var g=this;if(1!==a.result)return new m.Promise(function(a,c){g._removeItemSynced(b,d),c(l.extend({},f.syncConflict,{contentType:d}))});if(e===c.operations.update){g._addItemSynced(b,d,"server","update");var h=l.extend({},b,{ModifiedAt:a.ModifiedAt}),i=new c({operation:e,data:h,additionalOptions:{id:b.Id},collectionName:d,isSync:!0});return this.processQuery(i)}return e===c.operations.remove?(g._addItemSynced(b,d,"server","delete"),this._purgeById(d,b.Id)):void 0},_purgeById:function(a,b){var c=this;return c._getCollection(a).then(function(d){return delete d[b],c._persistData(a)})},sync:function(){var a=this;if(a._syncResultInfo=a._syncResultInfo||{syncedItems:{},syncedToServer:0,syncedToClient:0,failedItems:{},error:void 0},!this.isOnline())throw new e("Cannot synchronize while offline");a._fireSyncStart().then(a._applySync.bind(a)).then(function(b){var c=[];return l.each(b,function(b,d){if(b&&"rejected"===b.state){var e=b.reason.contentType;if(b.reason&&b.reason.code===f.syncConflict.code)c.push(b);else{var g=b.reason.type;a._syncResultInfo.failedItems[e]=a._syncResultInfo.failedItems[e]||[],"create"===g?l.each(b.reason.items,function(c){a._removeItemSynced(c,e,"server","create"),a._syncResultInfo.failedItems[e].push(l.extend({itemId:c.Id},l.pick(b.reason,"storage","type","error")))}):(a._removeItemSynced(d,e,"server"),a._syncResultInfo.failedItems[e].push(l.extend({itemId:d},l.pick(b.reason,"storage","type","error"))))}}}),c.length?a.sync():void a._fireSyncEnd()})["catch"](function(b){a._syncResultInfo.error=b,a._fireSyncEnd()})},_handleKeepServer:function(a,b,d){var f,g=this,h=b.serverItem,i=b.clientItem;if(h&&i)f=new c({collectionName:a,operation:c.operations.update,additionalOptions:{id:h.Id},data:h});else if(h&&!i)f=new c({collectionName:a,operation:c.operations.create,data:h});else{if(h||!i)throw new e('Both serverItem and clientItem are not set when syncing data with "KeepServer" resolution strategy.');f=new c({collectionName:a,operation:c.operations.removeSingle,additionalOptions:{id:i.Id}})}f.isSync=!0,d.push(new m.Promise(function(b,d){g.processQuery(f).then(function(){switch(f.operation){case c.operations.update:g._addItemSynced(h,a,"client","update");break;case c.operations.create:g._addItemSynced(h,a,"client","create");break;case c.operations.removeSingle:g._addItemSynced(i,a,"client","delete")}b()},function(a){var b,e;switch(f.operation){case c.operations.update:b=h.Id,e="update";break;case c.operations.create:b=h.Id,e="create";break;case c.operations.removeSingle:b=i.Id,e="delete"}d({itemId:b,type:e,contentType:f.collectionName,error:a,storage:"client"})})}))},_handleKeepClient:function(a,b){var c=a.serverItem,d=a.clientItem;if(c&&d){var f=l.extend(d,{ModifiedAt:new Date(c.ModifiedAt)});b.modifiedItems.push({remoteItem:a.serverItem,resultingItem:f})}else if(c&&!d)b.deletedItems.push({remoteItem:a.serverItem,resultingItem:c});else{if(c||!d)throw new e('Both serverItem and clientItem are not set when syncing data with "KeepClient" resolution strategy.');b.createdItems.push({remoteItem:a.serverItem,resultingItem:d})}},_handleCustom:function(a,b,d,e){var f=a.serverItem,g=a.clientItem,h=l.omit(a.result.item,"CreatedAt","ModifiedAt");if(f&&h){var i=new c({collectionName:b,operation:c.operations.create,data:f});i.preserveState=!0,i.isSync=!0,d.push(this.processQuery(i))}if(f&&h&&!g)h.Id=f.Id,e.modifiedItems.push({remoteItem:f,resultingItem:h});else if(f&&!h)e.deletedItems.push({remoteItem:a.serverItem,resultingItem:f});else if(!f&&h&&g){var j=new c({collectionName:b,operation:c.operations.update,data:h,additionalOptions:{id:g.Id}});d.push(this.processQuery(j)),h.Id=g.Id,e.createdItems.push({remoteItem:f,resultingItem:h})}else h.Id=f.Id,e.modifiedItems.push({remoteItem:f,resultingItem:h})},_mergeResolvedConflicts:function(a,b){var c=this,d=[];return l.each(a,function(a){var e=a.contentTypeName;l.each(a.conflictingItems,function(a){var f=b[e];switch(a.result.resolutionType){case g.ConflictResolution.KeepServer:c._handleKeepServer(e,a,d);break;case g.ConflictResolution.KeepClient:c._handleKeepClient(a,f);break;case g.ConflictResolution.Custom:c._handleCustom(a,e,d,f)}})}),m.all(d)},_getSyncItemStates:function(a,b,c){var d=this,e={itemsForSync:{createdItems:[],modifiedItems:[],deletedItems:[]},conflicts:{contentTypeName:a,conflictingItems:[]}};return l.each(b,function(b){var i=l.findWhere(c,{Id:b.Id});if(i){if(i.Id===b.Id&&b[g.offlineItemsStateMarker]===h.created)return d._syncResultInfo.failedItems[a]=d._syncResultInfo.failedItems[a]||[],void d._syncResultInfo.failedItems[a].push({itemId:i.Id,type:"create",storage:"client",error:f.syncError});var j=!!b[g.offlineItemsStateMarker],k=!1;j&&(k=i.ModifiedAt.getTime()!==b.ModifiedAt.getTime()),k?e.conflicts.conflictingItems.push({clientItem:b[g.offlineItemsStateMarker]===h.deleted?null:b,serverItem:i,result:{}}):b[g.offlineItemsStateMarker]===h.deleted?e.itemsForSync.deletedItems.push({remoteItem:i,resultingItem:b}):e.itemsForSync.modifiedItems.push({remoteItem:i,resultingItem:b})}else b[g.offlineItemsStateMarker]===h.modified?e.conflicts.conflictingItems.push({clientItem:b,serverItem:null,result:{}}):e.itemsForSync.createdItems.push({remoteItem:i,resultingItem:b});delete b[g.offlineItemsStateMarker]}),e},_setResolutionTypeForItem:function(a,b){b.result={resolutionType:a}},_applyResolutionStrategy:function(a){var b=this,c=b.setup.conflicts.strategy;return new m.Promise(function(d,f){for(var h=0;h<a.length;h++){var i=a[h];if(i.conflictingItems.length)switch(c){case g.ConflictResolutionStrategy.ServerWins:l.each(i.conflictingItems,b._setResolutionTypeForItem.bind(b,g.ConflictResolution.KeepServer));break;case g.ConflictResolutionStrategy.ClientWins:break;case g.ConflictResolutionStrategy.Custom:var j=b.setup.conflicts.implementation;if(!j)return f(new e("Implementation of the conflict resolution strategy must be provided when set to Custom"));j(a,d);break;default:return f(new e("Invalid resolution strategy provided"))}}d()})},_getSyncPromiseBatch:function(a,b){var d=this;return new m.Promise(function(e,f){var g=new c({collectionName:a,filter:{Id:{$in:b}},operation:c.operations.read,onSuccess:function(a){e(a.result)},applyOffline:!1,onError:f}),h=j[g.operation],i=h(g),k=new r(d.everlive.setup,i);k.send()})},_getSyncPromiseForCollection:function(a,b){var c,d=this,e=[],f=g.syncBatchSize,i=d._getDirtyItems(a);c=this._shouldAutogenerateIdForContentType(b)?l.pluck(i,"_id"):l.pluck(l.reject(i,function(a){return a[g.offlineItemsStateMarker]===h.created}),"_id");for(var j=Math.ceil(c.length/f),k=0;j>k;k++){var n=k*f,o=c.slice(n,n+f),p=this._getSyncPromiseBatch(b,o);e.push(p)}return m.all(e).then(function(a){var b={serverItems:[]};return l.each(a,function(a){b.serverItems=l.union(b.serverItems,a)}),b.offlineItemsToSync=i,b})},_addItemSynced:function(a,b,c,d){this._syncResultInfo.syncedItems[b]||(this._syncResultInfo.syncedItems[b]=[]),this._syncResultInfo.syncedItems[b].push({itemId:a.Id,type:d,storage:c})},_removeItemSynced:function(a,b){var c;c="string"==typeof a||"number"==typeof a?a:a.Id,this._syncResultInfo.syncedItems[b]||(this._syncResultInfo.syncedItems[b]=[]);var d=this._syncResultInfo.syncedItems[b];this._syncResultInfo.syncedItems[b]=l.without(d,l.findWhere(d,{itemId:c}))},_getClientWinsSyncData:function(a){var b=this,c={};return l.each(a,function(a,d){c[d]||(c[d]={createdItems:[],modifiedItems:[],deletedItems:[]});var e=b._getDirtyItems(a),f=t.idTransform(e);l.each(f,function(a){switch(a[g.offlineItemsStateMarker]){case h.created:c[d].createdItems.push({remoteItem:a,resultingItem:a});break;case h.modified:c[d].modifiedItems.push({remoteItem:a,resultingItem:a});break;case h.deleted:c[d].deletedItems.push({remoteItem:a,resultingItem:a})}delete a[g.offlineItemsStateMarker]}),c[d].offlineItemsToSync=f}),c},_addModifiedItemsForSyncClientWins:function(a,b,d){var f=this;this._addUpdatedItemsForSync(a,k,b,d,function(a){var g=a.Id;if(!g)throw new e("When updating an item it must have an Id field.");var h=d.collectionName;b[g]=new m.Promise(function(b,e){return d.isSync(!0).applyOffline(!1).updateSingle(a).then(function(d){f._addItemSynced(a,h,"server","update");var g=l.extend({},a,{ModifiedAt:d.ModifiedAt}),i=new c({operation:c.operations.update,data:g,additionalOptions:{id:a.Id},collectionName:h,isSync:!0});return f.processQuery(i).then(b,function(){e(l.extend({},{storage:"client",type:"update",itemId:a.Id,contentType:h,error:d}))})},function(b){e(l.extend({},{storage:"server",type:"update",itemId:a.Id,contentType:h,error:b}))})})})},_addDeletedItemsForSyncClientWins:function(a,b,c){var d=this;this._addDeletedItemsForSync(a,k,b,c,function(a,f){var g=c.collectionName;b[a.Id]=new m.Promise(function(b,h){var i=a.Id;if(!i)throw new e("When deleting an item it must have an Id field.");return c.isSync(!0).applyOffline(!1).destroySingle(f).then(function(){return d._addItemSynced(a,g,"server","delete"),d._purgeById(g,a.Id).then(function(){b()},function(a){h(l.extend({},{storage:"client",type:"delete",contentType:g,itemId:i,error:a}))})},function(a){h(l.extend({},{storage:"server",type:"delete",contentType:g,error:a,itemId:i}))})})})},_applyClientWins:function(a){var b=this,c=this._getClientWinsSyncData(a),d={};return l.each(c,function(a,c){var e=b.everlive.data(c);a.createdItems.length&&b._addCreatedItemsForSync(a,d,e),a.modifiedItems.length&&b._addModifiedItemsForSyncClientWins(a,d,e),a.deletedItems.length&&b._addDeletedItemsForSyncClientWins(a,d,e)}),m.hashSettled(d)},_applyStandardSync:function(a){var b=this,e={};return l.each(a,function(a,c){e[c]=b._getSyncPromiseForCollection(a,c)}),m.hash(e).then(b._prepareSyncData.bind(b)).then(b._resolveConflicts.bind(b)).then(function(a){var e={};return l.each(a,function(a,f){var g=b.everlive.data(f);a.createdItems.length&&b._addCreatedItemsForSync(a,e,g),a.modifiedItems.length&&b._addUpdatedItemsForSync(a,d,e,g,function(a,d){e[a.Id]=g.isSync(!0).applyOffline(!1).update(a,d).then(function(d){return b._onSyncResponse(d,a,f,c.operations.update)})}),a.deletedItems.length&&b._addDeletedItemsForSync(a,d,e,g,function(a,d){e[a.Id]=g.isSync(!0).applyOffline(!1).destroy(d).then(function(d){return b._onSyncResponse(d,a,f,c.operations.remove)})})}),m.hashSettled(e)})},_applySync:function(){var a=this;return this._getAllCollections().then(function(b){return a.setup.conflicts.strategy===g.ConflictResolutionStrategy.ClientWins?a._applyClientWins(b):a._applyStandardSync(b)})},_getDirtyItems:function(a){var b={};b[g.offlineItemsStateMarker]={$exists:!0};var c=n.Query(b),d=n.Cursor(a,c);return d.all()},_getAllCollections:function(){return new m.Promise(this._persister.getAllData.bind(this._persister))},_getCollection:function(a){var b=this;return new m.Promise(function(c,d){b._collectionCache[a]?c(b._collectionCache[a]):b._persister.getData(a,function(d){b._collectionCache[a]=d||{},c(b._collectionCache[a])},d)})},_persistData:function(a){var b=this;return new m.Promise(function(c,d){var e=b._collectionCache[a];b._transformPersistedData(a,e),b._persister.saveData(a,e,c,d)})},_getById:function(a,b){if(!b)throw new e("Id field is mandatory when using offline storage");if(a[b]){var c=l.extend({},a[b]),d=c&&c[g.offlineItemsStateMarker]===h.deleted;return d?void 0:c}},_setItem:function(a,b,c){c?b[g.offlineItemsStateMarker]=c:delete b[g.offlineItemsStateMarker],a[b._id]=b},_shouldAutogenerateIdForContentType:function(a){return!(this.setup&&this.setup.typeSettings&&this.setup.typeSettings[a]&&this.setup.typeSettings[a].autoGenerateId===!1)},_createItems:function(a,b,c,d,e,f){var i=this;this._getCollection(a).then(function(j){var k=l.isArray(b)?b:[b],m=l.map(k,function(b){var e=l.extend({},b);e._id=e.Id||p.v1(),delete e.Id;var k,m=i._getById(j,e._id),n=!!m;return!n||c||d?(k=c&&d&&n?m[g.offlineItemsStateMarker]:c?void 0:h.created,e.CreatedAt=b.CreatedAt&&b.CreatedAt instanceof Date?q.cloneDate(b.CreatedAt):new Date,e.ModifiedAt=q.cloneDate(b.ModifiedAt&&b.ModifiedAt instanceof Date?b.ModifiedAt:e.CreatedAt),e.CreatedBy=e.CreatedBy||i.everlive.setup.principalId||g.guidEmpty,e.ModifiedBy=e.ModifiedBy||e.CreatedBy,e.Owner="Users"===a?e._id:e.CreatedBy||g.guidEmpty,i._setItem(j,l.extend({},e),k),e):f(new Error("An item with the specified id already exists"))});return i._persistData(a).then(function(){i._shouldAutogenerateIdForContentType(a)||c||(m=t.removeIdTransform(m)),e(m)})})["catch"](f)},_applyUpdateOperation:function(a,b,c,d){var e,f=q.getDbOperators(a,!0),i=0!==f.length;e=i?a:{$set:a};var j={ModifiedBy:this.everlive.setup.principalId||g.guidEmpty};e.$set=l.extend(j,e.$set),d&&(e.$set.ModifiedAt=q.cloneDate(a.ModifiedAt)),o(b,{},e,{strict:!0}),b._id=b._id||e._id||e.Id,delete b.Id;var k;k=d?void 0:b[g.offlineItemsStateMarker]===h.created?h.created:h.modified,this._setItem(c,b,k)},_updateItems:function(a,b,c,d,e,g){var h=this;h._getCollection(a.collectionName).then(function(i){var j;if(a.additionalOptions&&a.additionalOptions.id)l=h._getById(i,a.additionalOptions.id),h._applyUpdateOperation(b,l,i,d),j=[l];else{j=h._readInternal(i,c);for(var k=0;k<j.length;k++){var l=j[k],m=!!h._getById(i,l._id.toString());if(!m&&!d)return g(f.itemNotFound);h._applyUpdateOperation(b,l,i,d)}}return h._persistData(a.collectionName).then(function(){var a=j.length,b=a?j[0].ModifiedAt:new Date,c={ModifiedAt:b,result:a};e(c)})})["catch"](g)},_clearItem:function(a,b){delete a[b._id]},_removeItems:function(a,b,c,d,f){var i=this;i._getCollection(a.collectionName).then(function(j){for(var k=i._readInternal(j,b),l=0;l<k.length;l++){var m=k[l];m._id=m._id||m.Id;var n=!!i._getById(j,m._id.toString());if(!n&&!c)return f(new e("Cannot delete item - item with id "+m._id+" does not exist."));var o=m[g.offlineItemsStateMarker]===h.created||c;o?i._clearItem(j,m):i._setItem(j,m,h.deleted)}return i._persistData(a.collectionName).then(function(){var a=i._transformOfflineResult(k.length);d(a)})})["catch"](f)},_applyTransformations:function(a,b){Array.isArray(a.result)?l.each(b,function(b){a.result.map(function(c,d){a.result[d]=b(c)})}):l.each(b,function(b){a.result=b(a.result)})},_transformOfflineResult:function(a,b,c,d){var e={result:a,count:b||(a||[]).length};(void 0!==b&&null!==b||Array.isArray(a))&&(e.count=b||a.length);var f=[];if(f.push(t.idTransform),f.push(t.removeMarkersTransform),c){var g=c.getHeader(i.includeCount);g===!1&&delete e.count;var h=c.getHeader(i.singleField);"string"==typeof h&&f.push(t.singleFieldTransform.bind(this,h))}return d&&(f=f.concat(d)),this._applyTransformations(e,f),void 0===e.count&&delete e.count,e},_transformPersistedData:function(a,b){var c=[];"Users"===a&&(c=c.concat(["Password","QuestionId","SecretAnswer"])),c.length&&l.each(b,function(a){t.removeFieldsTransform(a,c)})}},a}()},{"../EverliveError":36,"../ExpandProcessor":37,"../Request":42,"../common":46,"../constants":47,"../query/DataQuery":56,"../query/RequestOptionsBuilder":59,
"../utils":66,"./offlineTransformations":55}],53:[function(a,b){var c=a("../constants"),d=a("./offlinePersisters"),e=d.LocalStoragePersister,f=d.FileSystemPersister,g=a("./OfflineStorageModule"),h=a("../EverliveError").EverliveError,i=a("../everlive.platform").isNativeScript,j=a("../common"),k=j._,l=j.rsvp,m=a("../encryption/CryptographicProvider"),n={autoSync:!0,enabled:!0,conflicts:{strategy:c.ConflictResolutionStrategy.ClientWins,implementation:null},offline:!1,storage:{name:"",provider:i?c.StorageProvider.FileSystem:c.StorageProvider.LocalStorage,implementation:null,storagePath:c.DefaultStoragePath},typeSettings:{},encryption:{provider:c.EncryptionProvider.Default,implementation:null,key:""}};b.exports=function(){var a={};a[c.ConflictResolutionStrategy.ClientWins]=function(a,b){return new l.Promise(function(a){a(b)})},a[c.ConflictResolutionStrategy.ServerWins]=function(a,b,c){return new l.Promise(function(a){a(c)})};var b=function(a){var b,d=a.storage.provider,g=a.storage.implementation,i=a.storage.name||"everliveOfflineStorage_"+this.setup.apiKey;if(k.isObject(g)&&d===c.StorageProvider.Custom)b=g;else switch(d){case c.StorageProvider.LocalStorage:b=new e(i,this);break;case c.StorageProvider.FileSystem:b=new f(i,this);break;case c.StorageProvider.Custom:throw new h("Custom storage provider requires an implementation object");default:throw new h("Unsupported storage type "+d)}return a.storage.implementation=b,b},d=function(a){var b,d=a.encryption.provider,e=a.encryption.implementation;if(k.isObject(e)&&d===c.EncryptionProvider.Custom)b=e;else switch(d){case c.EncryptionProvider.Default:b=new m(this);break;case c.EncryptionProvider.Custom:throw new h("Custom encryption provider requires an implementation object");default:throw new h("Unsupported encryption provider "+d)}return a.encryption.implementation=b,b},i=function(a){var c;a===!0?c=k.defaults({},n):k.isObject(a)?(c=k.defaults(a,n),c.storage=k.defaults(a.storage,n.storage),c.encryption=k.defaults(a.encryption,n.encryption),c.conflicts=k.defaults(a.conflicts,n.conflicts)):(c=k.defaults({},n),c.enabled=!1);var e=b.call(this,c,a),f=d.call(this,c);return new g(this,c,e,f)},j=function(a){this.offlineStorage=i.call(this,a.offlineStorage)};return{initOfflineStorage:j}}()},{"../EverliveError":36,"../common":46,"../constants":47,"../encryption/CryptographicProvider":48,"../everlive.platform":49,"./OfflineStorageModule":52,"./offlinePersisters":54}],54:[function(a,b){var c=a("../common"),d=c._,e=a("../everlive.platform"),f=e.isNativeScript,g=e.isCordova,h=c.rsvp,i=a("../utils").parseUtilities,j=a("../EverliveError").EverliveError,k=a("util"),l=a("../LocalStore"),m=(a("../constants"),function(){function a(a,b){this.key=a,this.sdk=b}return a.prototype={getAllData:function(){throw new j("The method getAllData is not implemented")},getData:function(){throw new j("The method getData is not implemented")},saveData:function(){throw new j("The method saveData is not implemented")},purge:function(){throw new j("The method clear is not implemented")},purgeAll:function(){throw new j("The method clearAll is not implemented")},_getKey:function(a){return this.key+"_"+a},_getEncryptionProvider:function(){return this.sdk.offlineStorage._getEncryptionProvider()}},a}()),n=function(){function a(){m.apply(this,arguments),this._localStore=null}return k.inherits(a,m),a.prototype._ensureLocalStore=function(){this._localStore||(this._localStore=new l(this.sdk))},a.prototype.getAllData=function(a,b){var c=this,e=this._getContentTypes(),f={};d.each(e,function(a){f[a]=new h.Promise(function(b,d){c.getData(a,b,d)})}),h.hash(f).then(a,b)},a.prototype.getData=function(a,b,c){try{var d=this._getKey(a),e=this._getItem(d)||"{}",f=i.getReviver(),g=JSON.parse(e,f);b(g)}catch(h){c(h)}},a.prototype.saveData=function(a,b,c,d){try{var e=JSON.stringify(b),f=this._getKey(a);this._setItem(f,e),c()}catch(g){d(g)}},a.prototype.purge=function(a,b,c){try{var d=this._getKey(a);this._removeItem(d),b()}catch(e){c(e)}},a.prototype.purgeAll=function(a,b){try{var c=this,e=this._getContentTypes();d.each(e,function(a){var b=c._getKey(a);c._removeItem(b)});var f=this._getContentTypesCollectionKey();this._removeItem(f),a()}catch(g){b(g)}},a.prototype._getItem=function(a){this._ensureLocalStore();var b=this._localStore.getItem(a),c=this._getEncryptionProvider();return c.decrypt(b)},a.prototype._setItem=function(a,b){this._ensureLocalStore();var c=this._getEncryptionProvider();return b=c.encrypt(b),this._localStore.setItem(a,b)},a.prototype._removeItem=function(a){return this._ensureLocalStore(),this._localStore.removeItem(a)},a.prototype._getKey=function(b){return this._ensureLocalStore(),this._addTypeToCollectionsCache(b),a.super_.prototype._getKey.apply(this,arguments)},a.prototype._getContentTypesCollectionKey=function(){return this.key+"@ContentTypes"},a.prototype._getContentTypes=function(){var a=this._getContentTypesCollectionKey(),b=this._getItem(a);return b?JSON.parse(b):[]},a.prototype._setContentTypesCollection=function(a){var b=this._getContentTypesCollectionKey();this._setItem(b,JSON.stringify(a))},a.prototype._addTypeToCollectionsCache=function(a){var b=this._getContentTypes();d.contains(b,a)||(b.push(a),this._setContentTypesCollection(b))},a}(),o=function(){function b(){if(m.apply(this,arguments),!g&&!f)throw new j("FileSystemPersister can be used only with Cordova and NativeScript");this.contentTypesStoreKey="@ContentTypes"}return k.inherits(b,m),b.prototype.getAllData=function(a,b){var c=this,d=this._fileSystemErrorHandler(b),e={};this._getContentTypesMetadata(function(b){Object.keys(b).forEach(function(a){e[a]=new h.Promise(function(b,d){c.getData(a,b,d)})}),h.hash(e).then(a,d)},d)},b.prototype.getData=function(a,b,c){var d=this,e=this._fileSystemErrorHandler(c);this._getFileFull(a,function(a){d._readFileContent(a,b,e)},c)},b.prototype.saveData=function(a,b,c,d){var e=this,f=JSON.stringify(b),g=this._fileSystemErrorHandler(d);this._getFileFull(a,function(b){e._writeFileContent(b,f,function(){e._saveContentTypesMetadata(a,c,g)},g)},g)},b.prototype.purge=function(a,b,c){var d=this,e=this._fileSystemErrorHandler(c);this._getFileFull(a,function(a){d._removeFile(a,b,c)},e)},b.prototype.purgeAll=function(a,b){var c=this,d=this._fileSystemErrorHandler(b);this._resolveDataDirectory(function(b){c._removeFilesDirectory(b,a,d)},d)},b.prototype._ensureProperties=function(){if(this.filesDirectoryPath||(this.filesDirectoryPath=this.sdk.offlineStorage.setup.storage.storagePath),!this.dataDirectoryPath)if(g){if(cordova&&!cordova.file)throw new j('You need to enable the cordova file plugin to use file offline storage. Make sure that the "deviceReady" event has fired.');this.dataDirectoryPath=cordova.file.dataDirectory}else f&&(this.fs=a("file-system"),this.dataDirectoryPath=this.fs.knownFolders.documents().path)},b.prototype._getContentTypesMetadata=function(a,b){this._ensureProperties(),this.getData(this.contentTypesStoreKey,a,b)},b.prototype._saveContentTypesMetadata=function(a,b,c){this._ensureProperties();var d=this;this._getContentTypesMetadata(function(e){e[a]=!0,d._getFileFull(d.contentTypesStoreKey,function(a){d._writeFileContent(a,JSON.stringify(e),b,c)},c)})},b.prototype._getFileFull=function(a,b,c){this._ensureProperties();var d=this;this._ensureFilesDirectory(function(){var e=d._getFilePath(a);d._getFileFromSystem(e,b,c)},c)},b.prototype._removeFilesDirectory=function(a,b,c){if(this._ensureProperties(),g)a.getDirectory(this.filesDirectoryPath,{create:!0,exclusive:!1},function(a){a.removeRecursively(function(){b()},c)},c);else if(f){var d=this.fs.path.join(a.path,this.filesDirectoryPath),e=this.fs.Folder.fromPath(d);e.remove().then(b,c)}},b.prototype._removeFile=function(a,b,c){this._ensureProperties(),g?a.remove(function(){b()},c):f&&a.remove().then(b,c)},b.prototype._readFileContent=function(a,b,c){this._ensureProperties();var d=this,e=function(a){var c=d._getEncryptionProvider();a=c.decrypt(a);var e=i.getReviver(),f=JSON.parse(a||"{}",e);b(f)};g?a.file(function(a){var b=new FileReader;b.onloadend=function(){e(this.result)},b.onerror=c,b.readAsText(a)},c):f&&a.readText().then(e,c)},b.prototype._writeFileContent=function(a,b,c,d){this._ensureProperties();var e=this._getEncryptionProvider();b=e.encrypt(b),g?a.createWriter(function(a){a.onwriteend=function(){c()},a.onerror=d,a.write(b)},d):f&&a.writeText(b).then(c,d)},b.prototype._getFileFromSystem=function(a,b,c){this._ensureProperties(),this._resolveDataDirectory(function(d){if(g)d.getFile(a,{create:!0,exclusive:!1},b,c);else if(f)try{var e=this.fs.path.join(d.path,a),h=this.fs.File.fromPath(e);b(h)}catch(i){c(i)}}.bind(this))},b.prototype._getFilePath=function(a){return this._ensureProperties(),this.filesDirectoryPath+this._getKey(a)},b.prototype._resolveDataDirectory=function(a,b){if(this._ensureProperties(),g)resolveLocalFileSystemURL(this.dataDirectoryPath,a,b);else if(f){var c=this.fs.Folder.fromPath(this.dataDirectoryPath);a(c)}},b.prototype._ensureFilesDirectory=function(a,b){this._ensureProperties();var c=this.filesDirectoryPath;this._resolveDataDirectory(function(d){if(g)d.getDirectory(c,{create:!0,exclusive:!1},a,b);else if(f)try{var e=this.fs.path.join(d.path,c);this.fs.Folder.fromPath(e),a()}catch(h){b(h)}}.bind(this),b)},b.prototype._fileSystemErrorHandler=function(a){if(!f){var b={};return d.each(Object.keys(FileError),function(a){b[FileError[a]]=a}),function(c){c.message=b[c.code],a&&a(c)}}return function(b){a&&a(b)}},b}();b.exports={BasePersister:m,LocalStoragePersister:n,FileSystemPersister:o}},{"../EverliveError":36,"../LocalStore":40,"../common":46,"../constants":47,"../everlive.platform":49,"../utils":66,"file-system":"file-system",util:6}],55:[function(a,b){"use strict";var c=a("../constants"),d=a("../common")._,e=c.offlineItemsStateMarker,f=function(a,b,c){return d.isArray(a)?d.map(a,function(a){return b(a,c)}):b(a,c)},g=function(a){return"object"==typeof a&&a._id&&!a.Id&&(a.Id=a._id,delete a._id),a},h=function(a,b){var d=b.verifyStateCreated,e=d?a[c.offlineItemsStateMarker]===c.offlineItemStates.created:!0;return"object"==typeof a&&(a._id||a.Id)&&e&&(delete a._id,delete a.Id),a},i=function(a){return delete a[e],a},j={removeIdTransform:function(a,b){return f(a,h,{verifyStateCreated:b})},idTransform:function(a){return f(a,g)},singleFieldTransform:function(a,b){return"undefined"==typeof b||null===b?null:b[a]},traverseAndTransformFilterId:function(a){a&&a.Id&&(a._id=a.Id,delete a.Id);for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];"object"==typeof c&&j.traverseAndTransformFilterId(c)}},removeMarkersTransform:function(a){return f(a,i)},removeFieldsTransform:function(a,b){return d.each(b,function(b){delete a[b]}),a}};b.exports=j},{"../common":46,"../constants":47}],56:[function(a,b){var c=a("../common")._;b.exports=function(){var a=function(a){this.collectionName=a.collectionName,this.headers=a.headers||{},this.filter=a.filter,this.onSuccess=a.onSuccess,this.onError=a.onError,this.operation=a.operation,this.parse=a.parse,this.additionalOptions=a.additionalOptions,this.data=a.data,this.useOffline=a.useOffline,this.applyOffline=a.applyOffline,this.noRetry=a.noRetry,this.skipAuth=a.skipAuth,this._normalizedHeaders=null,this.isSync=a.isSync};return a.prototype={getHeader:function(a){var b=this,d=Object.keys(this.headers);this._normalizedHeaders||(this._normalizedHeaders={},c.each(d,function(a){var c=a.toLowerCase(),d=b.headers[a];b._normalizedHeaders[c]=d}));var e=a.toLowerCase();return this._normalizedHeaders[e]},getHeaderAsJSON:function(a){var b=this._normalizedHeaders[a.toLowerCase()];if(c.isObject(b))return b;if(!c.isString(b))return b;try{return JSON.parse(b)}catch(d){return b}}},a.operations={read:"read",create:"create",update:"update",remove:"destroy",removeSingle:"destroySingle",readById:"readById",count:"count",rawUpdate:"rawUpdate",setAcl:"setAcl",setOwner:"setOwner",userLogin:"login",userLogout:"logout",userChangePassword:"changePassword",userLoginWithProvider:"loginWith",userLinkWithProvider:"linkWith",userUnlinkFromProvider:"unlinkFrom",filesUpdateContent:"updateContent",filesGetDownloadUrlById:"downloadUrlById"},a}()},{"../common":46}],57:[function(a,b){var c=a("../Expression"),d=a("../constants").OperatorType,e=a("./WhereQuery"),f=a("./QueryBuilder");b.exports=function(){function a(a,b,e,f,g,h){this.filter=a,this.fields=b,this.sort=e,this.toskip=f,this.totake=g,this.expandExpression=h,this.expr=new c(d.query)}return a.prototype={where:function(a){return a?this._simple(d.filter,[a]):new e(this)},select:function(){return this._simple(d.select,arguments)},order:function(a){return this._simple(d.order,[a])},orderDesc:function(a){return this._simple(d.order_desc,[a])},skip:function(a){return this._simple(d.skip,[a])},take:function(a){return this._simple(d.take,[a])},expand:function(a){return this._simple(d.expand,[a])},build:function(){return new f(this).build()},_simple:function(a,b){var d=[].slice.call(b);return this.expr.addOperand(new c(a,d)),this}},a}()},{"../Expression":38,"../constants":47,"./QueryBuilder":58,"./WhereQuery":60}],58:[function(a,b){var c=a("../constants"),d=c.OperatorType,e=a("../common")._,f=a("../GeoPoint"),g=a("../EverliveError").EverliveError,h=a("../Expression"),i=c.maxDistanceConsts,j=c.radiusConsts;b.exports=function(){function a(a){this.query=a,this.expr=a.expr}return a.prototype={build:function(){var a=this.query;return a.filter||a.fields||a.sort||a.toskip||a.totake||a.expandExpression?{$where:a.filter||null,$select:a.fields||null,$sort:a.sort||null,$skip:a.toskip||null,$take:a.totake||null,$expand:a.expandExpression||null}:{$where:this._buildWhere(),$select:this._buildSelect(),$sort:this._buildSort(),$skip:this._getSkip(),$take:this._getTake(),$expand:this._getExpand()}},_getSkip:function(){var a=e.find(this.expr.operands,function(a){return a.operator===d.skip});return a?a.operands[0]:null},_getTake:function(){var a=e.find(this.expr.operands,function(a){return a.operator===d.take});return a?a.operands[0]:null},_getExpand:function(){var a=e.chain(this.expr.operands).filter(function(a){return a.operator===d.expand}).reduce(function(a,b){return e.extend(a,b.operands[0])},{}).value();return e.isEmpty(a)?null:a},_buildSelect:function(){var a=e.find(this.expr.operands,function(a){return a.operator===d.select}),b={};return a?(e.reduce(a.operands,function(a,b){return a[b]=1,a},b),b):null},_buildSort:function(){var a=e.filter(this.expr.operands,function(a){return a.operator===d.order||a.operator===d.order_desc}),b={};return a.length>0?(e.reduce(a,function(a,b){return a[b.operands[0]]=b.operator===d.order?1:-1,a},b),b):null},_buildWhere:function(){var a=e.find(this.expr.operands,function(a){return a.operator===d.where});if(a)return this._build(new h(d.and,a.operands));var b=e.find(this.expr.operands,function(a){return a.operator===d.filter});return b?b.operands[0]:null},_build:function(a){return this._isSimple(a)?this._simple(a):this._isRegex(a)?this._regex(a):this._isGeo(a)?this._geo(a):this._isAnd(a)?this._and(a):this._isOr(a)?this._or(a):this._isNot(a)?this._not(a):void 0},_isSimple:function(a){return a.operator>=d.equal&&a.operator<=d.size},_simple:function(a){var b={},c={},d=a.operands,e=this._translateoperator(a.operator);return e?b[e]=d[1]:b=d[1],c[d[0]]=b,c},_isRegex:function(a){return a.operator>=d.regex&&a.operator<=d.endsWith},_regex:function(a){var b={},c=this._getRegex(a),d=this._getRegexValue(c),e=a.operands;return b[e[0]]=d,b},_getRegex:function(a){var b=a.operands[1],c=a.operands[2]?a.operands[2]:"";switch(a.operator){case d.regex:return b instanceof RegExp?b:new RegExp(b,c);case d.startsWith:return new RegExp("^"+b,c);case d.endsWith:return new RegExp(b+"$",c);default:throw new g("Unknown operator type.")}},_getRegexValue:function(a){var b="";return a.global&&(b+="g"),a.multiline&&(b+="m"),a.ignoreCase&&(b+="i"),{$regex:a.source,$options:b}},_isGeo:function(a){return a.operator>=d.nearShpere&&a.operator<=d.withinShpere},_geo:function(a){var b={},c=a.operands;return b[c[0]]=this._getGeoTerm(a),b},_getGeoTerm:function(a){switch(a.operator){case d.nearShpere:return this._getNearSphereTerm(a);case d.withinBox:return this._getWithinBox(a);case d.withinPolygon:return this._getWithinPolygon(a);case d.withinShpere:return this._getWithinCenterSphere(a);default:throw new g("Unknown operator type.")}},_getNearSphereTerm:function(a){var b,c=a.operands,d=this._getGeoPoint(c[1]),e=c[2],f=c[3],g={$nearSphere:d};return"undefined"!=typeof e&&(b=i[f]||i.radians,g[b]=e),g},_getWithinBox:function(a){var b=a.operands,c=this._getGeoPoint(b[1]),d=this._getGeoPoint(b[2]);return{$within:{$box:[c,d]}}},_getWithinPolygon:function(a){var b=a.operands,c=this._getGeoPoints(b[1]);return{$within:{$polygon:c}}},_getWithinCenterSphere:function(a){var b=a.operands,c=this._getGeoPoint(b[1]),d=b[2],e=b[3],f=j[e]||j.radians,g={center:c};return g[f]=d,{$within:{$centerSphere:g}}},_getGeoPoint:function(a){return e.isArray(a)?new f(a[0],a[1]):a},_getGeoPoints:function(a){var b=this;return e.map(a,function(a){return b._getGeoPoint(a)})},_isAnd:function(a){return a.operator===d.and},_and:function(a){var b,c,d,e={},f=a.operands;for(b=0,c=f.length;c>b;b++)d=this._build(f[b]),e=this._andAppend(e,d);return e},_andAppend:function(a,b){var c,d,f,g,h,i=e.keys(b);for(c=0,d=i.length;d>c;c++)f=i[c],g=a[f],"undefined"==typeof g?a[f]=b[f]:(h=b[f],g="object"==typeof g&&"object"==typeof h?e.extend(g,h):h,a[f]=g);return a},_isOr:function(a){return a.operator===d.or},_or:function(a){var b,c,d,e=[],f=a.operands;for(b=0,c=f.length;c>b;b++)d=this._build(f[b]),e.push(d);return{$or:e}},_isNot:function(a){return a.operator===d.not},_not:function(a){return{$not:this._build(a.operands[0])}},_translateoperator:function(a){switch(a){case d.equal:return null;case d.not_equal:return"$ne";case d.gt:return"$gt";case d.lt:return"$lt";case d.gte:return"$gte";case d.lte:return"$lte";case d.isin:return"$in";case d.notin:return"$nin";case d.all:return"$all";case d.size:return"$size"}throw new g("Unknown operator type.")}},a}()},{"../EverliveError":36,"../Expression":38,"../GeoPoint":39,"../common":46,"../constants":47}],59:[function(a,b){var c=a("./DataQuery"),d=a("../Request"),e=a("../common")._;b.exports=function(){var a={};return a._buildEndpointUrl=function(a){var b=a.collectionName;return a.additionalOptions&&a.additionalOptions.id&&(b+="/"+a.additionalOptions.id),b},a._buildBaseObject=function(b){var c={endpoint:a._buildEndpointUrl(b),filter:b.filter,success:b.onSuccess,error:b.onError,data:b.data,headers:b.headers};return b.parse&&(c.parse=b.parse),c},a._build=function(b,c){return e.extend(a._buildBaseObject(b),c)},a[c.operations.read]=function(b){return a._build(b,{method:"GET"})},a[c.operations.readById]=function(b){return a._build(b,{method:"GET"})},a[c.operations.count]=function(b){return a._build(b,{method:"GET",endpoint:b.collectionName+"/_count"})},a[c.operations.create]=function(b){return a._build(b,{method:"POST"})},a[c.operations.rawUpdate]=function(b){var c=b.collectionName,d=b.filter,e=null;return"string"==typeof d?c+="/"+d:"object"==typeof d&&(e=d),a._build(b,{method:"PUT",endpoint:c,filter:e})},a[c.operations.update]=function(b){return a._build(b,{method:"PUT"})},a[c.operations.remove]=function(b){return e.extend(a._buildBaseObject(b),{method:"DELETE"})},a[c.operations.removeSingle]=a[c.operations.remove],a[c.operations.setAcl]=function(b){var c=b.collectionName,d=b.filter;"string"==typeof d?c+="/"+d:"object"==typeof d&&(c+="/"+d[idField]),c+="/_acl";var e,f;return null===b.additionalOptions.acl?e="DELETE":(e="PUT",f=b.additionalOptions.acl),a._build(b,{method:e,endpoint:c,data:f})},a[c.operations.setOwner]=function(b){var c=b.collectionName,d=b.filter;return"string"==typeof d?c+="/"+d:"object"==typeof d&&(c+="/"+d[idField]),c+="/_owner",a._build(b,{method:"PUT",endpoint:c})},a[c.operations.userLogin]=function(b){return a._build(b,{method:"POST",endpoint:"oauth/token",authHeaders:!1,parse:d.parsers.single})},a[c.operations.userLogout]=function(b){return a._build(b,{method:"GET",endpoint:"oauth/logout"})},a[c.operations.userChangePassword]=function(b){var c=b.additionalOptions.keepTokens,e="Users/changepassword";return c&&(e+="?keepTokens=true"),a._build(b,{method:"POST",endpoint:e,authHeaders:!1,parse:d.parsers.single})},a[c.operations.userLoginWithProvider]=function(b){return a._build(b,{method:"POST",authHeaders:!1})},a[c.operations.userLinkWithProvider]=function(b){return a._build(b,{method:"POST",endpoint:a._buildEndpointUrl(b)+"/link"})},a[c.operations.userUnlinkFromProvider]=function(b){return a._build(b,{method:"POST",endpoint:a._buildEndpointUrl(b)+"/unlink"})},a[c.operations.filesUpdateContent]=function(b){return a._build(b,{method:"PUT",endpoint:a._buildEndpointUrl(b)+"/Content"})},a[c.operations.filesGetDownloadUrlById]=function(b){return a._build(b,{method:"GET"})},a}()},{"../Request":42,"../common":46,"./DataQuery":56}],60:[function(a,b){var c=a("../Expression"),d=a("../constants").OperatorType;b.exports=function(){function a(a,b,e){this.parent=a,this.single=e,this.expr=new c(b||d.where),this.parent.expr.addOperand(this.expr)}return a.prototype={and:function(){return new a(this,d.and)},or:function(){return new a(this,d.or)},not:function(){return new a(this,d.not,!0)},_simple:function(a){var b=[].slice.call(arguments,1);return this.expr.addOperand(new c(a,b)),this._done()},eq:function(a,b){return this._simple(d.equal,a,b)},ne:function(a,b){return this._simple(d.not_equal,a,b)},gt:function(a,b){return this._simple(d.gt,a,b)},gte:function(a,b){return this._simple(d.gte,a,b)},lt:function(a,b){return this._simple(d.lt,a,b)},lte:function(a,b){return this._simple(d.lte,a,b)},isin:function(a,b){return this._simple(d.isin,a,b)},notin:function(a,b){return this._simple(d.notin,a,b)},all:function(a,b){return this._simple(d.all,a,b)},size:function(a,b){return this._simple(d.size,a,b)},regex:function(a,b,c){return this._simple(d.regex,a,b,c)},startsWith:function(a,b,c){return this._simple(d.startsWith,a,b,c)},endsWith:function(a,b,c){return this._simple(d.endsWith,a,b,c)},nearSphere:function(a,b,c,e){return this._simple(d.nearShpere,a,b,c,e)},withinBox:function(a,b,c){return this._simple(d.withinBox,a,b,c)},withinPolygon:function(a,b){return this._simple(d.withinPolygon,a,b)},withinCenterSphere:function(a,b,c,e){return this._simple(d.withinShpere,a,b,c,e)},done:function(){return this.parent instanceof a?this.parent._done():this.parent},_done:function(){return this.single?this.parent:this}},a.prototype.equal=a.prototype.eq,a.prototype.notEqual=a.prototype.ne,a.prototype.greaterThan=a.prototype.gt,a.prototype.greaterThanEqual=a.prototype.gte,a.prototype.lessThan=a.prototype.lt,a.prototype.lessThanEqual=a.prototype.lte,a}()},{"../Expression":38,"../constants":47}],61:[function(a,b){var c=a("http");b.exports=function(){"use strict";function a(a){var b={url:a.url,method:a.method,headers:a.headers||{}};a.data&&(b.content=a.data),b.headers.Accept="application/json",b.headers["Content-Type"]="application/json";var d=function(){},e=a.success||d,f=a.error||d,g=function(a){var b=a.content.toString();a.statusCode<400?e(b):f({responseText:b})},h=function(a){f({responseText:a})};c.request(b).then(g,h)}return a}()},{http:"http"}],62:[function(a,b){(function(c){var d=a("url"),e=a("http"),f=a("https"),g=(a("rsvp"),a("zlib")),h=a("underscore");b.exports=function(){"use strict";function a(a){var b,i=d.parse(a.url);b="https:"===i.protocol?f.request:e.request;var j=a.headers||{};a.success=a.success||h.noop,a.error=a.error||h.noop,j["Content-Type"]=a.contentType;var k=b({method:a.method,hostname:i.hostname,port:i.port,path:i.path,headers:j},function(b){var c,d="",e=b.headers["content-encoding"];switch(e){case"gzip":c=g.createGunzip(),b.pipe(c);break;default:c=b,c.setEncoding("utf8")}c.on("data",function(a){d+=a.toString()}),c.on("end",function(){if(b.statusCode>=200&&b.statusCode<400)a.success(d,b);else if(d)a.error({responseText:d});else{var c=new Error("Response error.");c.statusCode=b.statusCode,a.error({responseText:c})}})});if(k.on("error",function(b){a.error({responseText:b})}),a.data){var l=j["content-encoding"];switch(l){case"gzip":var m=new c(a.data,"utf-8");g.gzip(m,function(a,b){k.end(b)});break;default:k.end(a.data)}}else k.end()}return a}()}).call(this,a("buffer").Buffer)},{buffer:"buffer",http:"http",https:"https",rsvp:1,underscore:1,url:"url",zlib:"zlib"}],63:[function(a,b){var c=a("../utils").buildPromise,d=a("../query/DataQuery"),e=a("../query/RequestOptionsBuilder"),f=a("../common").rsvp,g=a("../Request"),h=a("../constants").idField,i=(a("../Everlive"),a("../EverliveError").EverliveError),j=a("../EverliveError").EverliveErrors,k=a("../common")._;b.exports=function(){function a(a,b){return function(c,d){var e=c.result;k.isArray(a)||"number"==typeof a.length?k.each(a,function(a,b){k.extend(a,e[b])}):k.extend(a,e),b(c,d)}}function b(a,b){return function(c){var d=c.ModifiedAt;a.ModifiedAt=d,b(c)}}function l(a,b,c,d){this.setup=a,this.collectionName=b,this.options=null,this.offlineStorage=c,this.everlive=d}return l.prototype={_isOnline:function(){return this.offlineStorage?this.offlineStorage.isOnline():!0},_getOfflineCreateData:function(a,b){var c;if(k.isArray(a.data)){c=[];for(var d=0;d<a.data.length;d++){var e=k.extend(a.data[d],b.result[d]);c.push(e)}}else c=k.extend(a.data,b.result);return c},_applyOffline:function(a,b){var c=this.offlineStorage&&this.offlineStorage.setup.autoSync;if(c)switch(a.operation){case d.operations.read:case d.operations.readById:var e=new d(k.defaults({data:b.result,isSync:!0},a));return this.offlineStorage.create(e);case d.operations.create:var g=this._getOfflineCreateData(a,b),h=new d(k.defaults({data:g,isSync:!0},a));return this.offlineStorage.create(h);default:return a.isSync=!0,this.offlineStorage.processQuery(a)}return new f.Promise(function(a){a()})},_setOption:function(a,b){return this.options=this.options||{},this.options[a]=k.isObject(b)?k.extend({},this.options[a],b):b,this},useOffline:function(a){if(1!==arguments.length)throw new Error("A single value is expected in useOffline() query modifier");return this._setOption("useOffline",a)},isSync:function(a){if(1!==arguments.length)throw new Error("A single value is expected in isSync() query modifier");return this._setOption("isSync",a)},skipAuth:function(a){if(1!==arguments.length)throw new Error("A single value is expected in skipAuth() query modifier");return this._setOption("skipAuth",a)},applyOffline:function(a){if(1!==arguments.length)throw new Error("A single value is expected in applyOffline() query modifier");return this._setOption("applyOffline",a)},withHeaders:function(a){return this._setOption("headers",a)},expand:function(a){var b={"X-Everlive-Expand":JSON.stringify(a)};return this.withHeaders(b)},processDataQuery:function(a){var b=this,c=this.everlive._isOfflineStorageEnabled();if(a.useOffline=c?!this.everlive.isOnline():!1,a.applyOffline=c,this.options&&(a=k.defaults(this.options,a)),this.options=null,!a.skipAuth&&this.everlive.authentication&&this.everlive.authentication.isAuthenticationInProgress()&&(a.onError=k.wrap(a.onError,function(c,d){if(d.code===j.invalidToken.code||d.code===j.expiredToken.code){var e=b.everlive.authentication._ensureAuthentication();a.noRetry||e.then(function(){return b.processDataQuery(a)})}else c.call(b,d)}),b.everlive.authentication.isAuthenticating())){var d=b.everlive.authentication._ensureAuthentication();return a.noRetry||d.then(function(){return b.processDataQuery(a)}),d}if(!a.isSync&&this.offlineStorage&&this.offlineStorage.isSynchronizing())a.onError.call(this,j.syncInProgress);else if(a.useOffline){if(!a.applyOffline)return a.onError.call(this,new i("The applyOffline must be false when working offline."));b.offlineStorage.processQuery(a).then(function(){a.onSuccess.apply(this,arguments)},function(b){b.code||(b=new i(b.message,j.generalDatabaseError.code)),a.onError.call(this,b)})}else{var f=a.onSuccess;a.onSuccess=function(){var c=arguments,d=c[0];return a.applyOffline?b._applyOffline(a,d).then(function(){f.apply(this,c)},function(){a.onError.apply(this,arguments)}):f.apply(this,c)};var h=e[a.operation],l=h(a),m=new g(this.setup,l);m.send()}},get:function(a,b,e){var f=this;return c(function(b,c){var e=new d({operation:d.operations.read,collectionName:f.collectionName,filter:a,onSuccess:b,onError:c});return f.processDataQuery(e)},b,e)},getById:function(a,b,e){var f=this;return c(function(b,c){var e=new d({operation:d.operations.readById,collectionName:f.collectionName,parse:g.parsers.single,additionalOptions:{id:a},onSuccess:b,onError:c});return f.processDataQuery(e)},b,e)},count:function(a,b,e){var f=this;return c(function(b,c){var e=new d({operation:d.operations.count,collectionName:f.collectionName,filter:a,parse:g.parsers.single,onSuccess:b,onError:c});return f.processDataQuery(e)},b,e)},create:function(b,e,f){var h=this;return c(function(c,e){var f=new d({operation:d.operations.create,collectionName:h.collectionName,data:b,parse:g.parsers.single,onSuccess:a(b,c),onError:e});return h.processDataQuery(f)},e,f)},rawUpdate:function(a,b,e,f){var g=this;return c(function(c,e){var f=new d({operation:d.operations.rawUpdate,collectionName:g.collectionName,filter:b,data:a,onSuccess:c,onError:e});return g.processDataQuery(f)},e,f)},_update:function(a,e,f,i,j,k){var l=this;return c(function(c,j){var k={};k[i?"$replace":"$set"]=a;var m=f?b(a,c):c,n=new d({operation:d.operations.update,collectionName:l.collectionName,parse:g.parsers.update,filter:e,data:k,additionalOptions:{id:f?a[h]:void 0},onSuccess:m,onError:j});return l.processDataQuery(n)},j,k)},updateSingle:function(a,b,c){return this._update(a,null,!0,!1,b,c)},update:function(a,b,c,d){return this._update(a,b,!1,!1,c,d)},_destroy:function(a,b,e,f,g){var i=this;return c(function(c,f){var g=new d({operation:e?d.operations.removeSingle:d.operations.remove,collectionName:i.collectionName,filter:b,onSuccess:c,onError:f,additionalOptions:{id:e?a[h]:void 0}});return i.processDataQuery(g)},f,g)},destroySingle:function(a,b,c){return this._destroy(a,null,!0,b,c)},destroy:function(a,b,c){return this._destroy(null,a,!1,b,c)},setAcl:function(a,b,e,f){var h=this;return c(function(c,e){var f=new d({operation:d.operations.setAcl,collectionName:h.collectionName,parse:g.parsers.single,filter:b,additionalOptions:{acl:a},onSuccess:c,onError:e});return h.processDataQuery(f)},e,f)},setOwner:function(a,b,e,f){var g=this;return c(function(c,e){var f=new d({operation:d.operations.setOwner,collectionName:g.collectionName,filter:b,data:{Owner:a},onSuccess:c,onError:e});return g.processDataQuery(f)},e,f)},save:function(a,b,d){var e=this,f=this.isNew(a);return c(function(b,c){function d(a){a.type=f?"create":"update",b(a)}function g(a){a.type=f?"create":"update",c(a)}return f?e.create(a,d,g):e.updateSingle(a,d,g)},b,d)},isNew:function(a){return"undefined"==typeof a[h]}},l}()},{"../Everlive":35,"../EverliveError":36,"../Request":42,"../common":46,"../constants":47,"../query/DataQuery":56,"../query/RequestOptionsBuilder":59,"../utils":66}],64:[function(a,b){var c=a("../utils").buildPromise,d=a("../query/DataQuery"),e=a("../Request"),f=a("../utils");b.exports.addFilesFunctions=function(a){a.getUploadUrl=function(){return f.buildUrl(this.setup)+this.collectionName},a.getDownloadUrl=function(a){return f.buildUrl(this.setup)+this.collectionName+"/"+a+"/Download"},a._getUpdateUrl=function(a){return this.collectionName+"/"+a+"/Content"},a.getUpdateUrl=function(a){return f.buildUrl(this.setup)+this._getUpdateUrl(a)},a.updateContent=function(a,b,e,f){var g=this;return c(function(c,e){var f=new d({operation:d.operations.filesUpdateContent,data:b,collectionName:g.collectionName,additionalOptions:{id:a},onSuccess:c,onError:e});return g.processDataQuery(f)},e,f)},a.getDownloadUrlById=function(a,b,f){var g=this;return c(function(b,c){var f=new d({operation:d.operations.filesGetDownloadUrlById,collectionName:g.collectionName,additionalOptions:{id:a},parse:e.parsers.single,onSuccess:function(a){
b(a.result.Uri)},onError:c});return g.processDataQuery(f)},b,f)}}},{"../Request":42,"../query/DataQuery":56,"../utils":66}],65:[function(a,b){var c=a("../utils"),d=c.buildPromise,e=c.guardUnset,f=a("../query/DataQuery"),g=a("../Request"),h=a("../common")._,i=(a("../EverliveError").EverliveError,a("../EverliveError").EverliveErrors);b.exports.addUsersFunctions=function(a,b){a.register=function(a,b,c,d,f){e(a,"username"),e(b,"password");var g={Username:a,Password:b};return h.extend(g,c),this.create(g,d,f)},a.currentUser=function(a,b){var c=this,e=c.everlive._isOfflineStorageEnabled()&&c.everlive.isOffline()?c.everlive.setup.principalId:"me";return d(function(a,b){return("me"!==e||c.everlive.setup.token||c.everlive.setup.masterKey)&&e?void c.getById(e).then(function(b){a("undefined"!=typeof b.result?{result:b.result}:{result:null})},function(d){c.everlive.authentication&&c.everlive.authentication.isAuthenticationInProgress()?a({result:null}):601===d.code?a({result:null}):b(801===d.code?i.invalidToken:d)}):a({result:null})},a,b)},a.changePassword=function(b,c,e,g,i,j){var k=this;return d(function(d,i){d=h.wrap(d,function(b,c){return c&&c.result&&(g||a.clearAuthorization()),b(c)});var j=new f({operation:f.operations.userChangePassword,collectionName:k.collectionName,data:{Username:b,Password:c,NewPassword:e},additionalOptions:{keepTokens:g},skipAuth:!0,onSuccess:d,onError:i});return k.processDataQuery(j)},i,j)},a.login=function(a,c,d,e){return b.authentication.login(a,c,d,e)},a.logout=function(a,c){return b.authentication.logout(a,c)},a.loginWithFacebook=function(a,c,d){return b.authentication.loginWithFacebook(a,c,d)},a.linkWithFacebook=function(b,c,d,e){var f={Provider:"Facebook",Token:c};return a._linkWithProvider(f,b,d,e)},a.unlinkFromFacebook=function(b,c,d){return a._unlinkFromProvider("Facebook",b,c,d)},a.loginWithADFS=function(a,c,d){return b.authentication.loginWithADFS(a,c,d)},a.linkWithADFS=function(b,c,d,e){var f={Provider:"ADFS",Token:c};return a._linkWithProvider(f,b,d,e)},a.unlinkFromADFS=function(b,c,d){return a._unlinkFromProvider("ADFS",b,c,d)},a.loginWithLiveID=function(a,c,d){return b.authentication.loginWithLiveID(a,c,d)},a.linkWithLiveID=function(b,c,d,e){var f={Provider:"LiveID",Token:c};return a._linkWithProvider(f,b,d,e)},a.unlinkFromLiveID=function(b,c,d){return a._unlinkFromProvider("LiveID",b,c,d)},a.loginWithGoogle=function(a,c,d){return b.authentication.loginWithGoogle(a,c,d)},a.linkWithGoogle=function(b,c,d,e){var f={Provider:"Google",Token:c};return a._linkWithProvider(f,b,d,e)},a.unlinkFromGoogle=function(b,c,d){return a._unlinkFromProvider("Google",b,c,d)},a.loginWithTwitter=function(a,c,d,e){return b.authentication.loginWithTwitter(a,c,d,e)},a.linkWithTwitter=function(b,c,d,e,f){var g={Provider:"Twitter",Token:c,TokenSecret:d};return a._linkWithProvider(g,b,e,f)},a.unlinkFromTwitter=function(b,c,d){return a._unlinkFromProvider("Twitter",b,c,d)},a.setAuthorization=function(a,c,d){b.authentication.setAuthorization(a,c,d)},a.clearAuthorization=function(){b.authentication.setAuthorization(null,null,null)},a._linkWithProvider=function(a,b,c,e){var h=this;return d(function(c,d){var e=new f({additionalOptions:{id:b},operation:f.operations.userLinkWithProvider,collectionName:h.collectionName,data:a,parse:g.parsers.single,skipAuth:!0,onSuccess:c,onError:d});return h.processDataQuery(e)},c,e)},a._unlinkFromProvider=function(a,b,c,e){var h={Provider:a},i=this;return d(function(a,c){var d=new f({additionalOptions:{userId:b},operation:f.operations.userUnlinkFromProvider,collectionName:i.collectionName,data:h,parse:g.parsers.single,skipAuth:!0,onSuccess:a,onError:c});return i.processDataQuery(d)},c,e)}}},{"../EverliveError":36,"../Request":42,"../common":46,"../query/DataQuery":56,"../utils":66}],66:[function(a,b){var c=a("./EverliveError").EverliveError,d=a("./common"),e=d._,f=d.rsvp,g=(a("./Everlive"),a("./everlive.platform").isNodejs),h={};h.guardUnset=function(a,b,d){if(d||(d="The "+b+" is required"),"undefined"==typeof a||null===a)throw new c(d)},h.parseUtilities={getReviver:function(a){var b;return b=a?h.parseUtilities.parseIsoDateString:h.parseUtilities.parseOnlyCompleteDateTimeString,function(a,c){if("string"==typeof c){var d=b(c);d&&(c=d)}return c}},parseIsoDateString:function(a){var b;if(b=a.match(/^(\d{4})(-(\d{2})(-(\d{2})(T(\d{2}):(\d{2})(:(\d{2})(\.(\d+))?)?(Z|((\+|-)(\d{2}):(\d{2}))))?))$/)){var c=b[12];c&&(c.length>3?c=Math.round(Number(c.substr(0,3)+"."+c.substr(3))):c.length<3&&(c+=2===c.length?"0":"00"));var d=new Date(Date.UTC(Number(b[1]),Number(b[3])-1||0,Number(b[5])||0,Number(b[7])||0,Number(b[8])||0,Number(b[10])||0,Number(c)||0));if(b[13]&&"Z"!==b[13]){var e=Number(b[16])||0,f=Number(b[17])||0;e*=36e5,f*=6e4;var g=e+f;"+"===b[15]&&(g=-g),d=new Date(d.valueOf()+g)}return d}return null},parseOnlyCompleteDateTimeString:function(a){return/^\d{4}-\d{2}-\d{2}$/.test(a)?null:/^(\d{2}):(\d{2})(:(\d{2})(\.(\d+))?)?(Z|((\+|-)(\d{2}):(\d{2})))?$/.test(a)?null:h.parseUtilities.parseIsoDateString(a)},traverse:function(a,b){var c,d,e;for(c in a)a.hasOwnProperty(c)&&(d=a[c],e=b(c,d),a[c]=e,d===e&&"object"==typeof d&&h.parseUtilities.traverse(d,b));return a},traverseAndRevive:function(a,b){return b||(b=h.parseUtilities.getReviver()),h.parseUtilities.traverse(a,b)},parseError:function(a,b){if(!("string"==typeof b&&b.length>0))return b;try{return b=JSON.parse(b),{message:b.message,code:b.errorCode}}catch(c){return b}},_parseInternal:function(a,b){return"string"==typeof b&&b.length>0?b=JSON.parse(b,a):"object"==typeof b&&h.parseUtilities.traverseAndRevive(b,a),b},_transformResult:function(a,b){if(a){var c={result:a.Result};return e.extend(c,b),c}return a},parseResult:function(a,b){return b=h.parseUtilities._parseInternal.apply(null,arguments),h.parseUtilities._transformResult(b,{count:b.Count})},parseSingleResult:function(a,b){return b=h.parseUtilities._parseInternal.apply(null,arguments),h.parseUtilities._transformResult(b)},parseUpdateResult:function(a,b){return b=h.parseUtilities._parseInternal.apply(null,arguments),h.parseUtilities._transformResult(b,{ModifiedAt:b.ModifiedAt})}},h.buildPromise=function(a,b,c){var d=h.getCallbacks(b,c);return a(d.success,d.error),d.promise},h.getCallbacks=function(a,b){var c,d=function(){return new f.Promise(function(c,d){a=function(a){c(a)},b=function(a){d(a)}})};if(g)if("function"==typeof a&&"function"!=typeof b){var e=a;a=function(a,b){e(null,a,b)},b=function(a){e(a)}}else"function"!=typeof a&&"function"!=typeof b&&(c=d());else"function"!=typeof a&&"function"!=typeof b&&(c=d());return{promise:c,success:a,error:b}},h.buildAuthHeader=function(a,b){var c=null;return b&&b.authHeaders===!1?c:(a.token?c=(a.tokenType||"bearer")+" "+a.token:a.masterKey&&(c="masterkey "+a.masterKey),c?{Authorization:c}:null)},h.DeviceRegistrationResult=function(a){this.token=a},h.cloneDate=function(a){return new Date(a)},h.buildUrl=function(a){var b="";return"string"==typeof a.scheme&&(b+=a.scheme+":"),b+=a.url,a.apiKey&&(b+=a.apiKey+"/"),b},h.getDbOperators=function(a,b){var c=[];if("string"==typeof a)return c;var d=Object.keys(a);return e.each(d,function(d){0===d.indexOf("$")?c.push(d):"object"!=typeof a[d]||b||(c=c.concat(h.getDbOperators(a[d])))}),c};var i=["$geoWithin","$geoIntersects","$near","$within","$nearSphere"];h.getUnsupportedOperators=function(a){var b=h.getDbOperators(a);return e.intersection(b,i)},b.exports=h},{"./Everlive":35,"./EverliveError":36,"./common":46,"./everlive.platform":49}]},{},[50]),"object"==typeof module&&"object"==typeof exports&&(module.exports=Everlive);